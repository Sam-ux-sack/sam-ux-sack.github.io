<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS GYM Analytics Dashboard</title>
    
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'gym-blue': '#3b82f6',
                        'gym-green': '#10b981',
                        'gym-purple': '#8b5cf6',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; height: 400px; }
        .chart-container-small { position: relative; height: 300px; }
        
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .drag-over {
            background-color: #dbeafe !important;
            border: 2px dashed #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        üèãÔ∏è SAMS GYM Analytics
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Analyse-Zeitraum: <span id="period-display" class="font-medium">-</span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button id="export-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition">
                        üíæ Export
                    </button>
                    <button id="save-github-btn" class="hidden bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow transition">
                        ‚òÅÔ∏è Auf GitHub speichern
                    </button>
                </div>
            </div>
        </header>

        <!-- Upload Section -->
        <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">üìÅ Daten hochladen</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Zoho Contacts Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition cursor-pointer" id="contacts-drop-zone">
                    <input type="file" id="contacts-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="font-semibold mb-1">Zoho Kontakte (AllContacts.csv)</p>
                        <p class="text-sm text-gray-500">Klicken oder Drag & Drop</p>
                        <p id="contacts-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>

                <!-- SALTO Events Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-500 transition cursor-pointer" id="events-drop-zone">
                    <input type="file" id="events-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="font-semibold mb-1">SALTO Ereignisse (Ereignisliste.csv)</p>
                        <p class="text-sm text-gray-500">Klicken oder Drag & Drop</p>
                        <p id="events-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>
            </div>

            <button id="analyze-btn" class="hidden w-full mt-6 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                üöÄ Daten analysieren
            </button>

            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Daten werden analysiert...</p>
            </div>
        </div>

        <!-- Results Section (hidden by default) -->
        <div id="results-section" class="hidden">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Gesamt Check-ins</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-total-checkins">0</p>
                            <p class="text-xs text-green-600 mt-1" id="stat-checkins-trend">-</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Aktive Mitglieder</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-active-members">0</p>
                            <p class="text-xs text-gray-500 mt-1">Unique CUS-Nummern</p>
                        </div>
                        <div class="text-4xl">üë•</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Durchschn. Check-ins/Tag</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-avg-daily">0</p>
                            <p class="text-xs text-gray-500 mt-1">√ò pro Tag</p>
                        </div>
                        <div class="text-4xl">üìÖ</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Beliebtestes Studio</p>
                            <p class="text-xl font-bold text-gray-900" id="stat-top-studio">-</p>
                            <p class="text-xs text-gray-500 mt-1" id="stat-top-studio-percent">-</p>
                        </div>
                        <div class="text-4xl">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="flex">
                        <button class="tab-button active px-6 py-4 font-semibold" data-tab="overview">
                            üìä √úbersicht
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="demographics">
                            üë• Demographics
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="trends">
                            üìà Trends
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="insights">
                            üí° Insights
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active">
                        <h3 class="text-xl font-bold mb-4">Studio-Auslastung</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-studios"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">T√§gliche Auslastung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-daily"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Peak Hours Heatmap</h4>
                            <div class="chart-container">
                                <canvas id="chart-heatmap"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Tab -->
                    <div id="tab-demographics" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Mitglieder-Demographics</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio Filter:</label>
                            <select id="demo-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Geschlechterverteilung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Altersgruppen</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-age"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Studio-Vergleich</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Studio</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Check-ins</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">M√§nner</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Frauen</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">√ò Alter</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studio-comparison-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Trends Tab -->
                    <div id="tab-trends" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Trend-Analyse √ºber Zeit</h3>
                        
                        <div id="trends-no-data" class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 text-center">
                            <p class="text-lg font-semibold text-blue-900 mb-2">üìä Historische Daten werden geladen...</p>
                            <p class="text-sm text-blue-700 mb-4">Speichere diese Analyse auf GitHub, um Trends √ºber Zeit zu verfolgen.</p>
                            <button id="load-history-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow transition">
                                üìÇ Historische Daten laden
                            </button>
                        </div>

                        <div id="trends-content" class="hidden">
                            <!-- Studio Trends Over Time -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio (Zeitverlauf)</h4>
                                <div class="chart-container">
                                    <canvas id="chart-studio-trends"></canvas>
                                </div>
                            </div>

                            <!-- Gender Trends -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="font-semibold mb-3">Geschlechter-Entwicklung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-gender-trends"></canvas>
                                </div>
                            </div>

                            <!-- Age Group Trends -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="font-semibold mb-3">Altersgruppen-Entwicklung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-age-trends"></canvas>
                                </div>
                            </div>

                            <!-- Trend Alerts -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">‚ö†Ô∏è Erkannte Trends & R√ºckg√§nge</h4>
                                <div id="trend-alerts-container" class="space-y-3">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div id="tab-insights" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Actionable Insights & Empfehlungen</h3>
                        <div id="insights-container" class="space-y-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GITHUB CONFIGURATION ====================
        const GITHUB_CONFIG = {
            owner: 'sam-ux-sack',  // Dein GitHub Username
            repo: 'sams-gym-data',  // Neues Repo f√ºr Daten
            token: null  // Wird vom User eingegeben
        };

        // ==================== DATA STORAGE ====================
        let contactsData = null;
        let eventsData = null;
        let analysisResults = null;
        let historicalData = [];  // Array of past analyses
        let charts = {};

        // ==================== STUDIO MAPPING ====================
        const STUDIO_MAPPING = {
            'Susten Hauptt√ºre': 'Susten GYM',
            'Susten GYM': 'Susten GYM',
            'Strongman rechts': 'Susten CrossGYM',
            'Visp-S√ºd Eingang': 'Visp-S√ºd',
            'Visp-Center Eingang': 'Visp-Center'
        };

        // ==================== FILE UPLOAD HANDLERS ====================
        function setupFileHandlers() {
            // Contacts file
            const contactsZone = document.getElementById('contacts-drop-zone');
            const contactsInput = document.getElementById('contacts-input');
            
            contactsZone.addEventListener('click', () => contactsInput.click());
            contactsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'contacts'));
            
            contactsZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                contactsZone.classList.add('drag-over');
            });
            contactsZone.addEventListener('dragleave', () => contactsZone.classList.remove('drag-over'));
            contactsZone.addEventListener('drop', (e) => {
                e.preventDefault();
                contactsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'contacts');
            });

            // Events file
            const eventsZone = document.getElementById('events-drop-zone');
            const eventsInput = document.getElementById('events-input');
            
            eventsZone.addEventListener('click', () => eventsInput.click());
            eventsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'events'));
            
            eventsZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                eventsZone.classList.add('drag-over');
            });
            eventsZone.addEventListener('dragleave', () => eventsZone.classList.remove('drag-over'));
            eventsZone.addEventListener('drop', (e) => {
                e.preventDefault();
                eventsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'events');
            });

            // Analyze button
            document.getElementById('analyze-btn').addEventListener('click', analyzeData);
        }

        function handleFileSelect(file, type) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Bitte eine CSV-Datei ausw√§hlen!');
                return;
            }

            const statusEl = document.getElementById(`${type}-status`);
            statusEl.textContent = `‚úì ${file.name}`;
            statusEl.classList.add('text-green-600');

            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    if (type === 'contacts') {
                        contactsData = results.data;
                        console.log('Contacts loaded:', contactsData.length);
                    } else {
                        eventsData = results.data;
                        console.log('Events loaded:', eventsData.length);
                    }
                    
                    // Show analyze button if both files loaded
                    if (contactsData && eventsData) {
                        document.getElementById('analyze-btn').classList.remove('hidden');
                    }
                }
            });
        }

        // ==================== DATA ANALYSIS ====================
        function analyzeData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('analyze-btn').classList.add('hidden');

            setTimeout(() => {
                // Build contacts lookup
                const contactsLookup = {};
                contactsData.forEach(contact => {
                    const cusNumber = contact['Kundennummer'] || contact['CUSTOMER_ID'];
                    if (cusNumber) {
                        contactsLookup[cusNumber] = {
                            name: contact['Name'] || '',
                            birthdate: contact['Geburtsdatum'] || '',
                            gender: extractGender(contact['Name'] || ''),
                            age: calculateAge(contact['Geburtsdatum'] || '')
                        };
                    }
                });

                // Process events
                const checkins = [];
                const studioStats = {};
                const dailyStats = {};
                const hourlyStats = {};
                const cusSet = new Set();

                eventsData.forEach(event => {
                    // Parse SALTO event (no header, columns: timestamp, event, door, , cusNumber)
                    const cols = Object.values(event);
                    if (cols.length < 5) return;

                    const timestamp = cols[0];
                    const doorName = cols[2];
                    const cusNumber = cols[4];

                    if (!timestamp || !cusNumber || !cusNumber.startsWith('CUS-')) return;

                    const studio = STUDIO_MAPPING[doorName] || doorName;
                    const contact = contactsLookup[cusNumber] || {};

                    const date = new Date(timestamp);
                    if (isNaN(date)) return;

                    const dateKey = date.toISOString().split('T')[0];
                    const hour = date.getHours();
                    const day = date.getDay();

                    checkins.push({
                        timestamp: date,
                        studio,
                        cusNumber,
                        gender: contact.gender || 'Unknown',
                        age: contact.age || null,
                        dateKey,
                        hour,
                        day
                    });

                    // Stats
                    studioStats[studio] = (studioStats[studio] || 0) + 1;
                    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
                    
                    const hourKey = `${day}-${hour}`;
                    hourlyStats[hourKey] = (hourlyStats[hourKey] || 0) + 1;
                    
                    cusSet.add(cusNumber);
                });

                // Sort by date
                checkins.sort((a, b) => a.timestamp - b.timestamp);

                // Calculate period
                const startDate = checkins[0]?.timestamp;
                const endDate = checkins[checkins.length - 1]?.timestamp;

                analysisResults = {
                    checkins,
                    studioStats,
                    dailyStats,
                    hourlyStats,
                    uniqueMembers: cusSet.size,
                    contactsLookup,
                    startDate,
                    endDate
                };

                renderResults();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('export-btn').classList.remove('hidden');
                document.getElementById('save-github-btn').classList.remove('hidden');
                document.getElementById('upload-section').classList.add('hidden');
            }, 500);
        }

        // ==================== HELPER FUNCTIONS ====================
        function extractGender(name) {
            if (name.startsWith('Herr')) return 'M√§nnlich';
            if (name.startsWith('Frau')) return 'Weiblich';
            return 'Unknown';
        }

        function calculateAge(birthdate) {
            if (!birthdate) return null;
            const birth = new Date(birthdate);
            if (isNaN(birth)) return null;
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // ==================== RENDER RESULTS ====================
        function renderResults() {
            const { checkins, studioStats, dailyStats, hourlyStats, uniqueMembers, startDate, endDate } = analysisResults;

            // Period display
            document.getElementById('period-display').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

            // Summary stats
            document.getElementById('stat-total-checkins').textContent = checkins.length.toLocaleString('de-DE');
            document.getElementById('stat-active-members').textContent = uniqueMembers.toLocaleString('de-DE');
            
            const daysCount = Object.keys(dailyStats).length;
            const avgDaily = Math.round(checkins.length / daysCount);
            document.getElementById('stat-avg-daily').textContent = avgDaily.toLocaleString('de-DE');

            const topStudio = Object.entries(studioStats).sort((a, b) => b[1] - a[1])[0];
            if (topStudio) {
                document.getElementById('stat-top-studio').textContent = topStudio[0];
                const percent = ((topStudio[1] / checkins.length) * 100).toFixed(0);
                document.getElementById('stat-top-studio-percent').textContent = `${percent}% der Check-ins`;
            }

            // Render charts
            renderStudioChart();
            renderDailyChart();
            renderHeatmap();
            renderDemographicsCharts();
            renderStudioComparisonTable();
            renderInsights();
        }

        // ==================== CHARTS ====================
        function renderStudioChart() {
            const { studioStats } = analysisResults;
            const ctx = document.getElementById('chart-studios');
            
            if (charts.studios) charts.studios.destroy();
            
            const sorted = Object.entries(studioStats).sort((a, b) => b[1] - a[1]);
            
            charts.studios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Check-ins',
                        data: sorted.map(s => s[1]),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value.toLocaleString('de-DE')
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDailyChart() {
            const { dailyStats } = analysisResults;
            const ctx = document.getElementById('chart-daily');
            
            if (charts.daily) charts.daily.destroy();
            
            const sorted = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0]));
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d[0]);
                        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Check-ins pro Tag',
                        data: sorted.map(d => d[1]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderHeatmap() {
            const { hourlyStats } = analysisResults;
            const ctx = document.getElementById('chart-heatmap');
            
            if (charts.heatmap) charts.heatmap.destroy();

            // Create matrix: hours (0-23) x days (0-6)
            const matrix = [];
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            for (let hour = 0; hour < 24; hour++) {
                const row = { hour };
                for (let day = 0; day < 7; day++) {
                    const key = `${day}-${hour}`;
                    row[days[day]] = hourlyStats[key] || 0;
                }
                matrix.push(row);
            }

            // Prepare data for Chart.js (simplified bubble chart)
            const bubbleData = [];
            matrix.forEach((row, hourIdx) => {
                days.forEach((day, dayIdx) => {
                    const value = row[day];
                    if (value > 0) {
                        bubbleData.push({
                            x: dayIdx,
                            y: hourIdx,
                            r: Math.sqrt(value) * 2
                        });
                    }
                });
            });

            charts.heatmap = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Check-ins',
                        data: bubbleData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            min: -0.5,
                            max: 6.5,
                            ticks: {
                                stepSize: 1,
                                callback: (value) => days[Math.round(value)]
                            }
                        },
                        y: {
                            type: 'linear',
                            min: -0.5,
                            max: 23.5,
                            ticks: {
                                stepSize: 2,
                                callback: (value) => `${Math.round(value)}:00`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const hour = Math.round(context.parsed.y);
                                    const day = days[Math.round(context.parsed.x)];
                                    return `${day} ${hour}:00 - Check-ins: ${Math.round(context.raw.r / 2) ** 2}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDemographicsCharts() {
            const { checkins } = analysisResults;
            
            // Gender distribution
            const genderCounts = { 'M√§nnlich': 0, 'Weiblich': 0, 'Unknown': 0 };
            checkins.forEach(c => genderCounts[c.gender]++);
            
            const genderCtx = document.getElementById('chart-gender');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['M√§nner', 'Frauen'],
                    datasets: [{
                        data: [genderCounts['M√§nnlich'], genderCounts['Weiblich']],
                        backgroundColor: ['#3b82f6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((value / sum) * 100).toFixed(0);
                                return `${percent}%`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 16 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Age distribution
            const ageCounts = { '<20': 0, '20-30': 0, '30-40': 0, '40+': 0 };
            checkins.forEach(c => {
                if (c.age === null) return;
                if (c.age < 20) ageCounts['<20']++;
                else if (c.age < 30) ageCounts['20-30']++;
                else if (c.age < 40) ageCounts['30-40']++;
                else ageCounts['40+']++;
            });

            const ageCtx = document.getElementById('chart-age');
            if (charts.age) charts.age.destroy();
            
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageCounts),
                    datasets: [{
                        label: 'Check-ins',
                        data: Object.values(ageCounts),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Populate studio filter
            const { studioStats } = analysisResults;
            const filterSelect = document.getElementById('demo-studio-filter');
            filterSelect.innerHTML = '<option value="all">Alle Studios</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });
        }

        function renderStudioComparisonTable() {
            const { checkins, studioStats } = analysisResults;
            const tbody = document.getElementById('studio-comparison-table');
            tbody.innerHTML = '';

            const studios = Object.keys(studioStats);
            
            studios.forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                const total = males + females;
                
                const ages = studioCheckins.map(c => c.age).filter(a => a !== null);
                const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${studio}</td>
                    <td class="px-4 py-3">${studioStats[studio].toLocaleString('de-DE')}</td>
                    <td class="px-4 py-3">${((males / total) * 100).toFixed(0)}%</td>
                    <td class="px-4 py-3">${((females / total) * 100).toFixed(0)}%</td>
                    <td class="px-4 py-3">${avgAge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderInsights() {
            const { checkins, studioStats } = analysisResults;
            const container = document.getElementById('insights-container');
            container.innerHTML = '';

            const insights = [];

            // Calculate average gender distribution across all studios
            const totalMales = checkins.filter(c => c.gender === 'M√§nnlich').length;
            const totalFemales = checkins.filter(c => c.gender === 'Weiblich').length;
            const avgFemalePercent = (totalFemales / (totalMales + totalFemales)) * 100;

            // Check each studio for gender imbalance
            Object.keys(studioStats).forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                const femalePercent = (females / (males + females)) * 100;

                if (Math.abs(femalePercent - avgFemalePercent) > 8) {
                    const diff = femalePercent - avgFemalePercent;
                    insights.push({
                        type: diff < 0 ? 'warning' : 'info',
                        icon: 'üë•',
                        title: `${studio}: ${diff < 0 ? 'Wenig' : 'Viele'} Frauen`,
                        description: `${femalePercent.toFixed(0)}% Frauen (Durchschnitt: ${avgFemalePercent.toFixed(0)}%)`,
                        action: diff < 0 ? 'Gezielte Marketing-Kampagne f√ºr Frauen empfohlen' : 'Gute Geschlechterbalance beibehalten'
                    });
                }
            });

            // Peak hours analysis
            const { hourlyStats } = analysisResults;
            const hourTotals = {};
            Object.entries(hourlyStats).forEach(([key, count]) => {
                const hour = key.split('-')[1];
                hourTotals[hour] = (hourTotals[hour] || 0) + count;
            });
            const peakHour = Object.entries(hourTotals).sort((a, b) => b[1] - a[1])[0];
            if (peakHour) {
                insights.push({
                    type: 'success',
                    icon: '‚è∞',
                    title: `Peak Hour: ${peakHour[0]}:00 Uhr`,
                    description: `${peakHour[1]} Check-ins w√§hrend dieser Stunde`,
                    action: 'Personal-Planung entsprechend anpassen'
                });
            }

            // Age trends
            const youngCheckins = checkins.filter(c => c.age && c.age < 20).length;
            const youngPercent = (youngCheckins / checkins.length) * 100;
            if (youngPercent > 15) {
                insights.push({
                    type: 'info',
                    icon: 'üìà',
                    title: 'Hoher Anteil junger Mitglieder',
                    description: `${youngPercent.toFixed(0)}% der Check-ins von unter 20-J√§hrigen`,
                    action: 'Jugend-Angebote und Social Media Marketing verst√§rken'
                });
            }

            // Render insights
            const typeStyles = {
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-blue-50 border-blue-200',
                success: 'bg-green-50 border-green-200'
            };

            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-2 ${typeStyles[insight.type]}`;
                div.innerHTML = `
                    <div class="flex items-start">
                        <div class="text-3xl mr-4">${insight.icon}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1">${insight.title}</h4>
                            <p class="text-sm text-gray-700 mb-2">${insight.description}</p>
                            <p class="text-xs text-gray-600">üìç <strong>Empfehlung:</strong> ${insight.action}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine besonderen Auff√§lligkeiten gefunden. Alle Metriken im normalen Bereich! ‚úÖ</p>';
            }
        }

        // ==================== TAB SWITCHING ====================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    // Update buttons
                    tabButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Update content
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                });
            });
        }

        // ==================== GITHUB INTEGRATION ====================
        async function saveToGitHub() {
            if (!GITHUB_CONFIG.token) {
                const token = prompt('Bitte gib deinen GitHub Personal Access Token ein:\n\n1. Gehe zu github.com/settings/tokens\n2. Erstelle einen neuen Token mit "repo" Berechtigung\n3. Kopiere den Token hier:');
                if (!token) return;
                GITHUB_CONFIG.token = token;
                localStorage.setItem('github_token', token);
            }

            const weekNumber = getWeekNumber(analysisResults.startDate);
            const year = analysisResults.startDate.getFullYear();
            const fileName = `${year}-W${weekNumber.toString().padStart(2, '0')}.json`;
            
            const dataToSave = {
                timestamp: new Date().toISOString(),
                period: {
                    start: analysisResults.startDate.toISOString(),
                    end: analysisResults.endDate.toISOString(),
                    week: weekNumber,
                    year: year
                },
                summary: {
                    totalCheckins: analysisResults.checkins.length,
                    uniqueMembers: analysisResults.uniqueMembers,
                    studios: analysisResults.studioStats,
                    avgDaily: Math.round(analysisResults.checkins.length / Object.keys(analysisResults.dailyStats).length)
                },
                demographics: calculateDemographics(analysisResults.checkins),
                studioBreakdown: calculateStudioBreakdown(analysisResults.checkins)
            };

            try {
                document.getElementById('save-github-btn').textContent = '‚è≥ Speichern...';
                document.getElementById('save-github-btn').disabled = true;

                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data/${fileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Update analytics for week ${weekNumber}, ${year}`,
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave, null, 2)))),
                        sha: await getFileSha(fileName)
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Daten erfolgreich auf GitHub gespeichert!\n\nDu kannst jetzt im Trends-Tab die historische Entwicklung sehen.');
                    document.getElementById('save-github-btn').textContent = '‚úÖ Gespeichert';
                    setTimeout(() => {
                        document.getElementById('save-github-btn').textContent = '‚òÅÔ∏è Auf GitHub speichern';
                        document.getElementById('save-github-btn').disabled = false;
                    }, 2000);
                } else {
                    throw new Error('GitHub API Fehler');
                }
            } catch (error) {
                console.error('GitHub save error:', error);
                alert('‚ùå Fehler beim Speichern auf GitHub.\n\nBitte pr√ºfe:\n- GitHub Token korrekt?\n- Repository existiert?\n- Berechtigung vorhanden?');
                document.getElementById('save-github-btn').textContent = '‚òÅÔ∏è Auf GitHub speichern';
                document.getElementById('save-github-btn').disabled = false;
            }
        }

        async function getFileSha(fileName) {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data/${fileName}`, {
                    headers: { 'Authorization': `Bearer ${GITHUB_CONFIG.token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    return data.sha;
                }
            } catch (e) {
                // File doesn't exist yet
            }
            return null;
        }

        async function loadHistoricalData() {
            if (!GITHUB_CONFIG.token) {
                const token = localStorage.getItem('github_token');
                if (token) {
                    GITHUB_CONFIG.token = token;
                } else {
                    alert('Bitte speichere zuerst eine Analyse auf GitHub, um historische Daten zu laden.');
                    return;
                }
            }

            try {
                document.getElementById('load-history-btn').textContent = '‚è≥ Laden...';
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data`, {
                    headers: { 'Authorization': `Bearer ${GITHUB_CONFIG.token}` }
                });

                if (!response.ok) {
                    throw new Error('Keine historischen Daten gefunden');
                }

                const files = await response.json();
                historicalData = [];

                for (const file of files) {
                    if (file.name.endsWith('.json')) {
                        const fileResponse = await fetch(file.download_url);
                        const data = await fileResponse.json();
                        historicalData.push(data);
                    }
                }

                // Sort by date
                historicalData.sort((a, b) => new Date(a.period.start) - new Date(b.period.start));

                // Add current analysis if not already saved
                const currentWeek = getWeekNumber(analysisResults.startDate);
                const currentYear = analysisResults.startDate.getFullYear();
                const alreadySaved = historicalData.some(d => d.period.week === currentWeek && d.period.year === currentYear);
                
                if (!alreadySaved && analysisResults) {
                    historicalData.push({
                        timestamp: new Date().toISOString(),
                        period: {
                            start: analysisResults.startDate.toISOString(),
                            end: analysisResults.endDate.toISOString(),
                            week: currentWeek,
                            year: currentYear
                        },
                        summary: {
                            totalCheckins: analysisResults.checkins.length,
                            uniqueMembers: analysisResults.uniqueMembers,
                            studios: analysisResults.studioStats
                        },
                        demographics: calculateDemographics(analysisResults.checkins),
                        studioBreakdown: calculateStudioBreakdown(analysisResults.checkins)
                    });
                }

                document.getElementById('trends-no-data').classList.add('hidden');
                document.getElementById('trends-content').classList.remove('hidden');
                
                renderTrendCharts();
                analyzeTrends();

            } catch (error) {
                console.error('Load history error:', error);
                alert('‚ùå Keine historischen Daten gefunden.\n\nSpeichere zuerst ein paar Wochen-Analysen auf GitHub, um Trends zu sehen.');
                document.getElementById('load-history-btn').textContent = 'üìÇ Historische Daten laden';
            }
        }

        // ==================== TREND CALCULATIONS ====================
        function calculateDemographics(checkins) {
            const males = checkins.filter(c => c.gender === 'M√§nnlich').length;
            const females = checkins.filter(c => c.gender === 'Weiblich').length;
            
            const ageGroups = { '<20': 0, '20-30': 0, '30-40': 0, '40+': 0 };
            checkins.forEach(c => {
                if (c.age === null) return;
                if (c.age < 20) ageGroups['<20']++;
                else if (c.age < 30) ageGroups['20-30']++;
                else if (c.age < 40) ageGroups['30-40']++;
                else ageGroups['40+']++;
            });

            return {
                gender: {
                    male: males,
                    female: females,
                    malePercent: (males / (males + females)) * 100,
                    femalePercent: (females / (males + females)) * 100
                },
                age: ageGroups
            };
        }

        function calculateStudioBreakdown(checkins) {
            const studios = {};
            const studioSet = new Set(checkins.map(c => c.studio));

            studioSet.forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                
                const ageGroups = { '<20': 0, '20-30': 0, '30-40': 0, '40+': 0 };
                studioCheckins.forEach(c => {
                    if (c.age === null) return;
                    if (c.age < 20) ageGroups['<20']++;
                    else if (c.age < 30) ageGroups['20-30']++;
                    else if (c.age < 40) ageGroups['30-40']++;
                    else ageGroups['40+']++;
                });

                studios[studio] = {
                    checkins: studioCheckins.length,
                    gender: { male: males, female: females },
                    age: ageGroups
                };
            });

            return studios;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // ==================== TREND VISUALIZATION ====================
        function renderTrendCharts() {
            if (historicalData.length < 2) {
                alert('Mindestens 2 Zeitr√§ume n√∂tig f√ºr Trend-Analyse.');
                return;
            }

            renderStudioTrends();
            renderGenderTrends();
            renderAgeTrends();
        }

        function renderStudioTrends() {
            const ctx = document.getElementById('chart-studio-trends');
            if (charts.studioTrends) charts.studioTrends.destroy();

            const labels = historicalData.map(d => `W${d.period.week} ${d.period.year}`);
            const allStudios = new Set();
            historicalData.forEach(d => Object.keys(d.summary.studios).forEach(s => allStudios.add(s)));

            const datasets = Array.from(allStudios).map((studio, idx) => {
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
                return {
                    label: studio,
                    data: historicalData.map(d => d.summary.studios[studio] || 0),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length] + '20',
                    fill: false,
                    tension: 0.4
                };
            });

            charts.studioTrends = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Check-ins' } }
                    }
                }
            });
        }

        function renderGenderTrends() {
            const ctx = document.getElementById('chart-gender-trends');
            if (charts.genderTrends) charts.genderTrends.destroy();

            const labels = historicalData.map(d => `W${d.period.week} ${d.period.year}`);

            charts.genderTrends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'M√§nner %',
                            data: historicalData.map(d => d.demographics.gender.malePercent),
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f620',
                            fill: false
                        },
                        {
                            label: 'Frauen %',
                            data: historicalData.map(d => d.demographics.gender.femalePercent),
                            borderColor: '#ec4899',
                            backgroundColor: '#ec489920',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: 0, max: 100, title: { display: true, text: 'Prozent' } }
                    }
                }
            });
        }

        function renderAgeTrends() {
            const ctx = document.getElementById('chart-age-trends');
            if (charts.ageTrends) charts.ageTrends.destroy();

            const labels = historicalData.map(d => `W${d.period.week} ${d.period.year}`);
            const ageGroups = ['<20', '20-30', '30-40', '40+'];
            const colors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];

            const datasets = ageGroups.map((group, idx) => ({
                label: group,
                data: historicalData.map(d => d.demographics.age[group] || 0),
                borderColor: colors[idx],
                backgroundColor: colors[idx] + '20',
                fill: false
            }));

            charts.ageTrends = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Check-ins' } }
                    }
                }
            });
        }

        function analyzeTrends() {
            if (historicalData.length < 3) return;

            const container = document.getElementById('trend-alerts-container');
            container.innerHTML = '';

            const alerts = [];
            const current = historicalData[historicalData.length - 1];
            const previous = historicalData[historicalData.length - 2];
            const older = historicalData[historicalData.length - 3];

            // Check studio trends
            Object.keys(current.summary.studios).forEach(studio => {
                const currentVal = current.summary.studios[studio] || 0;
                const prevVal = previous.summary.studios[studio] || 0;
                const olderVal = older.summary.studios[studio] || 0;

                // Consistent decline
                if (currentVal < prevVal && prevVal < olderVal) {
                    const decline = ((olderVal - currentVal) / olderVal * 100).toFixed(0);
                    alerts.push({
                        type: 'warning',
                        icon: 'üìâ',
                        title: `${studio}: R√ºckgang bei Check-ins`,
                        description: `-${decline}% √ºber die letzten 3 Wochen (${olderVal} ‚Üí ${currentVal})`,
                        action: 'Ursachenanalyse empfohlen'
                    });
                }
            });

            // Check gender trends per studio
            Object.keys(current.studioBreakdown).forEach(studio => {
                const currentFemale = current.studioBreakdown[studio].gender.female;
                const prevFemale = previous.studioBreakdown[studio]?.gender.female || 0;
                
                if (currentFemale < prevFemale * 0.85) {
                    const decline = ((prevFemale - currentFemale) / prevFemale * 100).toFixed(0);
                    alerts.push({
                        type: 'warning',
                        icon: 'üë©',
                        title: `${studio}: R√ºckgang bei Frauen`,
                        description: `-${decline}% weibliche Check-ins vs. Vorwoche`,
                        action: 'Frauen-spezifisches Marketing verst√§rken'
                    });
                }

                const currentMale = current.studioBreakdown[studio].gender.male;
                const prevMale = previous.studioBreakdown[studio]?.gender.male || 0;
                
                if (currentMale < prevMale * 0.85) {
                    const decline = ((prevMale - currentMale) / prevMale * 100).toFixed(0);
                    alerts.push({
                        type: 'warning',
                        icon: 'üë®',
                        title: `${studio}: R√ºckgang bei M√§nnern`,
                        description: `-${decline}% m√§nnliche Check-ins vs. Vorwoche`,
                        action: 'M√§nner-spezifisches Marketing verst√§rken'
                    });
                }
            });

            // Check age group trends
            const ageGroups = ['<20', '20-30', '30-40', '40+'];
            ageGroups.forEach(group => {
                const currentVal = current.demographics.age[group] || 0;
                const prevVal = previous.demographics.age[group] || 0;
                
                if (currentVal < prevVal * 0.80) {
                    const decline = ((prevVal - currentVal) / prevVal * 100).toFixed(0);
                    alerts.push({
                        type: 'info',
                        icon: 'üìä',
                        title: `Altersgruppe ${group}: R√ºckgang`,
                        description: `-${decline}% Check-ins vs. Vorwoche`,
                        action: 'Zielgruppen-spezifische Angebote pr√ºfen'
                    });
                }
            });

            // Render alerts
            const typeStyles = {
                warning: 'bg-red-50 border-red-200',
                info: 'bg-blue-50 border-blue-200'
            };

            if (alerts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">‚úÖ Keine signifikanten R√ºckg√§nge erkannt</p>';
            } else {
                alerts.forEach(alert => {
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-lg border-2 ${typeStyles[alert.type]}`;
                    div.innerHTML = `
                        <div class="flex items-start">
                            <div class="text-2xl mr-3">${alert.icon}</div>
                            <div class="flex-1">
                                <h5 class="font-bold mb-1">${alert.title}</h5>
                                <p class="text-sm text-gray-700 mb-1">${alert.description}</p>
                                <p class="text-xs text-gray-600">üí° ${alert.action}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // ==================== EXPORT ====================
        function setupExport() {
            document.getElementById('export-btn').addEventListener('click', () => {
                const dataStr = JSON.stringify(analysisResults, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sams-gym-analysis-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            });

            document.getElementById('save-github-btn').addEventListener('click', saveToGitHub);
            document.getElementById('load-history-btn').addEventListener('click', loadHistoricalData);
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupFileHandlers();
            setupTabs();
            setupExport();
        });
    </script>
</body>
</html>
