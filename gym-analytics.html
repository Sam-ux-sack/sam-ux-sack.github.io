<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v5.11: GitHub Load/Save SHA Fix -->
    <title>SAMS GYM Analytics Dashboard v5.11</title>
    
    <meta name="theme-color" content="#DC2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'sams-red': '#DC2626',
                        'sams-black': '#1F2937',
                        'sams-gray': '#6B7280',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; height: 400px; }
        .chart-container-small { position: relative; height: 300px; }
        
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #DC2626;
            color: #DC2626;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .drag-over {
            background-color: #fee2e2 !important;
            border: 2px dashed #DC2626 !important;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            min-width: 50px;
        }
        .heatmap-header {
            background: #1F2937;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .member-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .member-list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold" style="color: #DC2626;">
                        <!-- v5.11: Titel -->
                        üèãÔ∏è SAMS GYM Analytics v5.11
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Analyse-Zeitraum: <span id="period-display" class="font-medium">-</span>
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                        Letztes Ereignis: <span id="last-event-display" class="font-medium">-</span>
                    </p>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button id="add-data-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg shadow transition">
                        ‚ûï Neue Daten hinzuf√ºgen
                    </button>
                    <button id="export-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg shadow transition">
                        üíæ JSON Export
                    </button>
                    <button id="sync-github-btn" class="text-white px-4 py-2 rounded-lg shadow transition" style="background: #DC2626;">
                        ‚òÅÔ∏è GitHub Sync
                    </button>
                </div>
            </div>

            <!-- Time Period Filter -->
            <div id="time-filter-section" class="hidden bg-white p-4 rounded-xl shadow-md mb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Zeitraum w√§hlen:</label>
                        <select id="period-type" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="all">Gesamter Zeitraum</option>
                            <option value="year">Jahr</option>
                            <option value="quarter">Quartal</option>
                            <option value="month">Monat</option>
                        </select>
                    </div>
                    <div id="year-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                        <select id="year-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        </select>
                    </div>
                    <div id="quarter-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                        <select id="quarter-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Okt-Dez)</option>
                        </select>
                    </div>
                    <div id="month-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Monat:</label>
                        <select id="month-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="1">Januar</option>
                            <option value="2">Februar</option>
                            <option value="3">M√§rz</option>
                            <option value="4">April</option>
                            <option value="5">Mai</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Dezember</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="apply-filter-btn" class="text-white px-6 py-2 rounded-lg shadow transition font-semibold" style="background: #DC2626;">
                            Filter anwenden
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Initial Load Section -->
        <div id="initial-load-section" class="bg-white p-8 rounded-xl shadow-md mb-8 text-center">
            <div class="mb-6">
                <div class="text-6xl mb-4">üèãÔ∏è</div>
                <h2 class="text-2xl font-bold mb-2">Willkommen beim SAMS GYM Analytics Dashboard</h2>
                <p class="text-gray-600">Lade bestehende Daten oder beginne mit neuen Analysen</p>
            </div>
            
            <div class="flex gap-4 justify-center">
                <button id="load-existing-btn" class="text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                    üìÇ Gespeicherte Daten laden
                </button>
                <button id="start-new-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold">
                    üÜï Neue Analyse starten
                </button>
            </div>

            <div id="initial-loading" class="hidden mt-6">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p class="mt-2 text-gray-600">Lade Daten von GitHub...</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">üìÅ Daten hochladen</h2>
                <button id="cancel-upload-btn" class="text-gray-600 hover:text-gray-800 text-sm">
                    ‚Üê Zur√ºck zur √úbersicht
                </button>
            </div>
            
            <div id="upload-instructions" class="hidden mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                <h4 class="font-bold mb-2">üí° Wichtige Hinweise zum Hinzuf√ºgen von Daten:</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>SALTO Ereignisse:</strong> Sie k√∂nnen Ihre *gesamte* Exportdatei hochladen. Das Skript erkennt Duplikate und f√ºgt nur die Eintr√§ge hinzu, die neuer sind als Ihre gespeicherten Daten.</li>
                    <li><strong>Zoho Kontakte:</strong> Laden Sie hier *immer* Ihre **vollst√§ndige, aktuelle** Kontaktliste hoch. Diese √ºberschreibt die alte Kontaktliste, um z.B. Namens- oder Alters√§nderungen zu √ºbernehmen.</li>
                </ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Zoho Contacts Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="contacts-drop-zone">
                    <input type="file" id="contacts-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3" style="color: #DC2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="font-semibold mb-1">Zoho Kontakte (AllContacts.csv)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 hover:underline mb-2" onclick="showExample('contacts'); event.stopPropagation();">
                            üìÑ Beispiel anzeigen
                        </button>
                        <p id="contacts-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>

                <!-- SALTO Events Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="events-drop-zone">
                    <input type="file" id="events-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="font-semibold mb-1">SALTO Ereignisse (Ereignisliste.csv)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 hover:underline mb-2" onclick="showExample('events'); event.stopPropagation();">
                            üìÑ Beispiel anzeigen
                        </button>
                        <p id="events-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>
            </div>

            <button id="analyze-btn" class="hidden w-full mt-6 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                üöÄ Daten analysieren
            </button>

            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p id="loading-text" class="mt-2 text-gray-600">Daten werden analysiert und in Monate aufgeteilt...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Gesamt Check-ins</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-total-checkins">0</p>
                            <p class="text-xs mt-1" style="color: #DC2626;" id="stat-checkins-trend">-</p>
                        </div>
                        <div class="text-3xl text-red-600 bg-red-100 p-3 rounded-full">üìä</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Durchschn. Check-ins/Tag</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-avg-daily">0</p>
                            <p class="text-xs text-gray-500 mt-1">√ò pro Tag</p>
                        </div>
                        <div class="text-3xl text-blue-600 bg-blue-100 p-3 rounded-full">üìÖ</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Beliebtestes Studio</p>
                            <p class="text-xl font-bold text-gray-900" id="stat-top-studio">-</p>
                            <p class="text-xs text-gray-500 mt-1" id="stat-top-studio-percent">-</p>
                        </div>
                        <div class="text-3xl text-yellow-600 bg-yellow-100 p-3 rounded-full">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="flex overflow-x-auto">
                        <button class="tab-button active px-6 py-4 font-semibold whitespace-nowrap" data-tab="overview">
                            üìä √úbersicht
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="demographics">
                            üë• Demographics
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="utilization">
                            ‚è∞ Auslastung
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="trends">
                            üìà Trends
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="members">
                            üë• Mitglieder
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="compare">
                            üìä Vergleich
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="insights">
                            üí° Insights
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active">
                        <h3 class="text-xl font-bold mb-4">Studio-Auslastung</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-studios"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">T√§gliche Auslastung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-daily"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Tab -->
                    <div id="tab-demographics" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Mitglieder-Demographics</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio Filter:</label>
                            <select id="demo-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Geschlechterverteilung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Altersgruppen</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-age"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">Altersgruppen nach Geschlecht</h4>
                            <div class="chart-container-small">
                                <canvas id="chart-age-gender"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Studio-Vergleich</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Studio</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Check-ins</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">M√§nner</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Frauen</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">√ò Alter</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studio-comparison-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Utilization Tab -->
                    <div id="tab-utilization" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Auslastung nach Studio & Zeit</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="util-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Durchschnittliche Auslastung nach Wochentag</h4>
                                <p class="text-xs text-gray-500 mb-3">Durchschnitt pro Wochentag im gew√§hlten Zeitraum</p>
                                <div class="chart-container-small">
                                    <canvas id="chart-weekday-util"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Peak Hours Heatmap</h4>
                                <div class="overflow-x-auto">
                                    <table id="heatmap-table" class="min-w-full">
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trends Tab -->
                    <div id="tab-trends" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Monatliche Trend-Analyse</h3>
                        
                        <div id="trends-info" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-900">
                                üìä <strong id="trends-period-count">0</strong> Monate analysiert | 
                                Zeitraum: <strong id="trends-date-range">-</strong>
                            </p>
                            <p class="text-sm text-blue-900 mt-2 font-medium" id="trends-total-percent">
                                Gesamttrend (letzte 3 Mon.): -
                            </p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="trends-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>

                        <!-- Total Check-ins Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üìà Check-ins pro Monat</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-total"></canvas>
                            </div>
                        </div>

                        <!-- Gender Trends -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë• M√§nner vs. Frauen (monatlich)</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-gender"></canvas>
                            </div>
                        </div>

                        <!-- Male Age Groups Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë® M√§nner nach Altersgruppen</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-male-age"></canvas>
                            </div>
                        </div>

                        <!-- Female Age Groups Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë© Frauen nach Altersgruppen</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-female-age"></canvas>
                            </div>
                        </div>

                        <!-- Trend Alerts -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Positive Trends -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-green-800">üìà Positive Trends (Wachstum)</h4>
                                <div id="trend-alerts-positive" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4">Kein signifikantes Wachstum erkannt.</p>
                                </div>
                            </div>
                            
                            <!-- Negative Trends -->
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-red-800">üìâ Negative Trends (R√ºckgang)</h4>
                                <div id="trend-alerts-negative" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4">Keine signifikanten R√ºckg√§nge erkannt.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mitglieder-Tab -->
                    <div id="tab-members" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Top 20 Mitglieder</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="member-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6">Zeigt die aktivsten Mitglieder im aktuell gefilterten Zeitraum und Studio.</p>

                        <div class="grid grid-cols-1 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-gray-800">üèÜ Top 20 Mitglieder</h4>
                                <div id="top-members-list" class="space-y-2">
                                    <!-- JS f√ºllt diesen Bereich -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vergleichs-Tab -->
                    <div id="tab-compare" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Zeitraum-Vergleich</h3>
                        <p class="text-sm text-gray-600 mb-6">W√§hle zwei Zeitr√§ume und optional ein Studio aus, um die Kennzahlen zu vergleichen.</p>

                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen (optional):</label>
                            <select id="compare-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="all">Alle Studios (Gesamt)</option>
                                <!-- Optionen werden per JS hinzugef√ºgt -->
                            </select>
                        </div>

                        <!-- Filter-Auswahl -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-gray-50 rounded-lg">
                            <!-- Zeitraum A -->
                            <div>
                                <h4 class="font-semibold text-lg mb-3" style="color: #DC2626;">Zeitraum A (Basis)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Typ:</label>
                                        <select id="period-type-A" class="compare-period-type w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" data-period="A">
                                            <option value="all">Gesamter Zeitraum</option>
                                            <option value="year">Jahr</option>
                                            <option value="quarter">Quartal</option>
                                            <option value="month">Monat</option>
                                        </select>
                                    </div>
                                    <div id="year-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                                        <select id="year-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"></select>
                                    </div>
                                    <div id="quarter-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                                        <select id="quarter-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="Q1">Q1 (Jan-Mar)</option>
                                            <option value="Q2">Q2 (Apr-Jun)</option>
                                            <option value="Q3">Q3 (Jul-Sep)</option>
                                            <option value="Q4">Q4 (Okt-Dez)</option>
                                        </select>
                                    </div>
                                    <div id="month-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Monat:</label>
                                        <select id="month-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="1">Januar</option><option value="2">Februar</option><option value="3">M√§rz</option><option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">August</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Zeitraum B -->
                            <div>
                                <h4 class="font-semibold text-lg mb-3 text-blue-600">Zeitraum B (Vergleich)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Typ:</label>
                                        <select id="period-type-B" class="compare-period-type w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" data-period="B">
                                            <option value="all">Gesamter Zeitraum</option>
                                            <option value="year">Jahr</option>
                                            <option value="quarter">Quartal</option>
                                            <option value="month">Monat</option>
                                        </select>
                                    </div>
                                    <div id="year-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                                        <select id="year-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"></select>
                                    </div>
                                    <div id="quarter-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                                        <select id="quarter-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="Q1">Q1 (Jan-Mar)</option>
                                            <option value="Q2">Q2 (Apr-Jun)</option>
                                            <option value="Q3">Q3 (Jul-Sep)</option>
                                            <option value="Q4">Q4 (Okt-Dez)</option>
                                        </select>
                                    </div>
                                    <div id="month-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Monat:</label>
                                        <select id="month-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="1">Januar</option><option value="2">Februar</option><option value="3">M√§rz</option><option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">August</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="run-compare-btn" class="w-full text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                            üìä Zeitr√§ume vergleichen
                        </button>

                        <!-- Vergleichs-Ergebnis -->
                        <div id="compare-results-container" class="hidden mt-8">
                            <h3 class="text-xl font-bold mb-4">Vergleichs-Ergebnis</h3>
                            <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase">Metrik</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase">Zeitraum A</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase">Zeitraum B</th>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase">Ver√§nderung</th>
                                        </tr>
                                    </thead>
                                    <tbody id="compare-results-table" class="bg-white divide-y divide-gray-200">
                                        <!-- JS f√ºllt diesen Bereich -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>

                    <!-- Insights Tab -->
                    <div id="tab-insights" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Actionable Insights & Empfehlungen</h3>
                        <div id="insights-container" class="space-y-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Example, GitHub Sync) -->
    <div id="example-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold" id="example-title">Beispiel</h3>
                <button onclick="closeModal('example-modal')" class="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
            </div>
            <div id="example-content"></div>
        </div>
    </div>
    
    <div id="github-sync-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">‚òÅÔ∏è GitHub Sync</h3>
                <button onclick="closeModal('github-sync-modal')" class="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                Speichere oder lade deine Analysedaten als 'analysis-data.json' in deinem GitHub-Repo.
                Dein Token wird nur tempor√§r im Browser gespeichert.
            </p>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Status:</label>
                <input id="github-status" type="text" readonly class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg" value="Nicht geladen">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Repo-Besitzer (z.B. "sam-ux-sack"):</label>
                <input id="github-owner" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Repo-Name (z.B. "sams-gym-data"):</label>
                <input id="github-repo" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">GitHub Personal Access Token (classic):</label>
                <input id="github-token" type="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                <a href="https://github.com/settings/tokens/new?scopes=repo&description=SAMS-GYM-Analytics" target="_blank" class="text-xs text-blue-600 hover:underline mt-1">
                    Neuen Token erstellen (mit "repo" Rechten)
                </a>
            </div>

            <div id="github-error" class="hidden p-3 bg-red-100 border border-red-300 text-red-800 rounded-lg mb-4 text-sm">
                Fehler: Irgendwas ist schief gelaufen.
            </div>

            <div class="flex gap-4">
                <button id="github-load-btn" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg shadow transition font-semibold">
                    Laden
                </button>
                <button id="github-save-btn" class="flex-1 text-white px-6 py-3 rounded-lg shadow transition font-semibold" style="background: #DC2626;">
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const GITHUB_CONFIG = {
            owner: 'sam-ux-sack',
            repo: 'sams-gym-data',
            token: null,
            sha: null, // Stores the SHA hash of the file for updates
            dataFile: 'analysis-data.json'
        };

        const MAIN_DOORS = {
            'Susten Hauptt√ºre': 'Susten GYM',
            'Strongman rechts': 'Susten CrossGYM',
            'Visp S√ºd - Eingang': 'Visp-S√ºd',
            'Visp Center - Eingang': 'Visp-Center'
        };

        const AGE_GROUPS = ['<20', '20-40', '40-60', '60+'];
        const GENDERS = ['M√§nnlich', 'Weiblich'];

        // ==================== DATA STORAGE ====================
        let contactsData = null;    // Tempor√§r f√ºr Upload
        let eventsData = null;      // Tempor√§r f√ºr Upload
        let allCheckins = [];       // Die Haupt-Datenbank
        let filteredCheckins = [];  // F√ºr die Charts nach Filterung
        let analysisResults = null; // Aggregierte Ergebnisse
        let monthlyTrends = [];     // Aggregierte Monats-Daten
        let charts = {};
        let isLoadedFromGitHub = false;
        let lastEventDate = null;

        // ==================== CHART HELPERS ====================
        Chart.register(ChartDataLabels);

        function getDatalabelConfig(isInside = false) {
            if (isInside) {
                return {
                    anchor: 'end',
                    align: 'end',
                    color: '#FFFFFF',
                    font: { weight: 'bold' },
                    formatter: (value) => value > 0 ? value.toLocaleString('de-DE') : null,
                    offset: -6
                };
            }
            return {
                anchor: 'end',
                align: 'top',
                color: '#1F2937',
                font: { weight: 'bold' },
                formatter: (value) => value.toLocaleString('de-DE')
            };
        }

        // ==================== MODAL HANDLERS ====================
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showExample(type) {
            const title = document.getElementById('example-title');
            const content = document.getElementById('example-content');

            if (type === 'contacts') {
                title.textContent = 'Beispiel: Zoho Kontakte CSV';
                content.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Erforderliche Spalten:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Kundennummer</strong> oder <strong>CUSTOMER_ID</strong> - z.B. "CUS-12345"</li>
                            <li><strong>Name</strong> - z.B. "Herr Max M√ºller" oder "Frau Anna Schmidt"</li>
                            <li><strong>Geburtsdatum</strong> - Format: TT.MM.JJJJ oder JJJJ-MM-TT</li>
                        </ul>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="border px-3 py-2">Kundennummer</th>
                                    <th class="border px-3 py-2">Name</th>
                                    <th class="border px-3 py-2">Geburtsdatum</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border px-3 py-2">CUS-12345</td>
                                    <td class="border px-3 py-2">Herr Max M√ºller</td>
                                    <td class="border px-3 py-2">15.03.1990</td>
                                </tr>
                                <tr>
                                    <td class="border px-3 py-2">CUS-12346</td>
                                    <td class="border px-3 py-2">Frau Anna Schmidt</td>
                                    <td class="border px-3 py-2">22.07.1985</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                title.textContent = 'Beispiel: SALTO Ereignisse CSV';
                content.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Format:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Spalte 1:</strong> Zeitstempel (TT.MM.JJJJ HH:MM:SS)</li>
                            <li><strong>Spalte 3:</strong> T√ºrname - Muss einer der Hauptt√ºren sein:
                                <ul class="list-circle list-inside ml-6 mt-1">
                                    ${Object.keys(MAIN_DOORS).map(door => `<li>"${door}"</li>`).join('')}
                                </ul>
                            </li>
                            <li><strong>Spalte 5:</strong> CUS-Nummer (z.B. "CUS-12345")</li>
                        </ul>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm border">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="border px-3 py-2">Zeitstempel</th>
                                    <th class="border px-3 py-2">...</th>
                                    <th class="border px-3 py-2">T√ºrname</th>
                                    <th class="border px-3 py-2">...</th>
                                    <th class="border px-3 py-2">CUS-Nr</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border px-3 py-2">25.10.2025 14:35:22</td>
                                    <td class="border px-3 py-2">Access granted</td>
                                    <td class="border px-3 py-2">Susten Hauptt√ºre</td>
                                    <td class="border px-3 py-2"></td>
                                    <td class="border px-3 py-2">CUS-12345</td>
                                </tr>
                                <tr>
                                    <td class="border px-3 py-2">25.10.2025 14:38:15</td>
                                    <td class="border px-3 py-2">Access granted</td>
                                    <td class="border px-3 py-2">Visp S√ºd - Eingang</td>
                                    <td class="border px-3 py-2"></td>
                                    <td class="border px-3 py-2">CUS-12346</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            showModal('example-modal');
        }

        // ==================== INITIAL LOAD ====================
        function setupInitialLoad() {
            document.getElementById('load-existing-btn').addEventListener('click', () => {
                document.getElementById('initial-load-section').classList.add('hidden');
                document.getElementById('initial-loading').classList.remove('hidden');
                loadFromGitHub();
            });
            document.getElementById('start-new-btn').addEventListener('click', startNewAnalysis);
            document.getElementById('cancel-upload-btn').addEventListener('click', () => {
                document.getElementById('upload-section').classList.add('hidden');
                if (isLoadedFromGitHub || allCheckins.length > 0) {
                    document.getElementById('results-section').classList.remove('hidden');
                } else {
                    document.getElementById('initial-load-section').classList.remove('hidden');
                }
            });
            document.getElementById('add-data-btn').addEventListener('click', () => {
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('upload-section').classList.remove('hidden');
                if (allCheckins.length > 0) {
                    document.getElementById('upload-instructions').classList.remove('hidden');
                }
            });
        }

        function startNewAnalysis() {
            // Hard-Reset
            allCheckins = [];
            monthlyTrends = [];
            contactsData = null;
            eventsData = null;
            isLoadedFromGitHub = false;
            lastEventDate = null;
            GITHUB_CONFIG.sha = null;

            document.getElementById('initial-load-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('time-filter-section').classList.add('hidden');
            document.getElementById('add-data-btn').classList.add('hidden');
            document.getElementById('export-btn').classList.add('hidden');
            
            document.getElementById('upload-section').classList.remove('hidden');
            document.getElementById('upload-instructions').classList.add('hidden');
            document.getElementById('contacts-status').textContent = 'Keine Datei';
            document.getElementById('events-status').textContent = 'Keine Datei';
            document.getElementById('contacts-status').classList.remove('text-green-600');
            document.getElementById('events-status').classList.remove('text-green-600');
            
            console.log('New analysis started. All data cleared.');
        }

        // ==================== FILE UPLOAD HANDLERS ====================
        function setupFileHandlers() {
            const contactsZone = document.getElementById('contacts-drop-zone');
            const contactsInput = document.getElementById('contacts-input');
            
            contactsZone.addEventListener('click', () => contactsInput.click());
            contactsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'contacts'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                contactsZone.addEventListener(eventName, preventDefaults);
            });
            contactsZone.addEventListener('dragover', () => contactsZone.classList.add('drag-over'));
            contactsZone.addEventListener('dragleave', () => contactsZone.classList.remove('drag-over'));
            contactsZone.addEventListener('drop', (e) => {
                contactsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'contacts');
            });

            const eventsZone = document.getElementById('events-drop-zone');
            const eventsInput = document.getElementById('events-input');
            
            eventsZone.addEventListener('click', () => eventsInput.click());
            eventsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'events'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                eventsZone.addEventListener(eventName, preventDefaults);
            });
            eventsZone.addEventListener('dragover', () => eventsZone.classList.add('drag-over'));
            eventsZone.addEventListener('dragleave', () => eventsZone.classList.remove('drag-over'));
            eventsZone.addEventListener('drop', (e) => {
                eventsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'events');
            });

            document.getElementById('analyze-btn').addEventListener('click', analyzeData);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFileSelect(file, type) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Bitte eine CSV-Datei ausw√§hlen!');
                return;
            }

            const statusEl = document.getElementById(`${type}-status`);
            statusEl.textContent = `‚úì ${file.name}`;
            statusEl.classList.add('text-green-600');

            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    if (type === 'contacts') {
                        contactsData = results.data;
                        console.log('Contacts loaded:', contactsData.length);
                    } else {
                        eventsData = results.data;
                        console.log('Events loaded:', eventsData.length);
                    }
                    
                    if (contactsData && eventsData) {
                        document.getElementById('analyze-btn').classList.remove('hidden');
                    }
                },
                error: (err) => {
                    alert(`Fehler beim Parsen der ${type} CSV: ${err.message}`);
                    statusEl.textContent = `Fehler: ${err.message}`;
                    statusEl.classList.remove('text-green-600');
                    statusEl.classList.add('text-red-600');
                }
            });
        }

        // ==================== DATA ANALYSIS (CSV) ====================
        function analyzeData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loading-text').textContent = 'Analysiere Kontakte...';
            document.getElementById('analyze-btn').classList.add('hidden');

            setTimeout(() => {
                // v5.10: Contact list is now a replacement, not a merge.
                // It's used to lookup new events.
                const contactsLookup = {};
                contactsData.forEach(contact => {
                    const cusNumber = contact['Kundennummer'] || contact['CUSTOMER_ID'];
                    if (cusNumber) {
                        contactsLookup[cusNumber] = {
                            name: contact['Name'] || '',
                            birthdate: contact['Geburtsdatum'] || '',
                            gender: extractGender(contact['Name'] || ''),
                            age: calculateAge(contact['Geburtsdatum'] || '')
                        };
                    }
                });
                
                document.getElementById('loading-text').textContent = 'Analysiere Ereignisse...';

                setTimeout(() => {
                    let newCheckins = 0;
                    // v5.10: Use a Set for efficient duplicate checking
                    const existingCheckinTimestamps = new Set(allCheckins.map(c => c.timestamp.getTime()));
                    let latestDate = lastEventDate ? new Date(lastEventDate) : null;

                    eventsData.forEach(event => {
                        const cols = Object.values(event);
                        if (cols.length < 5) return;

                        const timestampStr = cols[0];
                        const doorName = cols[2];
                        const cusNumber = cols[4];

                        if (!MAIN_DOORS[doorName]) return;
                        if (!cusNumber || !cusNumber.startsWith('CUS-')) return;
                        
                        const contact = contactsLookup[cusNumber];
                        if (!contact) return; // Filter out checkins with no matching contact

                        const date = parseGermanDate(timestampStr);
                        if (!date) return;
                        
                        // Intelligent Merge: Skip if timestamp already exists
                        if (existingCheckinTimestamps.has(date.getTime())) {
                            return;
                        }

                        const dateKey = date.toISOString().split('T')[0];
                        const hour = date.getHours();
                        const day = (date.getDay() + 6) % 7; // 0=Mo, 1=Di, ..., 6=So

                        allCheckins.push({
                            timestamp: date,
                            studio: MAIN_DOORS[doorName],
                            cusNumber,
                            name: contact.name, // Added for member list
                            gender: contact.gender || 'Unknown',
                            age: contact.age || null,
                            ageGroup: getAgeGroup(contact.age),
                            dateKey,
                            hour,
                            day
                        });
                        newCheckins++;

                        if (!latestDate || date > latestDate) {
                            latestDate = date;
                        }
                    });

                    allCheckins.sort((a, b) => a.timestamp - b.timestamp);
                    lastEventDate = latestDate;
                    
                    document.getElementById('loading-text').textContent = 'Generiere monatliche Trends...';

                    setTimeout(() => {
                        generateMonthlyTrends();
                        
                        filteredCheckins = [...allCheckins];
                        processAnalysis();

                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('results-section').classList.remove('hidden');
                        document.getElementById('time-filter-section').classList.remove('hidden');
                        document.getElementById('export-btn').classList.remove('hidden');
                        document.getElementById('sync-github-btn').classList.remove('hidden');
                        document.getElementById('upload-section').classList.add('hidden');
                        document.getElementById('add-data-btn').classList.remove('hidden');

                        setupTimeFilters();
                        setupAllStudioFilters();
                        setupCompareTab(); // Init compare tab filters
                        renderAllCharts();
                        
                        // Reset upload form
                        contactsData = null;
                        eventsData = null;
                        document.getElementById('contacts-input').value = null;
                        document.getElementById('events-input').value = null;
                        document.getElementById('contacts-status').textContent = 'Keine Datei';
                        document.getElementById('events-status').textContent = 'Keine Datei';
                        document.getElementById('contacts-status').classList.remove('text-green-600');
                        document.getElementById('events-status').classList.remove('text-green-600');

                    }, 20);
                }, 20);
            }, 20);
        }

        // ==================== MONTHLY TRENDS GENERATION ====================
        function generateMonthlyTrends() {
            const monthlyData = {};

            const createStatsObject = () => {
                const stats = {
                    total: 0,
                    male: 0,
                    female: 0,
                    maleAge: {},
                    femaleAge: {}
                };
                AGE_GROUPS.forEach(group => {
                    stats.maleAge[group] = 0;
                    stats.femaleAge[group] = 0;
                });
                return stats;
            };

            allCheckins.forEach(c => {
                const year = c.timestamp.getFullYear();
                const month = c.timestamp.getMonth();
                const key = `${year}-${String(month + 1).padStart(2, '0')}`;

                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        period: key,
                        year: year,
                        month: month + 1,
                        daysInMonth: new Date(year, month + 1, 0).getDate(),
                        daysRecorded: new Set(),
                        studios: {}
                    };
                }

                if (!monthlyData[key].studios[c.studio]) {
                    monthlyData[key].studios[c.studio] = createStatsObject();
                }

                monthlyData[key].daysRecorded.add(c.timestamp.getDate());
                
                const stats = monthlyData[key].studios[c.studio];
                stats.total++;

                if (c.gender === 'M√§nnlich') {
                    stats.male++;
                    if (stats.maleAge[c.ageGroup] !== undefined) {
                        stats.maleAge[c.ageGroup]++;
                    }
                } else if (c.gender === 'Weiblich') {
                    stats.female++;
                    if (stats.femaleAge[c.ageGroup] !== undefined) {
                        stats.femaleAge[c.ageGroup]++;
                    }
                }
            });

            monthlyTrends = Object.keys(monthlyData).sort().map(key => {
                const data = monthlyData[key];
                
                const today = new Date();
                const isCurrentMonth = data.year === today.getFullYear() && data.month === (today.getMonth() + 1);
                let projectionFactor = 1.0;
                let isProjected = false;

                if (isCurrentMonth) {
                    const daysRecordedCount = data.daysRecorded.size;
                    if (daysRecordedCount < data.daysInMonth) {
                        projectionFactor = data.daysInMonth / daysRecordedCount;
                        isProjected = true;
                    }
                }
                
                Object.values(data.studios).forEach(studio => {
                    if (isProjected) {
                        studio.total = Math.round(studio.total * projectionFactor);
                        studio.male = Math.round(studio.male * projectionFactor);
                        studio.female = Math.round(studio.female * projectionFactor);
                        AGE_GROUPS.forEach(group => {
                            studio.maleAge[group] = Math.round(studio.maleAge[group] * projectionFactor);
                            studio.femaleAge[group] = Math.round(studio.femaleAge[group] * projectionFactor);
                        });
                    }
                });

                return {
                    period: data.period + (isProjected ? ' (Hochr.)' : ''),
                    year: data.year,
                    month: data.month,
                    studios: data.studios
                };
            });
            console.log('Monthly trends generated/updated:', monthlyTrends.length, 'months');
        }


        // ==================== MAIN ANALYSIS (after filter) ====================
        function processAnalysis() {
            if (allCheckins.length === 0) {
                console.log('processAnalysis skipped: no checkins');
                return;
            }

            const studioStats = {};
            const dailyStats = {};
            const hourlyStats = {};
            const weekdayStats = {};
            
            Object.values(MAIN_DOORS).forEach(studio => {
                studioStats[studio] = 0;
            });

            filteredCheckins.forEach(c => {
                studioStats[c.studio] = (studioStats[c.studio] || 0) + 1;
                dailyStats[c.dateKey] = (dailyStats[c.dateKey] || 0) + 1;
                
                const hourKey = `${c.day}-${c.hour}`; // 0=Mo, 6=So
                hourlyStats[hourKey] = (hourlyStats[hourKey] || 0) + 1;
                
                weekdayStats[c.day] = (weekdayStats[c.day] || 0) + 1;
            });

            const startDate = filteredCheckins.length > 0 ? filteredCheckins[0].timestamp : new Date();
            const endDate = filteredCheckins.length > 0 ? filteredCheckins[filteredCheckins.length - 1].timestamp : new Date();

            analysisResults = {
                checkins: filteredCheckins,
                studioStats,
                dailyStats,
                hourlyStats,
                weekdayStats,
                startDate,
                endDate
            };

            renderResults();
        }

        // ==================== TIME FILTERS ====================
        function setupTimeFilters() {
            const periodType = document.getElementById('period-type');
            const yearSelector = document.getElementById('year-selector');
            const quarterSelector = document.getElementById('quarter-selector');
            const monthSelector = document.getElementById('month-selector');
            const applyBtn = document.getElementById('apply-filter-btn');

            const years = [...new Set(allCheckins.map(c => c.timestamp.getFullYear()))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            periodType.addEventListener('change', () => {
                const type = periodType.value;
                yearSelector.classList.toggle('hidden', type === 'all');
                quarterSelector.classList.toggle('hidden', type !== 'quarter');
                monthSelector.classList.toggle('hidden', type !== 'month');
            });

            applyBtn.addEventListener('click', applyTimeFilter);
        }
        
        function applyTimeFilter() {
            const periodType = document.getElementById('period-type').value;
            
            if (periodType === 'all') {
                filteredCheckins = [...allCheckins];
            } else {
                const year = parseInt(document.getElementById('year-select').value);
                
                if (periodType === 'year') {
                    filteredCheckins = allCheckins.filter(c => c.timestamp.getFullYear() === year);
                } else if (periodType === 'quarter') {
                    const quarter = document.getElementById('quarter-select').value;
                    const qMap = { 'Q1': [0, 1, 2], 'Q2': [3, 4, 5], 'Q3': [6, 7, 8], 'Q4': [9, 10, 11] };
                    const months = qMap[quarter];
                    filteredCheckins = allCheckins.filter(c => 
                        c.timestamp.getFullYear() === year && months.includes(c.timestamp.getMonth())
                    );
                } else if (periodType === 'month') {
                    const month = parseInt(document.getElementById('month-select').value) - 1;
                    filteredCheckins = allCheckins.filter(c => 
                        c.timestamp.getFullYear() === year && c.timestamp.getMonth() === month
                    );
                }
            }

            processAnalysis();
        }

        // ==================== STUDIO FILTERS (Setup) ====================
        function setupAllStudioFilters() {
            const studios = Object.values(MAIN_DOORS);
            const selects = [
                document.getElementById('demo-studio-filter'),
                document.getElementById('util-studio-filter'),
                document.getElementById('trends-studio-filter'),
                document.getElementById('member-studio-filter'),
                document.getElementById('compare-studio-filter')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>';
                studios.forEach(studio => {
                    const option = document.createElement('option');
                    option.value = studio;
                    option.textContent = studio;
                    select.appendChild(option);
                });
            });

            // Add specific listeners
            document.getElementById('demo-studio-filter').addEventListener('change', (e) => updateDemographicsCharts(e.target.value));
            document.getElementById('util-studio-filter').addEventListener('change', (e) => updateUtilizationCharts(e.target.value));
            document.getElementById('trends-studio-filter').addEventListener('change', (e) => renderTrendCharts(e.target.value));
            document.getElementById('member-studio-filter').addEventListener('change', (e) => renderMembersTab(e.target.value));
        }


        // ==================== RENDER ALL ====================
        function renderAllCharts() {
            renderTrendCharts('all');
            updateDemographicsCharts('all');
            updateUtilizationCharts('all');
            renderMembersTab('all');
            analyzeTrendAlerts('all');
        }
        
        function renderResults() {
            const { checkins, studioStats, dailyStats, startDate, endDate } = analysisResults;

            document.getElementById('period-display').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            document.getElementById('last-event-display').textContent = lastEventDate ? lastEventDate.toLocaleString('de-DE') : '-';

            document.getElementById('stat-total-checkins').textContent = checkins.length.toLocaleString('de-DE');
            
            const daysCount = Object.keys(dailyStats).length || 1;
            const avgDaily = Math.round(checkins.length / daysCount);
            document.getElementById('stat-avg-daily').textContent = avgDaily.toLocaleString('de-DE');

            const topStudio = Object.entries(studioStats).sort((a, b) => b[1] - a[1])[0];
            if (topStudio) {
                document.getElementById('stat-top-studio').textContent = topStudio[0];
                const percent = checkins.length > 0 ? ((topStudio[1] / checkins.length) * 100).toFixed(0) : 0;
                document.getElementById('stat-top-studio-percent').textContent = `${percent}% der Check-ins`;
            }

            // Overview Charts
            renderStudioChart();
            renderDailyChart();
            
            // Other tabs (will be re-rendered by their own filters, but need initial render)
            updateDemographicsCharts(document.getElementById('demo-studio-filter').value);
            updateUtilizationCharts(document.getElementById('util-studio-filter').value);
            renderTrendCharts(document.getElementById('trends-studio-filter').value);
            renderMembersTab(document.getElementById('member-studio-filter').value);
            analyzeTrendAlerts(document.getElementById('trends-studio-filter').value);
            renderInsights();
        }

        // ==================== OVERVIEW CHARTS ====================
        function renderStudioChart() {
            const { studioStats } = analysisResults;
            const ctx = document.getElementById('chart-studios');
            
            if (charts.studios) charts.studios.destroy();
            
            const sorted = Object.entries(studioStats).sort((a, b) => b[1] - a[1]);
            
            charts.studios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Check-ins',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig(true) // Inside
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDailyChart() {
            const { dailyStats } = analysisResults;
            const ctx = document.getElementById('chart-daily');
            
            if (charts.daily) charts.daily.destroy();
            
            const sorted = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0]));
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d[0]);
                        date.setUTCHours(12); // Prevent timezone issues
                        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Check-ins pro Tag',
                        data: sorted.map(d => d[1]),
                        borderColor: '#DC2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ==================== DEMOGRAPHICS CHARTS ====================
        function updateDemographicsCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            // Gender chart
            const genderCounts = { 'M√§nnlich': 0, 'Weiblich': 0 };
            checkins.forEach(c => {
                if (genderCounts[c.gender] !== undefined) {
                    genderCounts[c.gender]++;
                }
            });
            
            const genderCtx = document.getElementById('chart-gender');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['M√§nner', 'Frauen'],
                    datasets: [{
                        data: [genderCounts['M√§nnlich'], genderCounts['Weiblich']],
                        backgroundColor: ['#1F2937', '#DC2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                if (sum === 0) return '0%';
                                const percent = ((value / sum) * 100).toFixed(0);
                                return `${percent}%`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 16 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Age chart
            const ageCounts = {};
            AGE_GROUPS.forEach(group => ageCounts[group] = 0);
            checkins.forEach(c => {
                if (ageCounts[c.ageGroup] !== undefined) {
                    ageCounts[c.ageGroup]++;
                }
            });

            const ageCtx = document.getElementById('chart-age');
            if (charts.age) charts.age.destroy();
            
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: AGE_GROUPS,
                    datasets: [{
                        label: 'Check-ins',
                        data: Object.values(ageCounts),
                        backgroundColor: '#6B7280'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig(true) // Inside
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Age-Gender breakdown
            const ageGenderData = {};
            AGE_GROUPS.forEach(group => ageGenderData[group] = { male: 0, female: 0 });

            checkins.forEach(c => {
                if (ageGenderData[c.ageGroup]) {
                    if (c.gender === 'M√§nnlich') ageGenderData[c.ageGroup].male++;
                    else if (c.gender === 'Weiblich') ageGenderData[c.ageGroup].female++;
                }
            });

            const ageGenderCtx = document.getElementById('chart-age-gender');
            if (charts.ageGender) charts.ageGender.destroy();

            charts.ageGender = new Chart(ageGenderCtx, {
                type: 'bar',
                data: {
                    labels: AGE_GROUPS,
                    datasets: [
                        {
                            label: 'M√§nner',
                            data: Object.values(ageGenderData).map(d => d.male),
                            backgroundColor: '#1F2937'
                        },
                        {
                            label: 'Frauen',
                            data: Object.values(ageGenderData).map(d => d.female),
                            backgroundColor: '#DC2626'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { stacked: true, beginAtZero: true },
                        y: { stacked: true }
                    }
                }
            });

            // Studio comparison table
            renderStudioComparisonTable();
        }

        function renderStudioComparisonTable() {
            const { checkins } = analysisResults;
            const tbody = document.getElementById('studio-comparison-table');
            tbody.innerHTML = '';

            const studios = Object.values(MAIN_DOORS);
            
            studios.forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                const totalWithGender = males + females;
                
                const ages = studioCheckins.map(c => c.age).filter(a => a !== null);
                const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : '-';
                
                const totalCheckins = studioCheckins.length;
                if (totalCheckins === 0) return; // Don't show studios with 0 checkins

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${studio}</td>
                    <td class="px-4 py-3">${totalCheckins.toLocaleString('de-DE')}</td>
                    <td class="px-4 py-3">${totalWithGender > 0 ? ((males / totalWithGender) * 100).toFixed(0) : 0}%</td>
                    <td class="px-4 py-3">${totalWithGender > 0 ? ((females / totalWithGender) * 100).toFixed(0) : 0}%</td>
                    <td class="px-4 py-3">${avgAge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== UTILIZATION CHARTS ====================
        function updateUtilizationCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const weekdayTotals = {}; // 0-Mo, 6-So
            
            const uniqueDatesByWeekday = {};
            for(let i=0; i<7; i++) {
                uniqueDatesByWeekday[i] = new Set();
                weekdayTotals[i] = 0;
            }

            checkins.forEach(c => {
                weekdayTotals[c.day]++;
                uniqueDatesByWeekday[c.day].add(c.dateKey);
            });

            const dayNames = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            const avgData = dayNames.map((day, idx) => {
                const total = weekdayTotals[idx] || 0;
                const count = uniqueDatesByWeekday[idx].size || 1; // Avoid division by zero
                return Math.round(total / count);
            });

            const ctx = document.getElementById('chart-weekday-util');
            if (charts.weekdayUtil) charts.weekdayUtil.destroy();

            charts.weekdayUtil = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: '√ò Check-ins',
                        data: avgData,
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig(true) // Inside
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Heatmap
            renderHeatmapTable(checkins);
        }

        function renderHeatmapTable(checkins) {
            const hourlyStats = {}; // key: "day-hour"
            checkins.forEach(c => {
                const key = `${c.day}-${c.hour}`;
                hourlyStats[key] = (hourlyStats[key] || 0) + 1;
            });

            const table = document.getElementById('heatmap-table');
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

            const maxCount = Math.max(...Object.values(hourlyStats), 1);

            let html = '<thead><tr class="heatmap-header"><th class="heatmap-cell">Uhrzeit</th>';
            dayNames.forEach(day => {
                html += `<th class="heatmap-cell">${day}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let hour = 6; hour <= 23; hour++) {
                html += `<tr><td class="heatmap-cell font-bold">${String(hour).padStart(2, '0')}:00</td>`;
                for (let day = 0; day < 7; day++) {
                    const key = `${day}-${hour}`;
                    const count = hourlyStats[key] || 0;
                    const intensity = count > 0 ? (count / maxCount) : 0;
                    const bgColor = count === 0 ? '#f9fafb' : `rgba(220, 38, 38, ${0.1 + intensity * 0.9})`;
                    const textColor = intensity > 0.6 ? '#fff' : '#1F2937';
                    html += `<td class="heatmap-cell" style="background-color: ${bgColor}; color: ${textColor};">${count > 0 ? count : ''}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody>';
            table.innerHTML = html;
        }

        // ==================== TRENDS TAB ====================
        function renderTrendCharts(studioFilter) {
            const labels = monthlyTrends.map(m => m.period);
            
            // Helper to get aggregated data
            const getAggregatedData = (metric, subMetric = null, subSubMetric = null) => {
                return monthlyTrends.map(m => {
                    let total = 0;
                    const studiosToSum = studioFilter === 'all' ? Object.values(m.studios) : [m.studios[studioFilter]];
                    
                    studiosToSum.forEach(studio => {
                        if (!studio) return;
                        if (subSubMetric) {
                            total += studio[metric]?.[subMetric]?.[subSubMetric] || 0;
                        } else if (subMetric) {
                            total += studio[metric]?.[subMetric] || 0;
                        } else {
                            total += studio[metric] || 0;
                        }
                    });
                    return total;
                });
            };

            // Chart 1: Total Check-ins
            renderChart(charts, 'trendsTotal', 'chart-trends-total', 'line', {
                labels,
                datasets: [{
                    label: 'Check-ins',
                    data: getAggregatedData('total'),
                    borderColor: '#DC2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            }, { legend: { display: false } });

            // Chart 2: Gender
            renderChart(charts, 'trendsGender', 'chart-trends-gender', 'line', {
                labels,
                datasets: [
                    {
                        label: 'M√§nner',
                        data: getAggregatedData('male'),
                        borderColor: '#1F2937',
                        tension: 0.4
                    },
                    {
                        label: 'Frauen',
                        data: getAggregatedData('female'),
                        borderColor: '#DC2626',
                        tension: 0.4
                    }
                ]
            });

            // Chart 3: Male Age Groups
            const maleAgeColors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];
            renderChart(charts, 'trendsMaleAge', 'chart-trends-male-age', 'line', {
                labels,
                datasets: AGE_GROUPS.map((group, idx) => ({
                    label: group,
                    data: getAggregatedData('maleAge', group),
                    borderColor: maleAgeColors[idx],
                    tension: 0.4
                }))
            });
            
            // Chart 4: Female Age Groups
            const femaleAgeColors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];
            renderChart(charts, 'trendsFemaleAge', 'chart-trends-female-age', 'line', {
                labels,
                datasets: AGE_GROUPS.map((group, idx) => ({
                    label: group,
                    data: getAggregatedData('femaleAge', group),
                    borderColor: femaleAgeColors[idx],
                    tension: 0.4
                }))
            });
            
            // Update info
            if (monthlyTrends.length > 0) {
                document.getElementById('trends-period-count').textContent = monthlyTrends.length;
                const firstMonth = monthlyTrends[0];
                const lastMonth = monthlyTrends[monthlyTrends.length - 1];
                document.getElementById('trends-date-range').textContent = `${firstMonth.period.split(' ')[0]} - ${lastMonth.period.split(' ')[0]}`;
            }

            // Analyze alerts
            analyzeTrendAlerts(studioFilter);
        }

        // Generic Chart Renderer
        function renderChart(chartCache, cacheKey, elementId, type, data, options = {}) {
            const ctx = document.getElementById(elementId);
            if (!ctx) return;
            if (chartCache[cacheKey]) chartCache[cacheKey].destroy();
            
            chartCache[cacheKey] = new Chart(ctx, {
                type,
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', ...options.legend },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        ...options.scales
                    }
                }
            });
        }
        
        // ==================== TREND ALERTS ====================
        function analyzeTrendAlerts(studioFilter) {
            const positiveContainer = document.getElementById('trend-alerts-positive');
            const negativeContainer = document.getElementById('trend-alerts-negative');
            positiveContainer.innerHTML = '';
            negativeContainer.innerHTML = '';

            if (monthlyTrends.length < 3) {
                positiveContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Mind. 3 Monate Daten n√∂tig.</p>';
                negativeContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Mind. 3 Monate Daten n√∂tig.</p>';
                document.getElementById('trends-total-percent').textContent = 'Gesamttrend (letzte 3 Mon.): -';
                return;
            }

            const alerts = [];
            const recent = monthlyTrends.slice(-3);
            const period = `(${recent[0].period.split(' ')[0]} vs ${recent[2].period.split(' ')[0]})`;

            // Helper to get aggregated value for a specific month
            const getMonthlyValue = (month, metric, subMetric = null, subSubMetric = null) => {
                let total = 0;
                const studiosToSum = studioFilter === 'all' ? Object.values(month.studios) : [month.studios[studioFilter]];
                
                studiosToSum.forEach(studio => {
                    if (!studio) return;
                    if (subSubMetric) {
                        total += studio[metric]?.[subMetric]?.[subSubMetric] || 0;
                    } else if (subMetric) {
                        total += studio[metric]?.[subMetric] || 0;
                    } else {
                        total += studio[metric] || 0;
                    }
                });
                return total;
            };

            // Check Total
            const totalStart = getMonthlyValue(recent[0], 'total');
            const totalEnd = getMonthlyValue(recent[2], 'total');
            const totalChange = calculatePercentChange(totalStart, totalEnd);
            
            document.getElementById('trends-total-percent').textContent = `Gesamttrend (letzte 3 Mon.): ${totalChange}`;
            
            // Check Genders
            GENDERS.forEach(gender => {
                const start = getMonthlyValue(recent[0], gender.toLowerCase());
                const end = getMonthlyValue(recent[2], gender.toLowerCase());
                if (start > 10 || end > 10) { // Min 10 checkins to be relevant
                    alerts.push({
                        title: `Trend ${gender}`,
                        start,
                        end
                    });
                }
            });

            // Check Age Groups
            GENDERS.forEach(gender => {
                AGE_GROUPS.forEach(group => {
                    const metric = gender === 'M√§nnlich' ? 'maleAge' : 'femaleAge';
                    const start = getMonthlyValue(recent[0], metric, group);
                    const end = getMonthlyValue(recent[2], metric, group);
                    if (start > 5 || end > 5) { // Min 5 checkins
                        alerts.push({
                            title: `Trend ${gender} ${group}`,
                            start,
                            end
                        });
                    }
                });
            });

            let positiveCount = 0;
            let negativeCount = 0;

            alerts.forEach(alert => {
                const change = alert.end - alert.start;
                const percent = calculatePercentChange(alert.start, alert.end);

                if (Math.abs(change) < 5 || Math.abs(parseFloat(percent)) < 15) return; // Ignore small changes

                const div = document.createElement('div');
                div.className = 'p-3 bg-white rounded-lg shadow-sm border';
                
                if (change > 0) {
                    // Positive
                    div.innerHTML = `
                        <h5 class="font-bold text-green-800">${alert.title}</h5>
                        <p class="text-sm text-gray-700">Anstieg von ${alert.start} auf ${alert.end} √ñffnungen</p>
                        <p class="text-xs text-gray-500">${period} (${percent})</p>
                    `;
                    positiveContainer.appendChild(div);
                    positiveCount++;
                } else {
                    // Negative
                    div.innerHTML = `
                        <h5 class="font-bold text-red-800">${alert.title}</h5>
                        <p class="text-sm text-gray-700">R√ºckgang von ${alert.start} auf ${alert.end} √ñffnungen</p>
                        <p class="text-xs text-gray-500">${period} (${percent})</p>
                    `;
                    negativeContainer.appendChild(div);
                    negativeCount++;
                }
            });

            if (positiveCount === 0) {
                positiveContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Kein signifikantes Wachstum erkannt.</p>';
            }
            if (negativeCount === 0) {
                negativeContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Keine signifikanten R√ºckg√§nge erkannt.</p>';
            }
        }


        // ==================== MEMBERS TAB ====================
        function renderMembersTab(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const memberStats = {};
            checkins.forEach(c => {
                const key = `${c.cusNumber} / ${c.name}`;
                memberStats[key] = (memberStats[key] || 0) + 1;
            });

            const sortedMembers = Object.entries(memberStats).sort((a, b) => b[1] - a[1]);

            // Top 20 Members
            const topList = document.getElementById('top-members-list');
            topList.innerHTML = '';
            sortedMembers.slice(0, 20).forEach(([key, count]) => {
                const [cus, ...nameParts] = key.split(' / ');
                const name = nameParts.join(' / ');
                
                const div = document.createElement('div');
                div.className = 'member-list-item';
                div.innerHTML = `
                    <span class="text-sm">
                        <span class="font-medium">${name}</span>
                        <span class="text-xs text-gray-500 block">${cus}</span>
                    </span>
                    <span class="font-bold text-red-600">${count} Check-ins</span>
                `;
                topList.appendChild(div);
            });

            if (sortedMembers.length === 0) {
                topList.innerHTML = '<p class="text-gray-500 text-center py-4">Keine Mitgliederdaten im gew√§hlten Zeitraum.</p>';
            }
        }

        // ==================== COMPARE TAB ====================
        function setupCompareTab() {
            const periodTypes = document.querySelectorAll('.compare-period-type');
            periodTypes.forEach(select => {
                select.addEventListener('change', (e) => {
                    const period = e.target.dataset.period; // 'A' or 'B'
                    const type = e.target.value;
                    document.getElementById(`year-selector-${period}`).classList.toggle('hidden', type === 'all');
                    document.getElementById(`quarter-selector-${period}`).classList.toggle('hidden', type !== 'quarter');
                    document.getElementById(`month-selector-${period}`).classList.toggle('hidden', type !== 'month');
                });
            });
            
            // Populate year selectors
            const years = [...new Set(allCheckins.map(c => c.timestamp.getFullYear()))].sort((a, b) => b - a);
            const yearHtml = years.map(y => `<option value="${y}">${y}</option>`).join('');
            document.getElementById('year-select-A').innerHTML = yearHtml;
            document.getElementById('year-select-B').innerHTML = yearHtml;
            
            // Run Compare
            document.getElementById('run-compare-btn').addEventListener('click', renderCompareResults);
        }
        
        function getCheckinsForPeriod(period) {
            const periodType = document.getElementById(`period-type-${period}`).value;
            
            if (periodType === 'all') {
                return [...allCheckins];
            }
            
            const year = parseInt(document.getElementById(`year-select-${period}`).value);
            
            if (periodType === 'year') {
                return allCheckins.filter(c => c.timestamp.getFullYear() === year);
            } else if (periodType === 'quarter') {
                const quarter = document.getElementById(`quarter-select-${period}`).value;
                const qMap = { 'Q1': [0, 1, 2], 'Q2': [3, 4, 5], 'Q3': [6, 7, 8], 'Q4': [9, 10, 11] };
                const months = qMap[quarter];
                return allCheckins.filter(c => 
                    c.timestamp.getFullYear() === year && months.includes(c.timestamp.getMonth())
                );
            } else if (periodType === 'month') {
                const month = parseInt(document.getElementById(`month-select-${period}`).value) - 1;
                return allCheckins.filter(c => 
                    c.timestamp.getFullYear() === year && c.timestamp.getMonth() === month
                );
            }
            return [];
        }

        function calculateSimpleStats(checkins) {
            const stats = {
                total: checkins.length,
                male: 0,
                female: 0,
                avgDaily: 0,
                ageGroups: {}
            };
            AGE_GROUPS.forEach(group => stats.ageGroups[group] = 0);
            
            const dailyCounts = {};
            checkins.forEach(c => {
                if (c.gender === 'M√§nnlich') stats.male++;
                else if (c.gender === 'Weiblich') stats.female++;
                
                if (stats.ageGroups[c.ageGroup] !== undefined) {
                    stats.ageGroups[c.ageGroup]++;
                }
                
                dailyCounts[c.dateKey] = (dailyCounts[c.dateKey] || 0) + 1;
            });
            
            const daysCount = Object.keys(dailyCounts).length || 1;
            stats.avgDaily = (stats.total / daysCount);
            
            return stats;
        }

        function renderCompareResults() {
            const studioFilter = document.getElementById('compare-studio-filter').value;

            let checkinsA = getCheckinsForPeriod('A');
            let checkinsB = getCheckinsForPeriod('B');
            
            if (studioFilter !== 'all') {
                checkinsA = checkinsA.filter(c => c.studio === studioFilter);
                checkinsB = checkinsB.filter(c => c.studio === studioFilter);
            }

            const statsA = calculateSimpleStats(checkinsA);
            const statsB = calculateSimpleStats(checkinsB);

            const tbody = document.getElementById('compare-results-table');
            tbody.innerHTML = '';

            const renderRow = (metric, valueA, valueB, format = 'number') => {
                const change = calculatePercentChange(valueA, valueB);
                const isPositive = parseFloat(change) > 0;
                const isNegative = parseFloat(change) < 0;
                const changeColor = isPositive ? 'text-green-600' : (isNegative ? 'text-red-600' : 'text-gray-500');
                
                let valA = format === 'number' ? valueA.toLocaleString('de-DE') : valueA.toFixed(1);
                let valB = format === 'number' ? valueB.toLocaleString('de-DE') : valueB.toFixed(1);

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium">${metric}</td>
                        <td class="px-6 py-4">${valA}</td>
                        <td class="px-6 py-4">${valB}</td>
                        <td class="px-6 py-4 font-bold ${changeColor}">${change}</td>
                    </tr>
                `;
            };

            renderRow('Gesamt Check-ins', statsA.total, statsB.total);
            renderRow('√ò Check-ins / Tag', statsA.avgDaily, statsB.avgDaily, 'float');
            renderRow('M√§nner', statsA.male, statsB.male);
            renderRow('Frauen', statsA.female, statsB.female);
            
            AGE_GROUPS.forEach(group => {
                renderRow(`Altersgruppe: ${group}`, statsA.ageGroups[group], statsB.ageGroups[group]);
            });

            document.getElementById('compare-results-container').classList.remove('hidden');
        }


        // ==================== INSIGHTS TAB ====================
        function renderInsights() {
            const { checkins, studioStats } = analysisResults;
            const container = document.getElementById('insights-container');
            container.innerHTML = '';

            const insights = [];

            // 1. Gender Imbalance
            const totalMales = checkins.filter(c => c.gender === 'M√§nnlich').length;
            const totalFemales = checkins.filter(c => c.gender === 'Weiblich').length;
            if ((totalMales + totalFemales) > 0) {
                const avgFemalePercent = (totalFemales / (totalMales + totalFemales)) * 100;
                Object.keys(studioStats).forEach(studio => {
                    if (studioStats[studio] < 50) return; // Ignore small studios
                    const studioCheckins = checkins.filter(c => c.studio === studio);
                    const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                    const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                    const total = males + females;
                    if (total === 0) return;
                    
                    const femalePercent = (females / total) * 100;

                    if (Math.abs(femalePercent - avgFemalePercent) > 10) {
                        const diff = femalePercent - avgFemalePercent;
                        insights.push({
                            type: diff < 0 ? 'warning' : 'info',
                            icon: 'üë•',
                            title: `${studio}: ${diff < 0 ? 'Unterdurchschnittlicher' : '√úberdurchschnittlicher'} Frauenanteil`,
                            description: `${femalePercent.toFixed(0)}% Frauen (Studio-Schnitt: ${avgFemalePercent.toFixed(0)}%)`,
                            action: diff < 0 ? 'Marketing-Aktionen f√ºr Frauen in diesem Studio pr√ºfen.' : 'St√§rken analysieren, evtl. auf andere Studios √ºbertragen.'
                        });
                    }
                });
            }

            // 2. Peak Hour
            const { hourlyStats } = analysisResults;
            const hourTotals = {};
            for(let day=0; day<7; day++) {
                for(let hour=6; hour<24; hour++) {
                    const key = `${day}-${hour}`;
                    const count = hourlyStats[key] || 0;
                    hourTotals[hour] = (hourTotals[hour] || 0) + count;
                }
            }
            const peakHour = Object.entries(hourTotals).sort((a, b) => b[1] - a[1])[0];
            if (peakHour) {
                insights.push({
                    type: 'success',
                    icon: '‚è∞',
                    title: `Beliebteste Zeit: ${peakHour[0]}:00 - ${peakHour[0]}:59 Uhr`,
                    description: `Die Stunde um ${peakHour[0]} Uhr ist √ºber alle Wochentage hinweg die meistbesuchte.`,
                    action: 'Stelle sicher, dass zu dieser Zeit ausreichend Personal f√ºr Betreuung und Sauberkeit vor Ort ist.'
                });
            }
            
            // 3. Underused Age Group
            const ageGroupTotals = {};
            AGE_GROUPS.forEach(group => ageGroupTotals[group] = 0);
            checkins.forEach(c => {
                if (ageGroupTotals[c.ageGroup] !== undefined) {
                    ageGroupTotals[c.ageGroup]++;
                }
            });
            const sortedAgeGroups = Object.entries(ageGroupTotals).sort((a,b) => a[1] - b[1]);
            const weakestGroup = sortedAgeGroups[0];
            if (weakestGroup && weakestGroup[1] > 0) {
                 insights.push({
                    type: 'info',
                    icon: 'üìà',
                    title: `Wachstumspotenzial: Gruppe ${weakestGroup[0]}`,
                    description: `Die Altersgruppe ${weakestGroup[0]} ist aktuell am schw√§chsten vertreten.`,
                    action: `Pr√ºfe, ob gezielte Angebote (z.B. "Senioren-Fit 60+" oder "Jugend-Rabatt <20") sinnvoll sind.`
                });
            }

            // Render
            const typeStyles = {
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800',
                success: 'bg-green-50 border-green-200 text-green-800'
            };

            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-2 ${typeStyles[insight.type]}`;
                div.innerHTML = `
                    <div class="flex items-start">
                        <div class="text-3xl mr-4">${insight.icon}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1">${insight.title}</h4>
                            <p class="text-sm text-gray-700 mb-2">${insight.description}</p>
                            <p class="text-xs text-gray-600">üìç <strong>Empfehlung:</strong> ${insight.action}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine besonderen Auff√§lligkeiten gefunden. Alle Metriken im normalen Bereich! ‚úÖ</p>';
            }
        }


        // ==================== GITHUB SYNC ====================
        function setupGitHubSync() {
            document.getElementById('sync-github-btn').addEventListener('click', () => {
                loadGitHubConfig();
                showModal('github-sync-modal');
            });
            document.getElementById('github-load-btn').addEventListener('click', loadFromGitHub);
            document.getElementById('github-save-btn').addEventListener('click', saveToGitHub);
        }

        function loadGitHubConfig() {
            const config = JSON.parse(localStorage.getItem('githubConfig'));
            if (config) {
                document.getElementById('github-owner').value = config.owner || '';
                document.getElementById('github-repo').value = config.repo || '';
                GITHUB_CONFIG.owner = config.owner;
                GITHUB_CONFIG.repo = config.repo;
            }
        }

        function updateGitHubConfig() {
            GITHUB_CONFIG.owner = document.getElementById('github-owner').value.trim();
            GITHUB_CONFIG.repo = document.getElementById('github-repo').value.trim();
            GITHUB_CONFIG.token = document.getElementById('github-token').value.trim();
            
            localStorage.setItem('githubConfig', JSON.stringify({
                owner: GITHUB_CONFIG.owner,
                repo: GITHUB_CONFIG.repo
            }));
        }

        function setGitHubStatus(status, isError = false) {
            const statusEl = document.getElementById('github-status');
            const errorEl = document.getElementById('github-error');
            
            statusEl.value = status;
            errorEl.classList.add('hidden');
            
            if (isError) {
                errorEl.textContent = status;
                errorEl.classList.remove('hidden');
            }
        }

        async function loadFromGitHub() {
            updateGitHubConfig();
            setGitHubStatus('Lade Daten...');
            
            const { owner, repo, token, dataFile } = GITHUB_CONFIG;
            if (!owner || !repo || !token) {
                setGitHubStatus('Fehler: Besitzer, Repo und Token sind erforderlich.', true);
                return;
            }

            // v5.11: Fetch the JSON descriptor to get content AND SHA in one call
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${dataFile}`;
            
            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json' // Get JSON descriptor
                    }
                });

                if (!response.ok) {
                    throw new Error(`Fehler: ${response.status} ${response.statusText}`);
                }

                const fileData = await response.json();
                
                if (fileData.content) {
                    // Decode Base64 content
                    const rawJson = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(rawJson);

                    if (data.allCheckins && data.monthlyTrends) {
                        allCheckins = data.allCheckins || [];
                        monthlyTrends = data.monthlyTrends || [];
                        
                        // v5.10 Fix: Re-hydrate Date objects
                        allCheckins.forEach(c => {
                            c.timestamp = new Date(c.timestamp);
                        });
                        
                        if (allCheckins.length > 0) {
                            lastEventDate = new Date(Math.max(...allCheckins.map(c => c.timestamp)));
                        } else {
                            lastEventDate = null;
                        }

                        isLoadedFromGitHub = true;
                        GITHUB_CONFIG.sha = fileData.sha; // v5.11: Store the SHA
                        setGitHubStatus(`Geladen! (${allCheckins.length} Eintr√§ge)`);
                        console.log('Load successful. SHA:', fileData.sha);

                        // Process and render
                        filteredCheckins = [...allCheckins];
                        processAnalysis();
                        setupTimeFilters();
                        setupAllStudioFilters();
                        setupCompareTab();
                        
                        document.getElementById('initial-load-section').classList.add('hidden');
                        document.getElementById('initial-loading').classList.add('hidden');
                        document.getElementById('results-section').classList.remove('hidden');
                        document.getElementById('time-filter-section').classList.remove('hidden');
                        document.getElementById('export-btn').classList.remove('hidden');
                        document.getElementById('sync-github-btn').classList.remove('hidden');
                        document.getElementById('add-data-btn').classList.remove('hidden');
                        
                        setTimeout(() => closeModal('github-sync-modal'), 1000);
                    } else {
                        setGitHubStatus('Fehler: Geladene Daten haben ein ung√ºltiges Format.', true);
                    }
                } else {
                    setGitHubStatus('Fehler: Datei-Inhalt ist leer oder nicht gefunden.', true);
                }

            } catch (err) {
                console.error('GitHub Load Error:', err);
                setGitHubStatus(err.message, true);
                document.getElementById('initial-loading').classList.add('hidden');
                document.getElementById('initial-load-section').classList.remove('hidden');async function loadFromGitHub() {
¬† ¬† ¬† ¬† ¬† ¬† updateGitHubConfig();
¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus('Lade Daten...');
¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† const { owner, repo, token, dataFile } = GITHUB_CONFIG;
¬† ¬† ¬† ¬† ¬† ¬† if (!owner || !repo || !token) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus('Fehler: Besitzer, Repo und Token sind erforderlich.', true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† const url = `https://api.github.com/repos/${owner}/${repo}/contents/${dataFile}`;
¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const response = await fetch(url, {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† headers: {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 'Authorization': `token ${token}`,
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 'Accept': 'application/vnd.github.v3+json'
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!response.ok) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† throw new Error(`Fehler: ${response.status} ${response.statusText}`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const fileData = await response.json();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let rawJson; // Variable f√ºr den rohen JSON-Text

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (fileData.content) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Fall 1: Datei < 1MB, Inhalt ist Base64-codiert
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.log('Lade kleine Datei (Base64)...');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† rawJson = decodeURIComponent(escape(atob(fileData.content)));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (fileData.type === 'file' && fileData.download_url) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Fall 2: Datei > 1MB, Inhalt muss via download_url geladen werden
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.log('Lade gro√üe Datei (via download_url)...');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus('Gro√üe Datei wird geladen...');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const downloadResponse = await fetch(fileData.download_url, {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† headers: { 'Authorization': `token ${token}` }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!downloadResponse.ok) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† throw new Error(`Fehler beim Herunterladen der Datei: ${downloadResponse.statusText}`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† rawJson = await downloadResponse.text();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (Array.isArray(fileData)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Fall 3: Der Pfad ist ein Verzeichnis
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†throw new Error(`Fehler: Der Pfad '${dataFile}' ist ein Verzeichnis, keine Datei.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Fall 4: Weder Inhalt noch Download-URL gefunden
f¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† throw new Error('Fehler: Datei-Inhalt ist leer oder nicht gefunden.');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Gemeinsame Verarbeitung (nachdem rawJson geladen wurde)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const data = JSON.parse(rawJson);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (data.allCheckins && data.monthlyTrends) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† allCheckins = data.allCheckins || [];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† monthlyTrends = data.monthlyTrends || [];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // v5.10 Fix: Datums-Objekte wiederherstellen
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† allCheckins.forEach(c => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† c.timestamp = new Date(c.timestamp);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (allCheckins.length > 0) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lastEventDate = new Date(Math.max(...allCheckins.map(c => c.timestamp)));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† lastEventDate = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† isLoadedFromGitHub = true;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† GITHUB_CONFIG.sha = fileData.sha; // SHA speichern (wichtig f√ºr n√§chstes Speichern)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus(`Geladen! (${allCheckins.length} Eintr√§ge)`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.log('Load successful. SHA:', fileData.sha);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Verarbeiten und Rendern
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† filteredCheckins = [...allCheckins];
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† processAnalysis();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setupTimeFilters();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setupAllStudioFilters();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setupCompareTab();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† _ ¬† ¬† ¬† document.getElementById('initial-load-section').classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('initial-loading').classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('results-section').classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('time-filter-section').classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('export-btn').classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('sync-github-btn').classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('add-data-btn').classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => closeModal('github-sync-modal'), 1000);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus('Fehler: Geladene Daten haben ein ung√ºltiges Format.', true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
¬† ¬† ¬† ¬† ¬† ¬† } catch (err) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error('GitHub Load Error:', err);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setGitHubStatus(err.message, true);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('initial-loading').classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('initial-load-
            }
        }

        async function getFileSha() {
            // This function is now redundant as loadFromGitHub gets the SHA
            // but we keep it in case saveToGitHub is called first on a new file.
            // ... (Logic to get SHA if needed) ...
            // For v5.11, we rely on loadFromGitHub to set the SHA.
            // If sha is null, saveToGitHub will create a new file.
        }

        async function saveToGitHub() {
            updateGitHubConfig();
            setGitHubStatus('Speichere...');
            
            const { owner, repo, token, dataFile, sha } = GITHUB_CONFIG;
            if (!owner || !repo || !token) {
                setGitHubStatus('Fehler: Besitzer, Repo und Token sind erforderlich.', true);
                return;
            }

            // v5.11: If SHA is null, we must check if file exists before saving
            // to prevent the 422 error.
            let currentSha = sha;
            if (!currentSha) {
                // Try to get SHA just in case file exists but we don't know it
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${dataFile}`;
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (response.ok) {
                        const fileData = await response.json();
                        currentSha = fileData.sha; // Found it! Use this SHA for update.
                        console.log('SHA was null, but found existing file SHA:', currentSha);
                    } else if (response.status !== 404) {
                        // It's not a 404, so it's some other error
                        throw new Error(`SHA-Pr√ºffehler: ${response.statusText}`);
                    }
                    // If 404, currentSha remains null, and we create a new file.
                } catch (err) {
                    setGitHubStatus(err.message, true);
                    return;
                }
            }
            
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${dataFile}`;
            const dataToSave = JSON.stringify({ allCheckins, monthlyTrends }, null, 2);
            // v5.11: UTF-8 safe Base64 encoding
            const content = btoa(unescape(encodeURIComponent(dataToSave)));
            
            const body = {
                message: `Update SAMS GYM analysis data (${new Date().toISOString()})`,
                content: content,
                sha: currentSha // Use the SHA we just confirmed
            };
            
            if (!body.sha) {
                delete body.sha; // This is correct for CREATING a new file
            }

            console.log('Saving to GitHub...', { url, sha: body.sha, size: dataToSave.length });

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                console.log('GitHub Save Response Status:', response.status);

                if (response.ok || response.status === 200 || response.status === 201) {
                    const result = await response.json();
                    GITHUB_CONFIG.sha = result.content.sha; // Update SHA for next save
                    
                    setGitHubStatus(`Gespeichert! (${allCheckins.length} Eintr√§ge)`);
                    console.log('Save successful. New SHA:', result.content.sha);
                    
                    setTimeout(() => closeModal('github-sync-modal'), 1000);
                } else {
                    const error = await response.json();
                    console.error('GitHub Save Error:', error);
                    // v5.11: Check for the specific 422 SHA error
                    if (response.status === 422 && error.message.includes("sha wasn't supplied")) {
                         throw new Error(`422: SHA-Konflikt. Bitte 'Laden' Sie zuerst die Daten.`);
                    }
                    throw new Error(`${response.status} ${response.statusText}: ${error.message}`);
                }

            } catch (err) {
                console.error(err);
                setGitHubStatus(err.message, true);
            }
        }


        // ==================== HELPER FUNCTIONS ====================
        function parseGermanDate(dateString) {
            // Versucht TT.MM.JJJJ HH:MM:SS
            const parts = dateString.match(/(\d{2})\.(\d{2})\.(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
            if (parts) {
                // new Date(YYYY, MM-1, DD, HH, MM, SS)
                return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]);
            }
            
            // Fallback: Versucht Standard-Parsing (z.B. f√ºr ISO oder US-Formate)
            const date = new Date(dateString);
            if (!isNaN(date)) {
                return date;
            }
            
            return null; // Ung√ºltiges Format
        }

        function extractGender(name) {
            if (name.startsWith('Herr ')) return 'M√§nnlich';
            if (name.startsWith('Frau ')) return 'Weiblich';
            return 'Unknown';
        }

        function calculateAge(birthdateStr) {
            if (!birthdateStr) return null;
            
            let birth;
            // Versucht TT.MM.JJJJ
            let parts = birthdateStr.match(/(\d{2})\.(\d{2})\.(\d{4})/);
            if (parts) {
                birth = new Date(parts[3], parts[2] - 1, parts[1]);
            } else {
                // Fallback: Versucht Standard-Parsing (z.B. YYYY-MM-DD)
                birth = new Date(birthdateStr);
            }

            if (isNaN(birth)) return null;

            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function getAgeGroup(age) {
            if (age === null) return null;
            if (age < 20) return '<20';
            if (age < 40) return '20-40';
            if (age < 60) return '40-60';
            return '60+';
        }

        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function calculatePercentChange(start, end) {
            if (start === 0) {
                return end > 0 ? '+‚àû%' : '0.0%';
            }
            const change = ((end - start) / start) * 100;
            return (change > 0 ? '+' : '') + change.toFixed(1) + '%';
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupInitialLoad();
            setupFileHandlers();
            setupTabs();
            setupGitHubSync();
            
            // Lade GitHub-Config aus LocalStorage (aber nicht den Token)
            loadGitHubConfig(); 
        });

        // ==================== TAB SWITCHING ====================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    tabButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${targetTab}`).classList.add('active');

                    if (targetTab === 'compare' && allCheckins.length > 0) {
                        setupCompareTab(); // Lazy-init compare tab
                    }
                });
            });
        }
        
        // ==================== EXPORT ====================
        document.getElementById('export-btn').addEventListener('click', () => {
            // v5.10: Data is re-stringified with Date objects as ISO strings
            const dataStr = JSON.stringify({ allCheckins, monthlyTrends }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sams-gym-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
