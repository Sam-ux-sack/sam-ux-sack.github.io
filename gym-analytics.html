<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS GYM Analytics Dashboard v2</title>
    
    <meta name="theme-color" content="#DC2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'sams-red': '#DC2626',
                        'sams-black': '#1F2937',
                        'sams-gray': '#6B7280',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; height: 400px; }
        .chart-container-small { position: relative; height: 300px; }
        
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #DC2626;
            color: #DC2626;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .drag-over {
            background-color: #fee2e2 !important;
            border: 2px dashed #DC2626 !important;
        }

        /* Heatmap table styling */
        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            min-width: 50px;
        }
        .heatmap-header {
            background: #1F2937;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold" style="color: #DC2626;">
                        üèãÔ∏è SAMS GYM Analytics v2
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Analyse-Zeitraum: <span id="period-display" class="font-medium">-</span>
                    </p>
                </div>
                <div class="flex gap-2">
                    <button id="export-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg shadow transition">
                        üíæ Export
                    </button>
                    <button id="save-github-btn" class="hidden text-white px-4 py-2 rounded-lg shadow transition" style="background: #DC2626;">
                        ‚òÅÔ∏è Auf GitHub speichern
                    </button>
                </div>
            </div>

            <!-- Time Period Filter -->
            <div id="time-filter-section" class="hidden bg-white p-4 rounded-xl shadow-md mb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Zeitraum w√§hlen:</label>
                        <select id="period-type" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="all">Gesamter Zeitraum</option>
                            <option value="year">Jahr</option>
                            <option value="quarter">Quartal</option>
                            <option value="month">Monat</option>
                        </select>
                    </div>
                    <div id="year-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                        <select id="year-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        </select>
                    </div>
                    <div id="quarter-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                        <select id="quarter-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Okt-Dez)</option>
                        </select>
                    </div>
                    <div id="month-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Monat:</label>
                        <select id="month-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="1">Januar</option>
                            <option value="2">Februar</option>
                            <option value="3">M√§rz</option>
                            <option value="4">April</option>
                            <option value="5">Mai</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Dezember</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="apply-filter-btn" class="text-white px-6 py-2 rounded-lg shadow transition font-semibold" style="background: #DC2626;">
                            Filter anwenden
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Upload Section -->
        <div id="upload-section" class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">üìÅ Daten hochladen</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Zoho Contacts Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="contacts-drop-zone">
                    <input type="file" id="contacts-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3" style="color: #DC2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="font-semibold mb-1">Zoho Kontakte (AllContacts.csv)</p>
                        <p class="text-sm text-gray-500">Klicken oder Drag & Drop</p>
                        <p id="contacts-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>

                <!-- SALTO Events Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="events-drop-zone">
                    <input type="file" id="events-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="font-semibold mb-1">SALTO Ereignisse (Ereignisliste.csv)</p>
                        <p class="text-sm text-gray-500">Klicken oder Drag & Drop</p>
                        <p id="events-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>
            </div>

            <button id="analyze-btn" class="hidden w-full mt-6 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                üöÄ Daten analysieren
            </button>

            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p class="mt-2 text-gray-600">Daten werden analysiert...</p>
            </div>
        </div>

        <!-- Results Section (hidden by default) -->
        <div id="results-section" class="hidden">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Gesamt Check-ins</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-total-checkins">0</p>
                            <p class="text-xs mt-1" style="color: #DC2626;" id="stat-checkins-trend">-</p>
                        </div>
                        <div class="text-4xl">üìä</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Durchschn. Check-ins/Tag</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-avg-daily">0</p>
                            <p class="text-xs text-gray-500 mt-1">√ò pro Tag</p>
                        </div>
                        <div class="text-4xl">üìÖ</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Beliebtestes Studio</p>
                            <p class="text-xl font-bold text-gray-900" id="stat-top-studio">-</p>
                            <p class="text-xs text-gray-500 mt-1" id="stat-top-studio-percent">-</p>
                        </div>
                        <div class="text-4xl">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="flex">
                        <button class="tab-button active px-6 py-4 font-semibold" data-tab="overview">
                            üìä √úbersicht
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="demographics">
                            üë• Demographics
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="utilization">
                            ‚è∞ Auslastung
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="trends">
                            üìà Trends
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold" data-tab="insights">
                            üí° Insights
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active">
                        <h3 class="text-xl font-bold mb-4">Studio-Auslastung</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-studios"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">T√§gliche Auslastung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-daily"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Tab -->
                    <div id="tab-demographics" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Mitglieder-Demographics</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio Filter:</label>
                            <select id="demo-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Geschlechterverteilung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Altersgruppen</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-age"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Studio-Vergleich</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Studio</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Check-ins</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">M√§nner</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Frauen</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">√ò Alter</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studio-comparison-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Utilization Tab -->
                    <div id="tab-utilization" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Auslastung nach Studio & Zeit</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="util-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Auslastung nach Wochentag</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-weekday-util"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Peak Hours Heatmap</h4>
                                <div class="overflow-x-auto">
                                    <table id="heatmap-table" class="min-w-full">
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trends Tab -->
                    <div id="tab-trends" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Trend-Analyse √ºber Zeit</h3>
                        
                        <div id="trends-no-data" class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 text-center">
                            <p class="text-lg font-semibold text-blue-900 mb-2">üìä Historische Daten werden geladen...</p>
                            <p class="text-sm text-blue-700 mb-4">Speichere diese Analyse auf GitHub, um Trends √ºber Zeit zu verfolgen.</p>
                            <button id="load-history-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow transition">
                                üìÇ Historische Daten laden
                            </button>
                        </div>

                        <div id="trends-content" class="hidden">
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio (Zeitverlauf)</h4>
                                <div class="chart-container">
                                    <canvas id="chart-studio-trends"></canvas>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3">Geschlechter-Entwicklung</h4>
                                    <div class="chart-container-small">
                                        <canvas id="chart-gender-trends"></canvas>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3">Altersgruppen-Entwicklung</h4>
                                    <div class="chart-container-small">
                                        <canvas id="chart-age-trends"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">‚ö†Ô∏è Erkannte Trends & R√ºckg√§nge</h4>
                                <div id="trend-alerts-container" class="space-y-3">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div id="tab-insights" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Actionable Insights & Empfehlungen</h3>
                        <div id="insights-container" class="space-y-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const GITHUB_CONFIG = {
            owner: 'sam-ux-sack',
            repo: 'sams-gym-data',
            token: null
        };

        // √ÑNDERUNG #3: Nur diese Hauptt√ºren ber√ºcksichtigen
        const MAIN_DOORS = {
            'Susten Hauptt√ºre': 'Susten GYM',
            'Strongman rechts': 'Susten CrossGYM',
            'Visp-S√ºd Eingang': 'Visp-S√ºd',
            'Visp-Center Eingang': 'Visp-Center'
        };

        // ==================== DATA STORAGE ====================
        let contactsData = null;
        let eventsData = null;
        let allCheckins = [];  // All checkins without filter
        let filteredCheckins = [];  // Filtered by time period
        let analysisResults = null;
        let historicalData = [];
        let charts = {};

        // ==================== FILE UPLOAD HANDLERS ====================
        function setupFileHandlers() {
            const contactsZone = document.getElementById('contacts-drop-zone');
            const contactsInput = document.getElementById('contacts-input');
            
            contactsZone.addEventListener('click', () => contactsInput.click());
            contactsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'contacts'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                contactsZone.addEventListener(eventName, preventDefaults);
            });
            contactsZone.addEventListener('dragover', () => contactsZone.classList.add('drag-over'));
            contactsZone.addEventListener('dragleave', () => contactsZone.classList.remove('drag-over'));
            contactsZone.addEventListener('drop', (e) => {
                contactsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'contacts');
            });

            const eventsZone = document.getElementById('events-drop-zone');
            const eventsInput = document.getElementById('events-input');
            
            eventsZone.addEventListener('click', () => eventsInput.click());
            eventsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'events'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                eventsZone.addEventListener(eventName, preventDefaults);
            });
            eventsZone.addEventListener('dragover', () => eventsZone.classList.add('drag-over'));
            eventsZone.addEventListener('dragleave', () => eventsZone.classList.remove('drag-over'));
            eventsZone.addEventListener('drop', (e) => {
                eventsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'events');
            });

            document.getElementById('analyze-btn').addEventListener('click', analyzeData);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFileSelect(file, type) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Bitte eine CSV-Datei ausw√§hlen!');
                return;
            }

            const statusEl = document.getElementById(`${type}-status`);
            statusEl.textContent = `‚úì ${file.name}`;
            statusEl.classList.add('text-green-600');

            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    if (type === 'contacts') {
                        contactsData = results.data;
                        console.log('Contacts loaded:', contactsData.length);
                    } else {
                        eventsData = results.data;
                        console.log('Events loaded:', eventsData.length);
                    }
                    
                    if (contactsData && eventsData) {
                        document.getElementById('analyze-btn').classList.remove('hidden');
                    }
                }
            });
        }

        // ==================== DATA ANALYSIS ====================
        function analyzeData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('analyze-btn').classList.add('hidden');

            setTimeout(() => {
                const contactsLookup = {};
                contactsData.forEach(contact => {
                    const cusNumber = contact['Kundennummer'] || contact['CUSTOMER_ID'];
                    if (cusNumber) {
                        contactsLookup[cusNumber] = {
                            name: contact['Name'] || '',
                            birthdate: contact['Geburtsdatum'] || '',
                            gender: extractGender(contact['Name'] || ''),
                            age: calculateAge(contact['Geburtsdatum'] || '')
                        };
                    }
                });

                allCheckins = [];
                eventsData.forEach(event => {
                    const cols = Object.values(event);
                    if (cols.length < 5) return;

                    const timestamp = cols[0];
                    const doorName = cols[2];
                    const cusNumber = cols[4];

                    // √ÑNDERUNG #3: Nur Hauptt√ºren ber√ºcksichtigen
                    if (!MAIN_DOORS[doorName]) return;
                    if (!cusNumber || !cusNumber.startsWith('CUS-')) return;

                    const studio = MAIN_DOORS[doorName];
                    const contact = contactsLookup[cusNumber] || {};

                    const date = new Date(timestamp);
                    if (isNaN(date)) return;

                    const dateKey = date.toISOString().split('T')[0];
                    const hour = date.getHours();
                    const day = date.getDay();

                    allCheckins.push({
                        timestamp: date,
                        studio,
                        cusNumber,
                        gender: contact.gender || 'Unknown',
                        age: contact.age || null,
                        dateKey,
                        hour,
                        day
                    });
                });

                allCheckins.sort((a, b) => a.timestamp - b.timestamp);

                // √ÑNDERUNG #2: Initially show all data, filter controls visible
                filteredCheckins = [...allCheckins];
                processAnalysis();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('time-filter-section').classList.remove('hidden');
                document.getElementById('export-btn').classList.remove('hidden');
                document.getElementById('save-github-btn').classList.remove('hidden');
                document.getElementById('upload-section').classList.add('hidden');

                setupTimeFilters();
            }, 500);
        }

        function processAnalysis() {
            const studioStats = {};
            const dailyStats = {};
            const hourlyStats = {};
            const weekdayStats = {};

            filteredCheckins.forEach(c => {
                studioStats[c.studio] = (studioStats[c.studio] || 0) + 1;
                dailyStats[c.dateKey] = (dailyStats[c.dateKey] || 0) + 1;
                
                const hourKey = `${c.day}-${c.hour}`;
                hourlyStats[hourKey] = (hourlyStats[hourKey] || 0) + 1;
                
                weekdayStats[c.day] = (weekdayStats[c.day] || 0) + 1;
            });

            const startDate = filteredCheckins[0]?.timestamp;
            const endDate = filteredCheckins[filteredCheckins.length - 1]?.timestamp;

            analysisResults = {
                checkins: filteredCheckins,
                studioStats,
                dailyStats,
                hourlyStats,
                weekdayStats,
                startDate,
                endDate
            };

            renderResults();
        }

        // ==================== TIME FILTERS (√ÑNDERUNG #2) ====================
        function setupTimeFilters() {
            const periodType = document.getElementById('period-type');
            const yearSelector = document.getElementById('year-selector');
            const quarterSelector = document.getElementById('quarter-selector');
            const monthSelector = document.getElementById('month-selector');
            const applyBtn = document.getElementById('apply-filter-btn');

            // Populate year selector
            const years = [...new Set(allCheckins.map(c => c.timestamp.getFullYear()))].sort();
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            periodType.addEventListener('change', () => {
                const type = periodType.value;
                yearSelector.classList.toggle('hidden', type === 'all');
                quarterSelector.classList.toggle('hidden', type !== 'quarter');
                monthSelector.classList.toggle('hidden', type !== 'month');
            });

            applyBtn.addEventListener('click', applyTimeFilter);
        }

        function applyTimeFilter() {
            const periodType = document.getElementById('period-type').value;
            
            if (periodType === 'all') {
                filteredCheckins = [...allCheckins];
            } else {
                const year = parseInt(document.getElementById('year-select').value);
                
                if (periodType === 'year') {
                    filteredCheckins = allCheckins.filter(c => c.timestamp.getFullYear() === year);
                } else if (periodType === 'quarter') {
                    const quarter = document.getElementById('quarter-select').value;
                    const qMap = { 'Q1': [0, 1, 2], 'Q2': [3, 4, 5], 'Q3': [6, 7, 8], 'Q4': [9, 10, 11] };
                    const months = qMap[quarter];
                    filteredCheckins = allCheckins.filter(c => 
                        c.timestamp.getFullYear() === year && months.includes(c.timestamp.getMonth())
                    );
                } else if (periodType === 'month') {
                    const month = parseInt(document.getElementById('month-select').value) - 1;
                    filteredCheckins = allCheckins.filter(c => 
                        c.timestamp.getFullYear() === year && c.timestamp.getMonth() === month
                    );
                }
            }

            processAnalysis();
        }

        // ==================== HELPER FUNCTIONS ====================
        function extractGender(name) {
            if (name.startsWith('Herr')) return 'M√§nnlich';
            if (name.startsWith('Frau')) return 'Weiblich';
            return 'Unknown';
        }

        function calculateAge(birthdate) {
            if (!birthdate) return null;
            const birth = new Date(birthdate);
            if (isNaN(birth)) return null;
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // ==================== RENDER RESULTS ====================
        function renderResults() {
            const { checkins, studioStats, dailyStats, startDate, endDate } = analysisResults;

            document.getElementById('period-display').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;

            // √ÑNDERUNG #4: Removed "Aktive Mitglieder" stat
            document.getElementById('stat-total-checkins').textContent = checkins.length.toLocaleString('de-DE');
            
            const daysCount = Object.keys(dailyStats).length;
            const avgDaily = Math.round(checkins.length / daysCount);
            document.getElementById('stat-avg-daily').textContent = avgDaily.toLocaleString('de-DE');

            const topStudio = Object.entries(studioStats).sort((a, b) => b[1] - a[1])[0];
            if (topStudio) {
                document.getElementById('stat-top-studio').textContent = topStudio[0];
                const percent = ((topStudio[1] / checkins.length) * 100).toFixed(0);
                document.getElementById('stat-top-studio-percent').textContent = `${percent}% der Check-ins`;
            }

            renderStudioChart();
            renderDailyChart();
            renderDemographicsCharts();
            renderStudioComparisonTable();
            renderUtilizationCharts();
            renderHeatmapTable();
            renderInsights();
        }

        // ==================== CHARTS ====================
        function renderStudioChart() {
            const { studioStats } = analysisResults;
            const ctx = document.getElementById('chart-studios');
            
            if (charts.studios) charts.studios.destroy();
            
            const sorted = Object.entries(studioStats).sort((a, b) => b[1] - a[1]);
            
            charts.studios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Check-ins',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => value.toLocaleString('de-DE'),
                            color: '#1F2937',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDailyChart() {
            const { dailyStats } = analysisResults;
            const ctx = document.getElementById('chart-daily');
            
            if (charts.daily) charts.daily.destroy();
            
            const sorted = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0]));
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d[0]);
                        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Check-ins pro Tag',
                        data: sorted.map(d => d[1]),
                        borderColor: '#DC2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderDemographicsCharts() {
            // √ÑNDERUNG #5: Setup studio filter properly
            const { studioStats, checkins } = analysisResults;
            const filterSelect = document.getElementById('demo-studio-filter');
            filterSelect.innerHTML = '<option value="all">Alle Studios</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });

            // Initial render
            updateDemographicsCharts('all');

            // √ÑNDERUNG #5: Make filter work
            filterSelect.addEventListener('change', (e) => {
                updateDemographicsCharts(e.target.value);
            });
        }

        function updateDemographicsCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            // Gender chart
            const genderCounts = { 'M√§nnlich': 0, 'Weiblich': 0 };
            checkins.forEach(c => genderCounts[c.gender]++);
            
            const genderCtx = document.getElementById('chart-gender');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['M√§nner', 'Frauen'],
                    datasets: [{
                        data: [genderCounts['M√§nnlich'], genderCounts['Weiblich']],
                        backgroundColor: ['#1F2937', '#DC2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((value / sum) * 100).toFixed(0);
                                return `${percent}%`;
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 16 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Age chart
            const ageCounts = { '<20': 0, '20-30': 0, '30-40': 0, '40+': 0 };
            checkins.forEach(c => {
                if (c.age === null) return;
                if (c.age < 20) ageCounts['<20']++;
                else if (c.age < 30) ageCounts['20-30']++;
                else if (c.age < 40) ageCounts['30-40']++;
                else ageCounts['40+']++;
            });

            const ageCtx = document.getElementById('chart-age');
            if (charts.age) charts.age.destroy();
            
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageCounts),
                    datasets: [{
                        label: 'Check-ins',
                        data: Object.values(ageCounts),
                        backgroundColor: '#6B7280'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#1F2937',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderStudioComparisonTable() {
            const { checkins, studioStats } = analysisResults;
            const tbody = document.getElementById('studio-comparison-table');
            tbody.innerHTML = '';

            const studios = Object.keys(studioStats);
            
            studios.forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                const total = males + females;
                
                const ages = studioCheckins.map(c => c.age).filter(a => a !== null);
                const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${studio}</td>
                    <td class="px-4 py-3">${studioStats[studio].toLocaleString('de-DE')}</td>
                    <td class="px-4 py-3">${((males / total) * 100).toFixed(0)}%</td>
                    <td class="px-4 py-3">${((females / total) * 100).toFixed(0)}%</td>
                    <td class="px-4 py-3">${avgAge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== UTILIZATION CHARTS (√ÑNDERUNG #6) ====================
        function renderUtilizationCharts() {
            const { studioStats } = analysisResults;
            const filterSelect = document.getElementById('util-studio-filter');
            filterSelect.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });

            updateUtilizationCharts('all');

            filterSelect.addEventListener('change', (e) => {
                updateUtilizationCharts(e.target.value);
                renderHeatmapTable(e.target.value);
            });
        }

        function updateUtilizationCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            // Weekday utilization
            const weekdayStats = {};
            checkins.forEach(c => {
                weekdayStats[c.day] = (weekdayStats[c.day] || 0) + 1;
            });

            const ctx = document.getElementById('chart-weekday-util');
            if (charts.weekdayUtil) charts.weekdayUtil.destroy();

            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const data = [0, 1, 2, 3, 4, 5, 6].map(d => weekdayStats[d] || 0);

            charts.weekdayUtil = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Check-ins',
                        data: data,
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#1F2937',
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // ==================== HEATMAP TABLE (√ÑNDERUNG #7) ====================
        function renderHeatmapTable(studioFilter = 'all') {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const hourlyStats = {};
            checkins.forEach(c => {
                const key = `${c.day}-${c.hour}`;
                hourlyStats[key] = (hourlyStats[key] || 0) + 1;
            });

            const table = document.getElementById('heatmap-table');
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

            // Find max for color scaling
            const maxCount = Math.max(...Object.values(hourlyStats));

            let html = '<thead><tr class="heatmap-header"><th class="heatmap-cell">Uhrzeit</th>';
            dayNames.forEach(day => {
                html += `<th class="heatmap-cell">${day}</th>`;
            });
            html += '</tr></thead><tbody>';

            // Hours 6-23 (typical gym hours)
            for (let hour = 6; hour <= 23; hour++) {
                html += `<tr><td class="heatmap-cell font-bold">${hour}:00</td>`;
                for (let day = 0; day < 7; day++) {
                    const key = `${day}-${hour}`;
                    const count = hourlyStats[key] || 0;
                    const intensity = count > 0 ? (count / maxCount) : 0;
                    const bgColor = count === 0 ? '#f9fafb' : `rgba(220, 38, 38, ${0.2 + intensity * 0.8})`;
                    const textColor = intensity > 0.5 ? '#fff' : '#1F2937';
                    html += `<td class="heatmap-cell" style="background-color: ${bgColor}; color: ${textColor};">${count > 0 ? count : '-'}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderInsights() {
            const { checkins, studioStats } = analysisResults;
            const container = document.getElementById('insights-container');
            container.innerHTML = '';

            const insights = [];

            const totalMales = checkins.filter(c => c.gender === 'M√§nnlich').length;
            const totalFemales = checkins.filter(c => c.gender === 'Weiblich').length;
            const avgFemalePercent = (totalFemales / (totalMales + totalFemales)) * 100;

            Object.keys(studioStats).forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                const femalePercent = (females / (males + females)) * 100;

                if (Math.abs(femalePercent - avgFemalePercent) > 8) {
                    const diff = femalePercent - avgFemalePercent;
                    insights.push({
                        type: diff < 0 ? 'warning' : 'info',
                        icon: 'üë•',
                        title: `${studio}: ${diff < 0 ? 'Wenig' : 'Viele'} Frauen`,
                        description: `${femalePercent.toFixed(0)}% Frauen (Durchschnitt: ${avgFemalePercent.toFixed(0)}%)`,
                        action: diff < 0 ? 'Gezielte Marketing-Kampagne f√ºr Frauen empfohlen' : 'Gute Geschlechterbalance beibehalten'
                    });
                }
            });

            const { hourlyStats } = analysisResults;
            const hourTotals = {};
            Object.entries(hourlyStats).forEach(([key, count]) => {
                const hour = key.split('-')[1];
                hourTotals[hour] = (hourTotals[hour] || 0) + count;
            });
            const peakHour = Object.entries(hourTotals).sort((a, b) => b[1] - a[1])[0];
            if (peakHour) {
                insights.push({
                    type: 'success',
                    icon: '‚è∞',
                    title: `Peak Hour: ${peakHour[0]}:00 Uhr`,
                    description: `${peakHour[1]} Check-ins w√§hrend dieser Stunde`,
                    action: 'Personal-Planung entsprechend anpassen'
                });
            }

            const youngCheckins = checkins.filter(c => c.age && c.age < 20).length;
            const youngPercent = (youngCheckins / checkins.length) * 100;
            if (youngPercent > 15) {
                insights.push({
                    type: 'info',
                    icon: 'üìà',
                    title: 'Hoher Anteil junger Mitglieder',
                    description: `${youngPercent.toFixed(0)}% der Check-ins von unter 20-J√§hrigen`,
                    action: 'Jugend-Angebote und Social Media Marketing verst√§rken'
                });
            }

            const typeStyles = {
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-blue-50 border-blue-200',
                success: 'bg-green-50 border-green-200'
            };

            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-2 ${typeStyles[insight.type]}`;
                div.innerHTML = `
                    <div class="flex items-start">
                        <div class="text-3xl mr-4">${insight.icon}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1">${insight.title}</h4>
                            <p class="text-sm text-gray-700 mb-2">${insight.description}</p>
                            <p class="text-xs text-gray-600">üìç <strong>Empfehlung:</strong> ${insight.action}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine besonderen Auff√§lligkeiten gefunden. Alle Metriken im normalen Bereich! ‚úÖ</p>';
            }
        }

        // ==================== TAB SWITCHING ====================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    tabButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                });
            });
        }

        // ==================== GITHUB & TRENDS (Placeholder) ====================
        async function saveToGitHub() {
            alert('GitHub Speicherung: Funktion wird implementiert.\n\nDu kannst aktuell die Daten als JSON exportieren.');
        }

        async function loadHistoricalData() {
            alert('Historische Daten: Funktion wird implementiert.\n\nSpeichere zuerst mehrere Wochen-Analysen.');
        }

        function setupExport() {
            document.getElementById('export-btn').addEventListener('click', () => {
                const dataStr = JSON.stringify(analysisResults, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sams-gym-analysis-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            });

            document.getElementById('save-github-btn').addEventListener('click', saveToGitHub);
            document.getElementById('load-history-btn').addEventListener('click', loadHistoricalData);
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupFileHandlers();
            setupTabs();
            setupExport();
        });
    </script>
</body>
</html>
