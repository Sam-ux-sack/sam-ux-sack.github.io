<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v6.0: Studio Detail Tab, Studio Comparison, Enhanced Filters, Local Save -->
    <title>SAMS GYM Analytics Dashboard v6.0</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#DC2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICAgIm5hbWUiOiAiU0FNUyBHWU0gQW5hbHl0aWNzIiwKICAgICJzaG9ydF9uYW1lIjogIkdZTSBBbmFseXRpY3MiLAogICAgInRoZW1lX2NvbG9yIjogIiNEQzI2MjYiLAogICAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y5ZmFmYiIsCiAgICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIgp9">

    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- LZ-String for local storage compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using class strategy
            theme: {
                extend: {
                    colors: {
                        'sams-red': '#DC2626',
                        'sams-black': '#1F2937',
                        'sams-gray': '#6B7280',
                    },
                     animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                    },
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; height: 400px; width: 100%; }
        .chart-container-small { position: relative; height: 300px; width: 100%; }
        
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 1rem; /* Adjusted padding */
        }
        .tab-button.active {
            border-bottom-color: #DC2626;
            color: #DC2626;
        }
        .dark .tab-button.active {
             border-bottom-color: #f87171; /* Lighter red for dark mode */
             color: #f87171;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; } /* Added animation */
        
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .drag-over {
            background-color: #fee2e2 !important;
            border: 2px dashed #DC2626 !important;
        }
        .dark .drag-over { background-color: #450a0a !important; }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e5e7eb; /* Light mode border */
            min-width: 50px;
        }
        .dark .heatmap-cell { border-color: #374151; /* Dark mode border */ }
        .heatmap-header {
            background: #1F2937; /* Dark background */
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .dark .heatmap-header { background: #374151; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Darker backdrop */
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem; /* More rounded */
            max-width: 800px;
            width: 90%; /* Responsive width */
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .dark .modal-content { background: #1f2937; } /* Dark mode modal */
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .member-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .member-list-item { border-bottom-color: #374151; }
        .member-list-item:last-child { border-bottom: none; }

        /* Tooltip */
        .info-icon {
            display: inline-block; width: 1rem; height: 1rem;
            background-color: #9ca3af; color: white; border-radius: 50%;
            text-align: center; line-height: 1rem; font-size: 0.7rem; font-weight: bold;
            cursor: help; margin-left: 0.25rem; position: relative;
        }
        .tooltip-text {
            visibility: hidden; width: 200px; background-color: #1f2937; color: #fff;
            text-align: center; border-radius: 6px; padding: 5px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s;
        }
        .info-icon:hover .tooltip-text { visibility: visible; opacity: 1; }
        .dark .tooltip-text { background-color: #4b5563; }

        /* Quick Filter Buttons */
        .quick-filter.active { background-color: #DC2626; color: white; }
        .dark .quick-filter.active { background-color: #f87171; color: #1f2937; }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
         /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #888; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-8 max-w-screen-xl"> <!-- Wider container -->
        <!-- Header -->
        <header class="mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-sams-red dark:text-red-400">
                        <!-- v6.0: Titel -->
                        üèãÔ∏è SAMS GYM Analytics v6.0
                    </h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Analyse-Zeitraum: <span id="period-display" class="font-medium">-</span>
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        Letztes Ereignis: <span id="last-event-display" class="font-medium">-</span>
                    </p>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        Lokal gespeichert: <span id="last-local-save" class="font-medium">-</span>
                        <span id="auto-save-indicator" class="ml-2 text-green-600 dark:text-green-400 hidden">‚úì</span>
                    </p>
                </div>
                <div class="no-print flex flex-wrap gap-2 mt-4 md:mt-0">
                    <!-- Theme & Fullscreen -->
                    <div class="flex items-center gap-1 bg-white dark:bg-gray-800 rounded-lg p-1 shadow-sm">
                        <button id="dark-mode-toggle" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Dark Mode (Alt+D)">
                            <svg class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                            <svg class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <button id="fullscreen-toggle" class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Vollbild (Alt+F)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                        </button>
                    </div>
                     <!-- Data Actions -->
                     <button id="add-data-btn" class="hidden bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow transition" title="Neue CSV-Dateien hinzuf√ºgen">
                        ‚ûï Hinzuf√ºgen
                    </button>
                    <button id="local-save-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow transition" title="Aktuellen Stand lokal im Browser speichern (Ctrl+S)">
                        üíæ Lokal Speichern
                    </button>
                    <button id="export-btn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition" title="Daten als JSON-Datei exportieren">
                        üìÅ JSON Export
                    </button>
                    <button id="sync-github-btn" class="bg-sams-red hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow transition" title="Daten mit GitHub synchronisieren">
                        ‚òÅÔ∏è GitHub Sync
                    </button>
                </div>
            </div>

             <!-- Quick Filter Bar -->
            <div id="quick-filter-bar" class="no-print flex flex-wrap gap-2 mt-4 hidden">
                 <button class="quick-filter px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-filter="today">Heute</button>
                 <button class="quick-filter px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-filter="week">Diese Woche</button>
                 <button class="quick-filter px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-filter="month">Dieser Monat</button>
                 <button class="quick-filter px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-filter="year">Dieses Jahr</button>
                 <button class="quick-filter px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-filter="all">Gesamt</button>
                 <div class="ml-auto">
                    <button id="advanced-filter-toggle" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        Erweiterte Filter ‚ñº
                    </button>
                 </div>
            </div>

            <!-- Advanced Filter Section (collapsible) -->
            <div id="advanced-filter-section" class="no-print bg-white dark:bg-gray-800 p-4 rounded-b-xl shadow-md mb-4 hidden animate-slide-in">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Studio</label>
                        <select id="main-studio-filter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sams-red dark:bg-gray-700 text-sm">
                            <option value="all">Alle Studios</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Von Datum</label>
                        <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sams-red dark:bg-gray-700 text-sm">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Bis Datum</label>
                        <input type="date" id="date-to" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-sams-red dark:bg-gray-700 text-sm">
                    </div>
                     <div class="flex items-end space-x-2">
                        <button id="apply-advanced-filter-btn" class="flex-1 px-4 py-2 bg-sams-red hover:bg-red-700 text-white font-semibold rounded-lg transition-colors text-sm">
                            Anwenden
                        </button>
                        <button id="reset-advanced-filter-btn" class="px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors text-sm" title="Filter zur√ºcksetzen">
                            ‚Ü∫
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Initial Load Section -->
        <div id="initial-load-section" class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-md mb-8 text-center animate-fade-in">
            <div class="mb-6">
                <div class="text-6xl mb-4">üèãÔ∏è</div>
                <h2 class="text-2xl font-bold mb-2">Willkommen beim SAMS GYM Analytics Dashboard v6.0</h2>
                <p class="text-gray-600 dark:text-gray-400">Lade Daten von GitHub, aus dem Browser-Speicher oder starte eine neue Analyse.</p>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                 <button id="load-local-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold flex-1">
                    üíæ Letzte Sitzung laden
                </button>
                <button id="load-github-btn" class="bg-sams-red hover:bg-red-700 text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold flex-1">
                    ‚òÅÔ∏è Von GitHub laden
                </button>
                <button id="start-new-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold flex-1">
                    üÜï Neue Analyse starten
                </button>
            </div>

            <div id="initial-loading" class="hidden mt-6">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-sams-red"></div>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Lade Daten...</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="hidden bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md mb-8 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">üìÅ Daten hochladen</h2>
                <button id="cancel-upload-btn" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-sm">
                    ‚Üê Zur√ºck
                </button>
            </div>
            
            <div id="upload-instructions" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg text-sm text-blue-800 dark:text-blue-200">
                <h4 class="font-bold mb-2">üí° Hinweise zum Hinzuf√ºgen von Daten:</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>SALTO Ereignisse:</strong> Gesamte Exportdatei hochladen. Duplikate werden automatisch ignoriert.</li>
                    <li><strong>Zoho Kontakte:</strong> *Immer* die **vollst√§ndige, aktuelle** Liste hochladen. Sie √ºberschreibt die alte Liste.</li>
                </ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Zoho Contacts Upload -->
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-red-600 dark:hover:border-red-400 transition cursor-pointer" id="contacts-drop-zone">
                    <input type="file" id="contacts-input" accept=".csv" class="hidden">
                    <div class="text-gray-600 dark:text-gray-400">
                         <svg class="w-12 h-12 mx-auto mb-3 text-sams-red" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <p class="font-semibold mb-1">Zoho Kontakte (CSV)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 dark:text-blue-400 hover:underline mb-2" onclick="showExample('contacts'); event.stopPropagation();">üìÑ Beispiel</button>
                        <p id="contacts-status" class="text-xs mt-2 text-gray-400 dark:text-gray-500">Keine Datei</p>
                    </div>
                </div>

                <!-- SALTO Events Upload -->
                <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-red-600 dark:hover:border-red-400 transition cursor-pointer" id="events-drop-zone">
                    <input type="file" id="events-input" accept=".csv" class="hidden">
                    <div class="text-gray-600 dark:text-gray-400">
                         <svg class="w-12 h-12 mx-auto mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="font-semibold mb-1">SALTO Ereignisse (CSV)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 dark:text-blue-400 hover:underline mb-2" onclick="showExample('events'); event.stopPropagation();">üìÑ Beispiel</button>
                        <p id="events-status" class="text-xs mt-2 text-gray-400 dark:text-gray-500">Keine Datei</p>
                    </div>
                </div>
            </div>

            <button id="analyze-btn" class="hidden w-full mt-6 bg-gradient-to-r from-sams-red to-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                üöÄ Daten analysieren
            </button>

            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-sams-red"></div>
                <p id="loading-text" class="mt-2 text-gray-600 dark:text-gray-400">Analysiere...</p>
            </div>
        </div>

        <!-- Status Display -->
        <div id="status" class="mb-6"></div>

        <!-- Results Section -->
        <div id="results-section" class="hidden space-y-8">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Gesamt Check-ins</p>
                            <p class="text-3xl font-bold" id="stat-total-checkins">0</p>
                            <p class="text-xs mt-1 text-sams-red" id="stat-checkins-trend">-</p>
                        </div>
                        <div class="text-3xl text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-full">üìä</div>
                    </div>
                </div>
                 <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">√ò Check-ins/Tag</p>
                            <p class="text-3xl font-bold" id="stat-avg-daily">0</p>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">im Zeitraum</p>
                        </div>
                        <div class="text-3xl text-blue-600 bg-blue-100 dark:bg-blue-900 dark:text-blue-300 p-3 rounded-full">üìÖ</div>
                    </div>
                </div>
                 <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Top Studio</p>
                            <p class="text-xl font-bold" id="stat-top-studio">-</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="stat-top-studio-percent">-</p>
                        </div>
                        <div class="text-3xl text-yellow-600 bg-yellow-100 dark:bg-yellow-900 dark:text-yellow-300 p-3 rounded-full">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex flex-wrap overflow-x-auto">
                        <button class="tab-button active font-semibold whitespace-nowrap" data-tab="overview">üìä √úbersicht</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="demographics">üë• Demographics</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="utilization">‚è∞ Auslastung</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="trends">üìà Trends</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="members">üë• Mitglieder</button>
                        <!-- v6.0: New Tab -->
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="studio-detail">üè¢ Studio Detail</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="compare">üìä Vergleich</button>
                        <button class="tab-button font-semibold whitespace-nowrap" data-tab="insights">üí° Insights</button>
                    </nav>
                </div>

                <!-- Tab Content Container -->
                <div class="p-4 md:p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active space-y-6">
                        <h3 class="text-xl font-bold mb-4">Gesamte Studio-Auslastung</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Check-ins pro Studio</h4><div class="chart-container-small"><canvas id="chart-studios"></canvas></div></div>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">T√§gliche Auslastung</h4><div class="chart-container-small"><canvas id="chart-daily"></canvas></div></div>
                        </div>
                    </div>

                    <!-- Demographics Tab -->
                    <div id="tab-demographics" class="tab-content space-y-6">
                         <h3 class="text-xl font-bold mb-4">Mitglieder-Demographics</h3>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Geschlechterverteilung</h4><div class="chart-container-small"><canvas id="chart-gender"></canvas></div></div>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Altersgruppen</h4><div class="chart-container-small"><canvas id="chart-age"></canvas></div></div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Altersgruppen nach Geschlecht (Stacked)</h4><div class="chart-container-small"><canvas id="chart-age-gender"></canvas></div></div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Demografie-Vergleich der Studios</h4><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600"><thead class="bg-gray-100 dark:bg-gray-600"><tr id="studio-comparison-header"></tr></thead><tbody id="studio-comparison-table" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600"></tbody></table></div></div>
                    </div>

                    <!-- Utilization Tab -->
                    <div id="tab-utilization" class="tab-content space-y-6">
                        <h3 class="text-xl font-bold mb-4">Auslastung nach Zeit</h3>
                         <div class="grid grid-cols-1 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Durchschnittliche Auslastung nach Wochentag</h4><p class="text-xs text-gray-500 mb-3">√ò pro Wochentag im gew√§hlten Zeitraum</p><div class="chart-container-small"><canvas id="chart-weekday-util"></canvas></div></div>
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Peak Hours Heatmap <span class="info-icon">i<span class="tooltip-text">Zeigt die Anzahl Check-ins pro Stunde und Wochentag. Rot = hohe Auslastung.</span></span></h4><div class="overflow-x-auto"><table id="heatmap-table" class="min-w-full"></table></div></div>
                        </div>
                    </div>

                    <!-- Trends Tab -->
                    <div id="tab-trends" class="tab-content space-y-6">
                         <h3 class="text-xl font-bold mb-4">Monatliche Trend-Analyse (Gesamt)</h3>
                         <div id="trends-info" class="p-4 mb-4 bg-blue-50 dark:bg-blue-900 border-l-4 border-blue-500 dark:border-blue-400 text-blue-900 dark:text-blue-100"><p id="trends-info-text"></p><p class="mt-2 font-medium" id="trends-total-percent"></p></div>
                         <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">üìà Check-ins pro Monat</h4><div class="chart-container"><canvas id="chart-trends-total"></canvas></div></div>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">üë• M√§nner vs. Frauen (monatlich)</h4><div class="chart-container-small"><canvas id="chart-trends-gender"></canvas></div></div>
                             <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">üìä Altersgruppen (monatlich)</h4><div class="chart-container-small"><canvas id="chart-trends-age-groups"></canvas></div></div>
                         </div>
                         <!-- Consolidated Trend Alerts -->
                         <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">‚ö†Ô∏è Gesamte Trends & R√ºckg√§nge (Letzte 3 Monate)</h4>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700"><h5 class="font-semibold mb-3 text-green-800 dark:text-green-300">üìà Positive Trends</h5><div id="trend-alerts-positive" class="space-y-3"></div></div>
                                <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg border border-red-200 dark:border-red-700"><h5 class="font-semibold mb-3 text-red-800 dark:text-red-300">üìâ Negative Trends</h5><div id="trend-alerts-negative" class="space-y-3"></div></div>
                             </div>
                         </div>
                    </div>

                    <!-- Members Tab -->
                    <div id="tab-members" class="tab-content space-y-6">
                         <h3 class="text-xl font-bold mb-4">Top 20 Mitglieder</h3>
                         <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Zeigt die aktivsten Mitglieder im aktuell gefilterten Zeitraum und Studio.</p>
                         <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3 text-gray-800 dark:text-gray-200">üèÜ Top 20 Mitglieder</h4><div id="top-members-list" class="space-y-2"></div></div>
                    </div>

                     <!-- v6.0: Studio Detail Tab -->
                     <div id="tab-studio-detail" class="tab-content space-y-6">
                         <h3 class="text-xl font-bold mb-4">üè¢ Studio Detail Analyse</h3>
                         <div class="flex items-center gap-4 mb-6">
                            <label class="block text-sm font-medium">Studio w√§hlen:</label>
                            <select id="detail-studio-select" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <!-- Options added by JS -->
                            </select>
                         </div>
                         <div id="studio-detail-content" class="space-y-6">
                            <!-- Content loaded dynamically -->
                            <p class="text-gray-500 text-center py-8">Bitte w√§hlen Sie ein Studio aus.</p>
                         </div>
                     </div>

                    <!-- Compare Tab -->
                    <div id="tab-compare" class="tab-content space-y-6">
                        <h3 class="text-xl font-bold mb-4">üìä Vergleichs-Analyse</h3>
                        
                        <!-- Comparison Mode Selection -->
                         <div class="mb-6 flex justify-center space-x-4">
                            <button id="compare-mode-time" class="px-4 py-2 rounded-lg bg-sams-red text-white font-semibold">Zeitraum vs Zeitraum</button>
                            <button id="compare-mode-studio" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-600">Studio vs Studio</button>
                         </div>

                        <!-- Time Period Comparison Section -->
                         <div id="compare-time-section">
                             <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Vergleiche zwei Zeitr√§ume, optional gefiltert nach einem Studio.</p>
                             <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Studio w√§hlen (optional):</label>
                                <select id="compare-time-studio-filter" class="w-full md:w-1/3 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></select>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div><h4 class="font-semibold mb-3 text-sams-red">Zeitraum A (Basis)</h4><div id="compare-period-A" class="space-y-3"></div></div>
                                <div><h4 class="font-semibold mb-3 text-blue-600 dark:text-blue-400">Zeitraum B (Vergleich)</h4><div id="compare-period-B" class="space-y-3"></div></div>
                             </div>
                             <button id="run-time-compare-btn" class="w-full bg-gradient-to-r from-sams-red to-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">üìä Zeitr√§ume vergleichen</button>
                             <div id="compare-time-results-container" class="hidden mt-6"></div>
                         </div>

                        <!-- Studio vs Studio Comparison Section -->
                        <div id="compare-studio-section" class="hidden">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Vergleiche zwei Studios f√ºr den aktuell im Hauptfilter gew√§hlten Zeitraum.</p>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                 <div>
                                    <label class="block text-sm font-medium mb-1 text-sams-red">Studio A:</label>
                                    <select id="compare-studio-A" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></select>
                                 </div>
                                  <div>
                                    <label class="block text-sm font-medium mb-1 text-blue-600 dark:text-blue-400">Studio B:</label>
                                    <select id="compare-studio-B" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700"></select>
                                 </div>
                             </div>
                             <button id="run-studio-compare-btn" class="w-full bg-gradient-to-r from-sams-red to-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">üè¢ Studios vergleichen</button>
                             <div id="compare-studio-results-container" class="hidden mt-6"></div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div id="tab-insights" class="tab-content space-y-6">
                        <h3 class="text-xl font-bold mb-4">üí° Actionable Insights & Empfehlungen</h3>
                         <div id="insights-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Example, GitHub Sync) -->
    <div id="example-modal" class="modal"><div class="modal-content dark:bg-gray-800"><div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold" id="example-title">Beispiel</h3><button onclick="closeModal('example-modal')" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-2xl">&times;</button></div><div id="example-content"></div></div></div>
    <div id="github-sync-modal" class="modal"><div class="modal-content dark:bg-gray-800"><div class="flex items-center justify-between mb-4"><h3 class="text-xl font-bold">‚òÅÔ∏è GitHub Sync</h3><button onclick="closeModal('github-sync-modal')" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 text-2xl">&times;</button></div><p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Speichere oder lade deine Analysedaten als 'analysis-data.json'. Dein Token wird nur tempor√§r verwendet.</p><div class="mb-4"><label class="block text-sm font-medium mb-1">Status:</label><input id="github-status" type="text" readonly class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg" value="Nicht geladen"></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Repo-Besitzer:</label><input id="github-owner" type="text" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700"></div><div class="mb-4"><label class="block text-sm font-medium mb-1">Repo-Name:</label><input id="github-repo" type="text" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700"></div><div class="mb-4"><label class="block text-sm font-medium mb-1">GitHub Personal Access Token:</label><input id="github-token" type="password" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700"><a href="https://github.com/settings/tokens/new?scopes=repo&description=SAMS-GYM-Analytics" target="_blank" class="text-xs text-blue-600 dark:text-blue-400 hover:underline mt-1">Neuen Token erstellen (mit "repo" Rechten)</a></div><div id="github-error" class="hidden p-3 bg-red-100 dark:bg-red-800 border border-red-300 dark:border-red-600 text-red-800 dark:text-red-200 rounded-lg mb-4 text-sm"></div><div class="flex gap-4"><button id="github-load-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white px-6 py-3 rounded-lg shadow transition font-semibold">Laden</button><button id="github-save-btn" class="flex-1 bg-sams-red hover:bg-red-700 text-white px-6 py-3 rounded-lg shadow transition font-semibold">Speichern</button></div></div></div>

    <!-- v6.0: Local Storage Confirmation Modal -->
    <div id="local-storage-modal" class="modal"><div class="modal-content dark:bg-gray-800"><h3 class="text-xl font-bold mb-4">Lokale Sitzung gefunden</h3><p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Es wurde eine automatisch gespeicherte Sitzung vom <span id="local-save-time" class="font-medium"></span> gefunden. M√∂chten Sie diese laden?</p><div class="flex justify-end gap-4"><button onclick="closeModal('local-storage-modal'); startNewAnalysis(true);" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Verwerfen</button><button onclick="loadFromLocalStorage(); closeModal('local-storage-modal');" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Laden</button></div></div></div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            GITHUB: {
                owner: 'sam-ux-sack',
                repo: 'sams-gym-data',
                token: null,
                sha: null,
                dataFile: 'analysis-data.json'
            },
            MAIN_DOORS: {
                'Susten Hauptt√ºre': 'Susten GYM',
                'Strongman rechts': 'Susten CrossGYM',
                'Visp S√ºd - Eingang': 'Visp-S√ºd',
                'Visp Center - Eingang': 'Visp-Center' // Ready for Visp-Center
            },
            AGE_GROUPS: ['<20', '20-40', '40-60', '60+'],
            GENDERS: ['M√§nnlich', 'Weiblich'],
            LOCAL_STORAGE_KEY: 'samsGymAnalyticsData_v6',
            AUTO_SAVE_INTERVAL: 30000 // 30 seconds
        };

        // ==================== DOM HELPER ====================
        // v6.0: Moved DOM helper to the top
        const DOM = {
            get: (id) => document.getElementById(id),
            show: (element) => {
                if (typeof element === 'string') element = DOM.get(element);
                if (!element) return;
                element.classList.remove('hidden');
                if (element.classList.contains('modal') || element.id === 'initial-loading') {
                    element.style.display = 'flex'; // Use flex for modals and loading
                }
            },
            hide: (element) => {
                if (typeof element === 'string') element = DOM.get(element);
                if (!element) return;
                element.classList.add('hidden');
                 if (element.classList.contains('modal') || element.id === 'initial-loading') {
                    element.style.display = 'none'; // Use none for modals and loading
                }
            },
            // Helper to set text content safely
            setText: (id, text) => {
                const el = DOM.get(id);
                if (el) el.textContent = text ?? '-'; // Use nullish coalescing for default
            },
            // Helper to set status messages
            setStatus: (message, type = 'info') => {
                const statusDiv = DOM.get('status');
                statusDiv.innerHTML = ''; // Clear previous messages
                const typeClasses = {
                    info: 'bg-blue-50 dark:bg-blue-900 border-blue-500 dark:border-blue-400 text-blue-900 dark:text-blue-100',
                    success: 'bg-green-50 dark:bg-green-900 border-green-500 dark:border-green-400 text-green-900 dark:text-green-100',
                    error: 'bg-red-50 dark:bg-red-900 border-red-500 dark:border-red-400 text-red-900 dark:text-red-100'
                };
                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 border-l-4 rounded-r-lg shadow ${typeClasses[type]} animate-slide-in`;
                alertDiv.innerHTML = message;
                statusDiv.appendChild(alertDiv);
                
                 // Auto-hide success messages
                 if (type === 'success') {
                     setTimeout(() => {
                         alertDiv.style.opacity = '0';
                         setTimeout(() => alertDiv.remove(), 500);
                     }, 4000);
                 }
            }
        };

        // ==================== APPLICATION STATE ====================
        let appState = {
            allCheckins: [],
            filteredCheckins: [],
            analysisResults: null,
            monthlyTrends: [],
            charts: {},
            githubStatus: 'Nicht geladen',
            localSaveTimestamp: null,
            lastEventDate: null,
            activeFilters: { // Store the current filter settings
                studio: 'all',
                dateFrom: '',
                dateTo: ''
            },
            autoSaveTimer: null
        };
        
        // ==================== CHART HELPERS ====================
        Chart.register(ChartDataLabels);

        function getDatalabelConfig(isInside = false, color = '#FFFFFF') {
             if (isInside) {
                return {
                    anchor: 'end', align: 'end', color: color,
                    font: { weight: 'bold' },
                    formatter: (value) => value > 0 ? value.toLocaleString('de-CH') : null,
                    offset: -6
                };
            }
             const isDarkMode = document.documentElement.classList.contains('dark');
            return {
                anchor: 'end', align: 'top', 
                color: isDarkMode ? '#e5e7eb' : '#1F2937', // Adjust color for dark mode
                 font: { weight: 'bold' },
                 formatter: (value) => value > 0 ? value.toLocaleString('de-CH') : null
            };
        }
        
        function getChartBaseOptions(isDarkMode) {
             const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)'; // Subtle grid
             const textColor = isDarkMode ? '#cbd5e1' : '#4b5563'; // Tailwind gray-300 / gray-600
             return {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top', labels: { color: textColor, padding: 15, usePointStyle: true } },
                    tooltip: {
                        backgroundColor: isDarkMode ? '#374151' : '#1f2937', // Dark tooltip background
                        titleColor: '#FFFFFF', bodyColor: '#FFFFFF',
                        padding: 10, cornerRadius: 4,
                    },
                    datalabels: { display: false } // Default off, enable per chart
                },
                 scales: {
                     x: { ticks: { color: textColor, maxRotation: 0, autoSkipPadding: 10 }, grid: { color: gridColor, drawOnChartArea: false } }, // Less prominent grid, better rotation
                     y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true }
                 }
             };
        }

        // ==================== MODAL HANDLERS ====================
        function showModal(modalId) { DOM.show(modalId); }
        function closeModal(modalId) { DOM.hide(modalId); }

        function showExample(type) { /* ... (keep existing example logic) ... */ }

        // ==================== INITIAL LOAD ====================
        function setupInitialLoad() {
            // Check for local save first
            const savedState = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(LZString.decompressFromUTF16(savedState)); // Use correct decompression
                    if (parsedState && parsedState.timestamp) {
                         appState.localSaveTimestamp = new Date(parsedState.timestamp);
                         DOM.setText('local-save-time', appState.localSaveTimestamp.toLocaleString('de-CH'));
                         showModal('local-storage-modal');
                    } else {
                         localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
                    }
                } catch(e) {
                     console.error("Error parsing local save:", e);
                     localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
                }
            }

            DOM.get('load-local-btn').addEventListener('click', () => {
                if (appState.localSaveTimestamp || localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY)) { // Check storage again
                    loadFromLocalStorage();
                } else {
                    DOM.setStatus('Keine lokale Sitzung gefunden.', 'info');
                }
            });
            DOM.get('load-github-btn').addEventListener('click', () => {
                loadGitHubConfig(); // Load owner/repo from LS
                showModal('github-sync-modal');
            });
            DOM.get('start-new-btn').addEventListener('click', () => startNewAnalysis(true)); // Pass true to confirm reset
            DOM.get('cancel-upload-btn').addEventListener('click', cancelUpload);
            DOM.get('add-data-btn').addEventListener('click', showUploadSection);
        }

        function cancelUpload() {
             DOM.hide('upload-section');
             if (appState.allCheckins.length > 0) {
                 DOM.show('results-section');
                 DOM.show('quick-filter-bar'); // Show quick filters again
             } else {
                 DOM.show('initial-load-section');
             }
        }

        function showUploadSection() {
             DOM.hide('results-section');
             DOM.hide('quick-filter-bar'); // Hide quick filters during upload
             DOM.show('upload-section');
             DOM.get('upload-instructions').classList.toggle('hidden', appState.allCheckins.length === 0);
             // Reset file inputs visually
             DOM.get('contacts-input').value = null;
             DOM.get('events-input').value = null;
             DOM.setText('contacts-status', 'Keine Datei');
             DOM.setText('events-status', 'Keine Datei');
             DOM.get('contacts-status').className = 'text-xs mt-2 text-gray-400 dark:text-gray-500';
             DOM.get('events-status').className = 'text-xs mt-2 text-gray-400 dark:text-gray-500';
             DOM.hide('analyze-btn');
        }

        function startNewAnalysis(confirmed = false) {
             if (!confirmed && appState.allCheckins.length > 0) {
                 if (!confirm("M√∂chten Sie wirklich alle aktuellen Daten verwerfen und neu beginnen?")) {
                     return;
                 }
             }
            // Hard-Reset Logic
            appState.allCheckins = [];
            appState.monthlyTrends = [];
            // contactsData/eventsData are temporary and reset elsewhere
            appState.githubStatus = 'Nicht geladen';
            appState.localSaveTimestamp = null;
            appState.lastEventDate = null;
            CONFIG.GITHUB.sha = null;
            appState.analysisResults = null;
            appState.filteredCheckins = [];
            
            // Clear local storage if user explicitly starts new
            if(confirmed) {
                localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY);
                 DOM.setStatus('Lokaler Speicher gel√∂scht. Neue Analyse gestartet.', 'info');
            } else {
                 DOM.setStatus('Neue Analyse gestartet. Aktuelle Daten verworfen.', 'info');
            }
            DOM.setText('last-local-save', '-');

            DOM.hide('initial-load-section');
            DOM.hide('results-section');
            DOM.hide('advanced-filter-section'); // Hide advanced filters too
            DOM.hide('quick-filter-bar');
            DOM.hide('add-data-btn');
            DOM.hide('local-save-btn');
            DOM.hide('export-btn');
            
            showUploadSection(); // Show the upload section directly
            console.log('New analysis started. All data cleared.');
        }

        // ==================== LOCAL SAVE/LOAD ====================
        function saveToLocalStorage() {
            if (appState.allCheckins.length === 0) return;
            try {
                const stateToSave = {
                    allCheckins: appState.allCheckins,
                    monthlyTrends: appState.monthlyTrends,
                    lastEventDate: appState.lastEventDate,
                    timestamp: new Date().toISOString()
                };
                const compressed = LZString.compressToUTF16(JSON.stringify(stateToSave));
                localStorage.setItem(CONFIG.LOCAL_STORAGE_KEY, compressed);
                appState.localSaveTimestamp = new Date(stateToSave.timestamp);
                DOM.setText('last-local-save', appState.localSaveTimestamp.toLocaleTimeString('de-CH'));
                console.log('Auto-saved locally');
                showAutoSaveIndicator(); // Visual feedback
            } catch (e) {
                 console.error("Local save error:", e);
                 DOM.setStatus('Fehler beim lokalen Speichern (Speicher voll?).', 'error');
            }
        }

         function loadFromLocalStorage() {
            DOM.show('initial-loading'); // Show loading indicator
            DOM.setText('initial-loading p', 'Lade lokale Daten...'); // Update text
            DOM.hide('initial-load-section');

            setTimeout(() => { // Simulate async loading & prevent UI freeze
                try {
                    const compressedState = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEY);
                    if (!compressedState) throw new Error("Keine lokalen Daten gefunden.");

                    const decompressed = LZString.decompressFromUTF16(compressedState);
                    if (!decompressed) throw new Error("Fehler beim Dekomprimieren der lokalen Daten."); // Check decompression result
                    
                    const loadedState = JSON.parse(decompressed);

                    if (!loadedState || !loadedState.allCheckins || !loadedState.timestamp) {
                        throw new Error("Ung√ºltiges Format der lokalen Daten.");
                    }

                    appState.allCheckins = loadedState.allCheckins || [];
                    appState.monthlyTrends = loadedState.monthlyTrends || [];
                    appState.lastEventDate = loadedState.lastEventDate ? new Date(loadedState.lastEventDate) : null;
                    appState.localSaveTimestamp = new Date(loadedState.timestamp);

                    // Re-hydrate Date objects
                    appState.allCheckins.forEach(c => { c.timestamp = new Date(c.timestamp); });

                    console.log(`Loaded ${appState.allCheckins.length} checkins from local storage.`);
                    DOM.setStatus(`‚úì Lokale Sitzung vom ${appState.localSaveTimestamp.toLocaleString('de-CH')} geladen.`, 'success');
                    
                    // Proceed to display data
                    displayData();
                    startAutoSave(); // Restart auto-save

                } catch (e) {
                    console.error("Local load error:", e);
                    DOM.setStatus(`Fehler beim Laden lokaler Daten: ${e.message}`, 'error');
                    localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEY); // Clear invalid data
                    DOM.hide('initial-loading');
                    DOM.show('initial-load-section'); // Show initial buttons again
                } finally {
                    DOM.hide('initial-loading');
                }
             }, 50); // Small delay
        }

        function startAutoSave() {
             if (appState.autoSaveTimer) clearInterval(appState.autoSaveTimer);
             appState.autoSaveTimer = setInterval(saveToLocalStorage, CONFIG.AUTO_SAVE_INTERVAL);
             console.log('Auto-save started.');
        }

        function showAutoSaveIndicator() {
             const indicator = DOM.get('auto-save-indicator');
             indicator.classList.remove('hidden');
             setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        // ==================== FILE UPLOAD HANDLERS ====================
        function setupFileHandlers() {
            const contactsZone = DOM.get('contacts-drop-zone');
            const contactsInput = DOM.get('contacts-input');
            contactsZone.addEventListener('click', () => contactsInput.click());
            contactsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'contacts'));
            ['dragover', 'dragleave', 'drop'].forEach(ev => contactsZone.addEventListener(ev, preventDefaults));
            contactsZone.addEventListener('dragover', () => contactsZone.classList.add('drag-over'));
            contactsZone.addEventListener('dragleave', () => contactsZone.classList.remove('drag-over'));
            contactsZone.addEventListener('drop', (e) => { contactsZone.classList.remove('drag-over'); handleFileSelect(e.dataTransfer.files[0], 'contacts'); });

            const eventsZone = DOM.get('events-drop-zone');
            const eventsInput = DOM.get('events-input');
            eventsZone.addEventListener('click', () => eventsInput.click());
            eventsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'events'));
            ['dragover', 'dragleave', 'drop'].forEach(ev => eventsZone.addEventListener(ev, preventDefaults));
            eventsZone.addEventListener('dragover', () => eventsZone.classList.add('drag-over'));
            eventsZone.addEventListener('dragleave', () => eventsZone.classList.remove('drag-over'));
            eventsZone.addEventListener('drop', (e) => { eventsZone.classList.remove('drag-over'); handleFileSelect(e.dataTransfer.files[0], 'events'); });

            DOM.get('analyze-btn').addEventListener('click', analyzeData);
        }

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        function handleFileSelect(file, type) { /* ... (keep existing file select logic) ... */ }

        // ==================== DATA ANALYSIS (CSV) ====================
        function analyzeData() { /* ... (keep existing analyzeData logic) ... */ }

        // ==================== MONTHLY TRENDS ====================
        function generateMonthlyTrends() { /* ... (keep existing monthly trends logic) ... */ }

        // ==================== MAIN ANALYSIS (after filter) ====================
        function processAnalysis() { /* ... (keep existing processAnalysis logic) ... */ }

        // ==================== MAIN FILTER LOGIC ====================
        function setupMainFilters() {
             DOM.get('advanced-filter-toggle').addEventListener('click', () => {
                 DOM.get('advanced-filter-section').classList.toggle('hidden');
                 DOM.setText('advanced-filter-toggle', DOM.get('advanced-filter-section').classList.contains('hidden') ? 'Erweiterte Filter ‚ñº' : 'Erweiterte Filter ‚ñ≤');
             });
             DOM.get('apply-advanced-filter-btn').addEventListener('click', applyAdvancedFilter);
             DOM.get('reset-advanced-filter-btn').addEventListener('click', resetAdvancedFilter);

             // Quick Filters
             document.querySelectorAll('.quick-filter').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                     document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
                     e.target.classList.add('active');
                     applyQuickFilter(e.target.dataset.filter);
                 });
             });
        }
        
        function applyAdvancedFilter() {
            appState.activeFilters.studio = DOM.get('main-studio-filter').value;
            appState.activeFilters.dateFrom = DOM.get('date-from').value;
            appState.activeFilters.dateTo = DOM.get('date-to').value;
            
            // Deactivate quick filters if advanced are used
            document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
            
            filterAndProcessData();
        }

        function resetAdvancedFilter() {
            DOM.get('main-studio-filter').value = 'all';
            DOM.get('date-from').value = '';
            DOM.get('date-to').value = '';
            appState.activeFilters = { studio: 'all', dateFrom: '', dateTo: '' };
            
            // Optionally activate 'Gesamt' quick filter or just refilter
            const allButton = document.querySelector('.quick-filter[data-filter="all"]');
             if (allButton) {
                 document.querySelectorAll('.quick-filter').forEach(b => b.classList.remove('active'));
                 allButton.classList.add('active');
                 applyQuickFilter('all'); // Re-apply the 'all' quick filter
             } else {
                 filterAndProcessData();
             }
        }

        function applyQuickFilter(filterType) {
            const today = new Date();
            let dateFrom = '', dateTo = '';
            
            // Reset advanced filters when using quick filter
             DOM.get('main-studio-filter').value = 'all';
             DOM.get('date-from').value = '';
             DOM.get('date-to').value = '';
             appState.activeFilters.studio = 'all'; // Only date filters change

            switch(filterType) {
                case 'today':
                    dateFrom = dateTo = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const firstDayOfWeek = new Date(today);
                    const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon,...
                    firstDayOfWeek.setDate(today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1)); // Adjust to Monday
                    dateFrom = firstDayOfWeek.toISOString().split('T')[0];
                    dateTo = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    dateTo = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'year':
                    dateFrom = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                    dateTo = new Date(today.getFullYear(), 11, 31).toISOString().split('T')[0];
                    break;
                 case 'all':
                 default:
                     dateFrom = '';
                     dateTo = '';
                     break;
            }
            appState.activeFilters.dateFrom = dateFrom;
            appState.activeFilters.dateTo = dateTo;
            
            filterAndProcessData();
        }

        function filterAndProcessData() {
             const { studio, dateFrom, dateTo } = appState.activeFilters;
             
             console.log("Applying filters:", appState.activeFilters);

             appState.filteredCheckins = appState.allCheckins.filter(c => {
                 const checkinDate = c.timestamp;
                 const dateString = checkinDate.toISOString().split('T')[0];

                 const studioMatch = studio === 'all' || c.studio === studio;
                 const dateFromMatch = !dateFrom || dateString >= dateFrom;
                 const dateToMatch = !dateTo || dateString <= dateTo;

                 return studioMatch && dateFromMatch && dateToMatch;
             });

             console.log(`Filtering resulted in ${appState.filteredCheckins.length} checkins.`);
             processAnalysis(); // Re-run analysis on filtered data
        }


        // ==================== RENDER ALL ====================
        function displayData() {
             DOM.hide('initial-load-section');
             DOM.hide('initial-loading');
             DOM.hide('upload-section');
             DOM.show('results-section');
             DOM.show('add-data-btn');
             DOM.show('local-save-btn');
             DOM.show('export-btn');
             DOM.show('quick-filter-bar'); // Show filters now

            // Populate filter options based on full dataset
            populateStudioFilterOptions();
            setupMainFilters();
            
            // Set up compare tab selects now that studios are known
            setupCompareTabSelects();
            
            // Set up studio detail select
            populateStudioDetailSelect();

            // Initial filter application (show all)
            const allButton = document.querySelector('.quick-filter[data-filter="all"]');
             if(allButton) allButton.classList.add('active');
             filterAndProcessData(); // This calls processAnalysis -> renderResults
        }
        
         function populateStudioFilterOptions() {
             const studios = [...new Set(appState.allCheckins.map(c => c.studio))].sort();
             const selects = [
                 DOM.get('main-studio-filter'),
                 DOM.get('compare-time-studio-filter'),
                 DOM.get('compare-studio-A'),
                 DOM.get('compare-studio-B'),
                 DOM.get('detail-studio-select') // v6.0
             ];
             selects.forEach(select => {
                 if (!select) return;
                 // Keep the 'Alle Studios' option if it exists
                 const firstOption = select.options[0]?.value === 'all' ? select.options[0].outerHTML : '<option value="all">Alle Studios</option>';
                 select.innerHTML = firstOption;
                 studios.forEach(studio => {
                     select.innerHTML += `<option value="${studio}">${studio}</option>`;
                 });
             });
         }
         
         function populateStudioDetailSelect() {
            const select = DOM.get('detail-studio-select');
            const studios = [...new Set(appState.allCheckins.map(c => c.studio))].sort();
            select.innerHTML = '<option value="">-- Studio w√§hlen --</option>'; // Default prompt
            studios.forEach(studio => {
                select.innerHTML += `<option value="${studio}">${studio}</option>`;
            });
            select.addEventListener('change', (e) => renderStudioDetailTab(e.target.value));
         }


        function renderResults() { /* ... (keep existing renderResults logic, ensure it uses appState.filteredCheckins) ... */ }
        function renderStudioChart() { /* ... (keep existing logic, use appState.analysisResults.studioStats) ... */ }
        function renderDailyChart() { /* ... (keep existing logic, use appState.analysisResults.dailyStats) ... */ }
        function updateDemographicsCharts() { /* ... (keep existing logic, use appState.filteredCheckins) ... */ }
        function renderStudioComparisonTable() { /* ... (keep existing logic, use appState.filteredCheckins) ... */ }
        function updateUtilizationCharts() { /* ... (keep existing logic, use appState.filteredCheckins) ... */ }
        function renderHeatmapTable() { /* ... (keep existing logic, use appState.filteredCheckins) ... */ }
        function renderTrendCharts() { /* ... (keep existing logic, use appState.monthlyTrends filtered implicitly by studio filter) ... */ }
        function analyzeTrendAlerts() { /* ... (keep existing logic, use appState.monthlyTrends filtered implicitly by studio filter) ... */ }
        function renderMembersTab() { /* ... (keep existing logic, use appState.filteredCheckins) ... */ }
        function renderInsights() { /* ... (keep existing logic, use appState.filteredCheckins and appState.analysisResults) ... */ }
        
        // ==================== v6.0: STUDIO DETAIL TAB ====================
        function renderStudioDetailTab(studio) {
            const container = DOM.get('studio-detail-content');
            if (!studio) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-8">Bitte w√§hlen Sie ein Studio aus.</p>';
                 return;
            }
            
            // Use ALL checkins for the selected studio, regardless of main filter
            const studioCheckinsAllTime = appState.allCheckins.filter(c => c.studio === studio); 
            if (studioCheckinsAllTime.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine Daten f√ºr dieses Studio im Gesamtzeitraum.</p>';
                 return;
            }
            
            // --- Generate content for the selected studio ---
            // 1. KPIs (using filtered data for current period avg)
            const studioCheckinsFiltered = appState.filteredCheckins.filter(c => c.studio === studio);
            const studioKPIs = calculateStudioKPIs(studioCheckinsFiltered, studio); // Use filtered for avgDaily
            studioKPIs.total = studioCheckinsAllTime.length; // Use all time for total
            
            // --- Structure ---
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="studio-detail-kpis">
                    <!-- KPIs loaded here -->
                </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                     <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Monatlicher Trend (Check-ins)</h4><div class="chart-container-small"><canvas id="studio-detail-trend-total"></canvas></div></div>
                     <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Geschlechter Trend</h4><div class="chart-container-small"><canvas id="studio-detail-trend-gender"></canvas></div></div>
                 </div>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6"><h4 class="font-semibold mb-3">Altersgruppen Trend</h4><div class="chart-container"><canvas id="studio-detail-trend-age"></canvas></div></div>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6"><h4 class="font-semibold mb-3">Peak Hours Heatmap</h4><div class="overflow-x-auto"><table id="studio-detail-heatmap" class="min-w-full"></table></div></div>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-6"><h4 class="font-semibold mb-3">Top 10 Mitglieder (im Filterzeitraum)</h4><div id="studio-detail-members"></div></div>
                  <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg"><h4 class="font-semibold mb-3">Trends & R√ºckg√§nge (Letzte 3 Monate)</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg border border-green-200 dark:border-green-700"><h5 class="font-semibold mb-3 text-green-800 dark:text-green-300">üìà Positiv</h5><div id="studio-detail-alerts-pos"></div></div><div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg border border-red-200 dark:border-red-700"><h5 class="font-semibold mb-3 text-red-800 dark:text-red-300">üìâ Negativ</h5><div id="studio-detail-alerts-neg"></div></div></div></div>
            `;

            // --- Render Components ---
            renderStudioDetailKPIs(studioKPIs);
            renderStudioDetailCharts(studio); // Renders the 3 trend charts for the studio
            renderHeatmapTable(studioCheckinsFiltered, 'studio-detail-heatmap'); // Use filtered for heatmap
            renderTopMembersForStudio(studioCheckinsFiltered, 'studio-detail-members', 10); // Use filtered for top members, limit to 10
            renderStudioTrendAlerts(studio); // Renders the alerts for the studio
        }
        
        function calculateStudioKPIs(studioCheckinsFiltered, studioName) {
            const total = studioCheckinsFiltered.length;
            const dailyCounts = {};
            studioCheckinsFiltered.forEach(c => { dailyCounts[c.dateKey] = (dailyCounts[c.dateKey] || 0) + 1; });
            const daysCount = Object.keys(dailyCounts).length || 1;
            const avgDaily = total / daysCount;
            const males = studioCheckinsFiltered.filter(c => c.gender === 'M√§nnlich').length;
            const females = studioCheckinsFiltered.filter(c => c.gender === 'Weiblich').length;
            const ages = studioCheckinsFiltered.map(c => c.age).filter(a => a !== null);
            const avgAge = ages.length > 0 ? ages.reduce((a, b) => a + b, 0) / ages.length : 0;
            return { total, avgDaily, males, females, avgAge };
        }

        function renderStudioDetailKPIs(kpis) {
             const container = DOM.get('studio-detail-kpis');
             container.innerHTML = `
                 ${createDetailKPI('Check-ins (im Filter)', kpis.total.toLocaleString('de-CH'), 'üìä')}
                 ${createDetailKPI('√ò Check-ins / Tag', kpis.avgDaily.toFixed(1), 'üìÖ')}
                 ${createDetailKPI('Frauen / M√§nner', `${kpis.females} / ${kpis.males}`, 'üë•')}
                 ${createDetailKPI('√ò Alter', kpis.avgAge.toFixed(0), 'üéÇ')}
             `;
        }
        
        function createDetailKPI(label, value, icon) {
             return `
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-center">
                    <div class="text-3xl mb-2">${icon}</div>
                     <p class="text-2xl font-bold">${value}</p>
                     <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${label}</p>
                 </div>
             `;
        }
        
        // Renders the 3 trend charts specifically for the selected studio
        function renderStudioDetailCharts(studio) { 
            const labels = appState.monthlyTrends.map(m => m.period);
            const isDarkMode = document.documentElement.classList.contains('dark');
            const options = getChartBaseOptions(isDarkMode);

             // Helper to get studio-specific monthly data
            const getStudioMonthlyData = (metric, subMetric = null) => {
                return appState.monthlyTrends.map(m => {
                    const studioData = m.studios[studio];
                    if (!studioData) return 0;
                    if (subMetric) {
                        return studioData[metric]?.[subMetric] || 0;
                    }
                    return studioData[metric] || 0;
                });
            };
            
            // Total Trend
            renderChart(appState.charts, 'studioDetailTotal', 'studio-detail-trend-total', 'line', {
                labels, datasets: [{ label: 'Check-ins', data: getStudioMonthlyData('total'), borderColor: '#DC2626', tension: 0.4 }]
            }, { ...options, plugins: { ...options.plugins, legend: { display: false } } });
            
            // Gender Trend
            renderChart(appState.charts, 'studioDetailGender', 'studio-detail-trend-gender', 'line', {
                labels, datasets: [
                    { label: 'M√§nner', data: getStudioMonthlyData('male'), borderColor: '#1F2937', tension: 0.4 },
                    { label: 'Frauen', data: getStudioMonthlyData('female'), borderColor: '#DC2626', tension: 0.4 }
                ]
            }, options);
            
            // Age Group Trend (Combined Male/Female per group for simplicity)
             const ageColors = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6']; // Green, Blue, Orange, Purple
             renderChart(appState.charts, 'studioDetailAge', 'studio-detail-trend-age', 'line', {
                 labels, datasets: CONFIG.AGE_GROUPS.map((group, idx) => ({
                     label: group,
                     data: appState.monthlyTrends.map(m => {
                         const studioData = m.studios[studio];
                         return (studioData?.maleAge?.[group] || 0) + (studioData?.femaleAge?.[group] || 0);
                     }),
                     borderColor: ageColors[idx],
                     tension: 0.4
                 }))
             }, options);
        }
        
        // Renders trend alerts specifically for the selected studio
        function renderStudioTrendAlerts(studio) { 
             const posContainer = DOM.get('studio-detail-alerts-pos');
             const negContainer = DOM.get('studio-detail-alerts-neg');
             posContainer.innerHTML = ''; negContainer.innerHTML = '';
             let posCount = 0, negCount = 0;

             if (appState.monthlyTrends.length < 3) {
                 posContainer.innerHTML = negContainer.innerHTML = '<p class="text-xs text-gray-500">Mind. 3 Monate n√∂tig.</p>';
                 return;
             }
             
             const recent = appState.monthlyTrends.slice(-3);
             const period = `(${recent[0].period.split(' ')[0]} vs ${recent[2].period.split(' ')[0]})`;

             const metricsToCheck = [
                 { key: 'total', label: 'Gesamt' },
                 { key: 'male', label: 'M√§nner' },
                 { key: 'female', label: 'Frauen' },
                 ...CONFIG.AGE_GROUPS.map(g => ({ key: 'age', subKey: g, label: `Alter ${g}` })) // Combine M/F for alerts
             ];

             metricsToCheck.forEach(metric => {
                 const start = recent[0].studios[studio]?.[metric.key === 'age' ? 'maleAge' : metric.key]?.[metric.subKey] || 0 + recent[0].studios[studio]?.[metric.key === 'age' ? 'femaleAge' : '']?.[metric.subKey] || 0;
                 const end = recent[2].studios[studio]?.[metric.key === 'age' ? 'maleAge' : metric.key]?.[metric.subKey] || 0 + recent[2].studios[studio]?.[metric.key === 'age' ? 'femaleAge' : '']?.[metric.subKey] || 0;
                 
                 // Use combined age values if metric.key is 'age'
                 const combinedStart = metric.key === 'age' ? (recent[0].studios[studio]?.maleAge?.[metric.subKey] || 0) + (recent[0].studios[studio]?.femaleAge?.[metric.subKey] || 0) : start;
                 const combinedEnd = metric.key === 'age' ? (recent[2].studios[studio]?.maleAge?.[metric.subKey] || 0) + (recent[2].studios[studio]?.femaleAge?.[metric.subKey] || 0) : end;

                 const change = combinedEnd - combinedStart;
                 const percent = calculatePercentChange(combinedStart, combinedEnd);

                 if (Math.abs(change) < 3 || Math.abs(parseFloat(percent)) < 15) return; // Ignore small changes

                 const div = document.createElement('div');
                 div.className = 'p-2 bg-white dark:bg-gray-800 rounded shadow-sm border dark:border-gray-600';
                 
                 if (change > 0) {
                     div.innerHTML = `<h5 class="font-bold text-green-700 dark:text-green-400 text-sm">${metric.label}</h5><p class="text-xs text-gray-600 dark:text-gray-300">${combinedStart} ‚Üí ${combinedEnd} (${percent})</p><p class="text-xxs text-gray-400">${period}</p>`;
                     posContainer.appendChild(div); posCount++;
                 } else {
                     div.innerHTML = `<h5 class="font-bold text-red-700 dark:text-red-400 text-sm">${metric.label}</h5><p class="text-xs text-gray-600 dark:text-gray-300">${combinedStart} ‚Üí ${combinedEnd} (${percent})</p><p class="text-xxs text-gray-400">${period}</p>`;
                     negContainer.appendChild(div); negCount++;
                 }
             });

             if (posCount === 0) posContainer.innerHTML = '<p class="text-xs text-gray-500 text-center">Kein Wachstum.</p>';
             if (negCount === 0) negContainer.innerHTML = '<p class="text-xs text-gray-500 text-center">Kein R√ºckgang.</p>';
        }


        // Modified function to accept target element ID and limit
        function renderTopMembersForStudio(checkins, targetElementId, limit = 10) {
            const memberStats = {};
            checkins.forEach(c => {
                const key = `${c.cusNumber} / ${c.name}`;
                memberStats[key] = (memberStats[key] || 0) + 1;
            });
            const sortedMembers = Object.entries(memberStats).sort((a, b) => b[1] - a[1]);

            const topList = DOM.get(targetElementId);
            if (!topList) return;
            topList.innerHTML = ''; // Clear previous content
            
            sortedMembers.slice(0, limit).forEach(([key, count]) => {
                const [cus, ...nameParts] = key.split(' / ');
                const name = nameParts.join(' / ');
                const div = document.createElement('div');
                div.className = 'member-list-item';
                div.innerHTML = `
                    <span class="text-sm"><span class="font-medium">${name}</span><span class="text-xs text-gray-500 block">${cus}</span></span>
                    <span class="font-bold text-red-600 dark:text-red-400">${count} Check-ins</span>`;
                topList.appendChild(div);
            });

             if (sortedMembers.length === 0) {
                 topList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Keine Mitgliederdaten.</p>';
             }
        }


        // ==================== COMPARE TAB LOGIC ====================
        function setupCompareTabSelects() {
            // Populate Studio Selects for Studio vs Studio comparison
             const studios = [...new Set(appState.allCheckins.map(c => c.studio))].sort();
             const studioASelect = DOM.get('compare-studio-A');
             const studioBSelect = DOM.get('compare-studio-B');
             studioASelect.innerHTML = '';
             studioBSelect.innerHTML = '';
             studios.forEach(studio => {
                 studioASelect.innerHTML += `<option value="${studio}">${studio}</option>`;
                 studioBSelect.innerHTML += `<option value="${studio}">${studio}</option>`;
             });
             // Set default different studios if possible
             if (studios.length >= 2) {
                 studioBSelect.value = studios[1];
             }

            // Populate Period Selects for Time vs Time comparison
            const years = [...new Set(appState.allCheckins.map(c => c.timestamp.getFullYear()))].sort((a, b) => b - a);
            const yearHtml = years.map(y => `<option value="${y}">${y}</option>`).join('');
            DOM.get('compare-period-A').innerHTML = createPeriodSelectorHTML('A', yearHtml);
            DOM.get('compare-period-B').innerHTML = createPeriodSelectorHTML('B', yearHtml);

             // Add listeners for period type changes
             document.querySelectorAll('.compare-period-type').forEach(select => {
                 select.addEventListener('change', handleComparePeriodTypeChange);
             });
             
             // Add listeners for compare buttons
             DOM.get('run-time-compare-btn').addEventListener('click', runTimeCompare);
             DOM.get('run-studio-compare-btn').addEventListener('click', runStudioCompare);
             
             // Add listeners for mode buttons
             DOM.get('compare-mode-time').addEventListener('click', () => switchCompareMode('time'));
             DOM.get('compare-mode-studio').addEventListener('click', () => switchCompareMode('studio'));
        }

        function createPeriodSelectorHTML(period, yearOptions) {
             return `
                 <div><label class="block text-xs font-medium mb-1">Typ:</label><select id="period-type-${period}" class="compare-period-type w-full px-2 py-1 border rounded text-sm dark:bg-gray-600" data-period="${period}"><option value="year">Jahr</option><option value="quarter">Quartal</option><option value="month">Monat</option></select></div>
                 <div id="year-selector-${period}"><label class="block text-xs font-medium mb-1">Jahr:</label><select id="year-select-${period}" class="w-full px-2 py-1 border rounded text-sm dark:bg-gray-600">${yearOptions}</select></div>
                 <div id="quarter-selector-${period}" class="hidden"><label class="block text-xs font-medium mb-1">Quartal:</label><select id="quarter-select-${period}" class="w-full px-2 py-1 border rounded text-sm dark:bg-gray-600"><option value="Q1">Q1</option><option value="Q2">Q2</option><option value="Q3">Q3</option><option value="Q4">Q4</option></select></div>
                 <div id="month-selector-${period}" class="hidden"><label class="block text-xs font-medium mb-1">Monat:</label><select id="month-select-${period}" class="w-full px-2 py-1 border rounded text-sm dark:bg-gray-600"><option value="1">Jan</option><option value="2">Feb</option><option value="3">M√§r</option><option value="4">Apr</option><option value="5">Mai</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option></select></div>
             `;
        }
        
        function handleComparePeriodTypeChange(e) {
             const period = e.target.dataset.period;
             const type = e.target.value;
             DOM.get(`quarter-selector-${period}`).classList.toggle('hidden', type !== 'quarter');
             DOM.get(`month-selector-${period}`).classList.toggle('hidden', type !== 'month');
        }
        
         function switchCompareMode(mode) {
             const timeSection = DOM.get('compare-time-section');
             const studioSection = DOM.get('compare-studio-section');
             const timeBtn = DOM.get('compare-mode-time');
             const studioBtn = DOM.get('compare-mode-studio');

             if (mode === 'time') {
                 DOM.show(timeSection);
                 DOM.hide(studioSection);
                 timeBtn.classList.add('bg-sams-red', 'text-white');
                 timeBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                 studioBtn.classList.remove('bg-sams-red', 'text-white');
                 studioBtn.classList.add('bg-gray-200', 'dark:bg-gray-600');
             } else {
                 DOM.hide(timeSection);
                 DOM.show(studioSection);
                 studioBtn.classList.add('bg-sams-red', 'text-white');
                 studioBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                 timeBtn.classList.remove('bg-sams-red', 'text-white');
                 timeBtn.classList.add('bg-gray-200', 'dark:bg-gray-600');
             }
              // Clear previous results when switching modes
             DOM.hide('compare-time-results-container');
             DOM.hide('compare-studio-results-container');
         }

        function getCheckinsForComparePeriod(period) { /* ... (similar to v5.6 getCheckinsForPeriod) ... */ }
        function calculateSimpleStats(checkins) { /* ... (similar to v5.6 calculateSimpleStats) ... */ }

        function runTimeCompare() { /* ... (similar to v5.6 renderCompareResults) ... */ }
        function runStudioCompare() { /* ... (new logic for Studio vs Studio) ... */ }
        function renderCompareResultsTable(containerId, statsA, statsB, labelA, labelB) { /* ... (renders the comparison table) ... */ }

        // ==================== GITHUB SYNC ====================
        function setupGitHubSync() { /* ... (keep existing GitHub sync setup) ... */ }
        function loadGitHubConfig() { /* ... (keep existing logic) ... */ }
        function updateGitHubConfig() { /* ... (keep existing logic) ... */ }
        function setGitHubStatus() { /* ... (keep existing logic) ... */ }
        async function loadFromGitHub() { /* ... (keep existing v5.11 logic) ... */ }
        async function saveToGitHub() { /* ... (keep existing v5.11 logic) ... */ }

        // ==================== HELPER FUNCTIONS ====================
        function parseGermanDate(dateString) { /* ... */ }
        function extractGender(name) { /* ... */ }
        function calculateAge(birthdateStr) { /* ... */ }
        function getAgeGroup(age) { /* ... */ }
        function formatDate(date) { /* ... */ }
        function calculatePercentChange(start, end) { /* ... */ }
        function getDaysInMonth(year, month) { return new Date(year, month, 0).getDate(); }

        // ==================== FULLSCREEN & SHORTCUTS ====================
        function setupFullscreenAndShortcuts() {
             DOM.get('fullscreen-toggle').addEventListener('click', toggleFullscreen);
             document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        function toggleFullscreen() {
             if (!document.fullscreenElement) {
                 document.documentElement.requestFullscreen().catch(err => console.error(`Fullscreen Error: ${err.message}`));
             } else {
                 document.exitFullscreen();
             }
        }

        function handleKeyboardShortcuts(e) {
             const isModalOpen = document.querySelector('.modal.active');
             if (isModalOpen) return; // Don't trigger shortcuts if modal is open

             if (e.ctrlKey || e.metaKey) { // Ctrl or Cmd
                 switch(e.key.toLowerCase()) {
                     case 'o': e.preventDefault(); DOM.get('contacts-input').click(); break; // Open (Upload)
                     case 's': e.preventDefault(); saveToLocalStorage(); break; // Save Local
                     // case 'g': e.preventDefault(); showModal('github-sync-modal'); break; // GitHub Sync (Optional)
                     // case 'e': e.preventDefault(); DOM.get('export-btn').click(); break; // Export JSON (Optional)
                 }
             } else if (e.altKey) { // Alt key
                 switch(e.key.toLowerCase()) {
                     case 'd': e.preventDefault(); toggleDarkMode(); break; // Dark mode
                     case 'f': e.preventDefault(); toggleFullscreen(); break; // Fullscreen
                 }
             }
        }


        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupInitialLoad();
            setupFileHandlers();
            setupTabs();
            setupGitHubSync();
            setupFullscreenAndShortcuts(); // v6.0 Add shortcuts
            loadGitHubConfig(); // Load owner/repo from LS for GitHub sync
            // Set initial dark mode based on preference/localStorage
             if (localStorage.getItem('darkMode') === 'true' || 
                 (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches && localStorage.getItem('darkMode') !== 'false')) {
                 document.documentElement.classList.add('dark');
             } else {
                 document.documentElement.classList.remove('dark');
             }
        });

        // ==================== TAB SWITCHING ====================
        function setupTabs() { /* ... (keep existing tab switching logic) ... */ }
        
        // ==================== EXPORT ====================
        DOM.get('export-btn').addEventListener('click', () => { /* ... (keep existing JSON export logic) ... */ });

    </script>
</body>
</html>

