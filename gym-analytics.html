<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v5.7: Trim-Fix f√ºr GitHub Sync -->
    <title>SAMS GYM Analytics Dashboard v5.7</title>
    
    <meta name="theme-color" content="#DC2626">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'sams-red': '#DC2626',
                        'sams-black': '#1F2937',
                        'sams-gray': '#6B7280',
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        .chart-container { position: relative; height: 400px; }
        .chart-container-small { position: relative; height: 300px; }
        
        .tab-button {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #DC2626;
            color: #DC2626;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .drag-over {
            background-color: #fee2e2 !important;
            border: 2px dashed #DC2626 !important;
        }

        .heatmap-cell {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid #e5e7eb;
            min-width: 50px;
        }
        .heatmap-header {
            background: #1F2937;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .member-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .member-list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold" style="color: #DC2626;">
                        <!-- v5.7: Titel -->
                        üèãÔ∏è SAMS GYM Analytics v5.7
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Analyse-Zeitraum: <span id="period-display" class="font-medium">-</span>
                    </p>
                    <p class="text-sm text-gray-600 mt-1">
                        Letztes Ereignis: <span id="last-event-display" class="font-medium">-</span>
                    </p>
                </div>
                <div class="flex gap-2 mt-4 md:mt-0">
                    <button id="add-data-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg shadow transition">
                        ‚ûï Neue Daten hinzuf√ºgen
                    </button>
                    <button id="export-btn" class="hidden bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg shadow transition">
                        üíæ JSON Export
                    </button>
                    <button id="sync-github-btn" class="text-white px-4 py-2 rounded-lg shadow transition" style="background: #DC2626;">
                        ‚òÅÔ∏è GitHub Sync
                    </button>
                </div>
            </div>

            <!-- Time Period Filter -->
            <div id="time-filter-section" class="hidden bg-white p-4 rounded-xl shadow-md mb-4">
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Zeitraum w√§hlen:</label>
                        <select id="period-type" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="all">Gesamter Zeitraum</option>
                            <option value="year">Jahr</option>
                            <option value="quarter">Quartal</option>
                            <option value="month">Monat</option>
                        </select>
                    </div>
                    <div id="year-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                        <select id="year-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                        </select>
                    </div>
                    <div id="quarter-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                        <select id="quarter-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="Q1">Q1 (Jan-Mar)</option>
                            <option value="Q2">Q2 (Apr-Jun)</option>
                            <option value="Q3">Q3 (Jul-Sep)</option>
                            <option value="Q4">Q4 (Okt-Dez)</option>
                        </select>
                    </div>
                    <div id="month-selector" class="hidden">
                        <label class="block text-sm font-medium mb-1">Monat:</label>
                        <select id="month-select" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="1">Januar</option>
                            <option value="2">Februar</option>
                            <option value="3">M√§rz</option>
                            <option value="4">April</option>
                            <option value="5">Mai</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Dezember</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="apply-filter-btn" class="text-white px-6 py-2 rounded-lg shadow transition font-semibold" style="background: #DC2626;">
                            Filter anwenden
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Initial Load Section -->
        <div id="initial-load-section" class="bg-white p-8 rounded-xl shadow-md mb-8 text-center">
            <div class="mb-6">
                <div class="text-6xl mb-4">üèãÔ∏è</div>
                <h2 class="text-2xl font-bold mb-2">Willkommen beim SAMS GYM Analytics Dashboard</h2>
                <p class="text-gray-600">Lade bestehende Daten oder beginne mit neuen Analysen</p>
            </div>
            
            <div class="flex gap-4 justify-center">
                <button id="load-existing-btn" class="text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                    üìÇ Gespeicherte Daten laden
                </button>
                <button id="start-new-btn" class="bg-gray-800 hover:bg-gray-900 text-white px-8 py-4 rounded-lg shadow-lg transition transform hover:scale-105 font-bold">
                    üÜï Neue Analyse starten
                </button>
            </div>

            <div id="initial-loading" class="hidden mt-6">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p class="mt-2 text-gray-600">Lade Daten von GitHub...</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="hidden bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">üìÅ Daten hochladen</h2>
                <button id="cancel-upload-btn" class="text-gray-600 hover:text-gray-800 text-sm">
                    ‚Üê Zur√ºck zur √úbersicht
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Zoho Contacts Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="contacts-drop-zone">
                    <input type="file" id="contacts-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3" style="color: #DC2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="font-semibold mb-1">Zoho Kontakte (AllContacts.csv)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 hover:underline mb-2" onclick="showExample('contacts'); event.stopPropagation();">
                            üìÑ Beispiel anzeigen
                        </button>
                        <p id="contacts-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>

                <!-- SALTO Events Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-600 transition cursor-pointer" id="events-drop-zone">
                    <input type="file" id="events-input" accept=".csv" class="hidden">
                    <div class="text-gray-600">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <p class="font-semibold mb-1">SALTO Ereignisse (Ereignisliste.csv)</p>
                        <p class="text-sm text-gray-500 mb-2">Klicken oder Drag & Drop</p>
                        <button class="text-xs text-blue-600 hover:underline mb-2" onclick="showExample('events'); event.stopPropagation();">
                            üìÑ Beispiel anzeigen
                        </button>
                        <p id="events-status" class="text-xs mt-2 text-gray-400">Keine Datei</p>
                    </div>
                </div>
            </div>

            <button id="analyze-btn" class="hidden w-full mt-6 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                üöÄ Daten analysieren
            </button>

            <div id="loading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p id="loading-text" class="mt-2 text-gray-600">Daten werden analysiert und in Monate aufgeteilt...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Gesamt Check-ins</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-total-checkins">0</p>
                            <p class="text-xs mt-1" style="color: #DC2626;" id="stat-checkins-trend">-</p>
                        </div>
                        <div class="text-3xl text-red-600 bg-red-100 p-3 rounded-full">üìä</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Durchschn. Check-ins/Tag</p>
                            <p class="text-3xl font-bold text-gray-900" id="stat-avg-daily">0</p>
                            <p class="text-xs text-gray-500 mt-1">√ò pro Tag</p>
                        </div>
                        <div class="text-3xl text-blue-600 bg-blue-100 p-3 rounded-full">üìÖ</div>
                    </div>
                </div>

                <div class="stat-card bg-white p-6 rounded-xl shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Beliebtestes Studio</p>
                            <p class="text-xl font-bold text-gray-900" id="stat-top-studio">-</p>
                            <p class="text-xs text-gray-500 mt-1" id="stat-top-studio-percent">-</p>
                        </div>
                        <div class="text-3xl text-yellow-600 bg-yellow-100 p-3 rounded-full">üèÜ</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="flex overflow-x-auto">
                        <button class="tab-button active px-6 py-4 font-semibold whitespace-nowrap" data-tab="overview">
                            üìä √úbersicht
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="demographics">
                            üë• Demographics
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="utilization">
                            ‚è∞ Auslastung
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="trends">
                            üìà Trends
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="members">
                            üë• Mitglieder
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="compare">
                            üìä Vergleich
                        </button>
                        <button class="tab-button px-6 py-4 font-semibold whitespace-nowrap" data-tab="insights">
                            üí° Insights
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Overview Tab -->
                    <div id="tab-overview" class="tab-content active">
                        <h3 class="text-xl font-bold mb-4">Studio-Auslastung</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Check-ins pro Studio</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-studios"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">T√§gliche Auslastung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-daily"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Demographics Tab -->
                    <div id="tab-demographics" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Mitglieder-Demographics</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio Filter:</label>
                            <select id="demo-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Geschlechterverteilung</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-gender"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Altersgruppen</h4>
                                <div class="chart-container-small">
                                    <canvas id="chart-age"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">Altersgruppen nach Geschlecht</h4>
                            <div class="chart-container-small">
                                <canvas id="chart-age-gender"></canvas>
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-3">Studio-Vergleich</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Studio</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Check-ins</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">M√§nner</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Frauen</th>
                                            <th class="px-4 py-3 text-left text-xs font-semibold uppercase">√ò Alter</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studio-comparison-table" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Utilization Tab -->
                    <div id="tab-utilization" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Auslastung nach Studio & Zeit</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="util-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Durchschnittliche Auslastung nach Wochentag</h4>
                                <p class="text-xs text-gray-500 mb-3">Durchschnitt pro Wochentag im gew√§hlten Zeitraum</p>
                                <div class="chart-container-small">
                                    <canvas id="chart-weekday-util"></canvas>
                                </div>
                            </div>

                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3">Peak Hours Heatmap</h4>
                                <div class="overflow-x-auto">
                                    <table id="heatmap-table" class="min-w-full">
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trends Tab -->
                    <div id="tab-trends" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Monatliche Trend-Analyse</h3>
                        
                        <div id="trends-info" class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-900">
                                üìä <strong id="trends-period-count">0</strong> Monate analysiert | 
                                Zeitraum: <strong id="trends-date-range">-</strong>
                            </p>
                            <p class="text-sm text-blue-900 mt-2 font-medium" id="trends-total-percent">
                                Gesamttrend (letzte 3 Mon.): -
                            </p>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="trends-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>

                        <!-- Total Check-ins Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üìà Check-ins pro Monat</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-total"></canvas>
                            </div>
                        </div>

                        <!-- Gender Trends -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë• M√§nner vs. Frauen (monatlich)</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-gender"></canvas>
                            </div>
                        </div>

                        <!-- Male Age Groups Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë® M√§nner nach Altersgruppen</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-male-age"></canvas>
                            </div>
                        </div>

                        <!-- Female Age Groups Trend -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-semibold mb-3">üë© Frauen nach Altersgruppen</h4>
                            <div class="chart-container">
                                <canvas id="chart-trends-female-age"></canvas>
                            </div>
                        </div>

                        <!-- Trend Alerts -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Positive Trends -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-green-800">üìà Positive Trends (Wachstum)</h4>
                                <div id="trend-alerts-positive" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4">Kein signifikantes Wachstum erkannt.</p>
                                </div>
                            </div>
                            
                            <!-- Negative Trends -->
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-red-800">üìâ Negative Trends (R√ºckgang)</h4>
                                <div id="trend-alerts-negative" class="space-y-3">
                                    <p class="text-gray-500 text-center py-4">Keine signifikanten R√ºckg√§nge erkannt.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mitglieder-Tab -->
                    <div id="tab-members" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Top 20 Mitglieder</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen:</label>
                            <select id="member-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="all">Alle Studios (Gesamt)</option>
                            </select>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-6">Zeigt die aktivsten Mitglieder im aktuell gefilterten Zeitraum und Studio.</p>

                        <div class="grid grid-cols-1 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold mb-3 text-gray-800">üèÜ Top 20 Mitglieder</h4>
                                <div id="top-members-list" class="space-y-2">
                                    <!-- JS f√ºllt diesen Bereich -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vergleichs-Tab -->
                    <div id="tab-compare" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Zeitraum-Vergleich</h3>
                        <p class="text-sm text-gray-600 mb-6">W√§hle zwei Zeitr√§ume und optional ein Studio aus, um die Kennzahlen zu vergleichen.</p>

                        <!-- v5.6: Studio-Filter hinzugef√ºgt -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Studio w√§hlen (optional):</label>
                            <select id="compare-studio-filter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="all">Alle Studios (Gesamt)</option>
                                <!-- Optionen werden per JS hinzugef√ºgt -->
                            </select>
                        </div>

                        <!-- Filter-Auswahl -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 p-4 bg-gray-50 rounded-lg">
                            <!-- Zeitraum A -->
                            <div>
                                <h4 class="font-semibold text-lg mb-3" style="color: #DC2626;">Zeitraum A (Basis)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Typ:</label>
                                        <select id="period-type-A" class="compare-period-type w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" data-period="A">
                                            <option value="all">Gesamter Zeitraum</option>
                                            <option value="year">Jahr</option>
                                            <option value="quarter">Quartal</option>
                                            <option value="month">Monat</option>
                                        </select>
                                    </div>
                                    <div id="year-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                                        <select id="year-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"></select>
                                    </div>
                                    <div id="quarter-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                                        <select id="quarter-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="Q1">Q1 (Jan-Mar)</option>
                                            <option value="Q2">Q2 (Apr-Jun)</option>
                                            <option value="Q3">Q3 (Jul-Sep)</option>
                                            <option value="Q4">Q4 (Okt-Dez)</option>
                                        </select>
                                    </div>
                                    <div id="month-selector-A" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Monat:</label>
                                        <select id="month-select-A" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="1">Januar</option><option value="2">Februar</option><option value="3">M√§rz</option><option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">August</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- Zeitraum B -->
                            <div>
                                <h4 class="font-semibold text-lg mb-3 text-blue-600">Zeitraum B (Vergleich)</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Typ:</label>
                                        <select id="period-type-B" class="compare-period-type w-full px-4 py-2 border border-gray-300 rounded-lg bg-white" data-period="B">
                                            <option value="all">Gesamter Zeitraum</option>
                                            <option value="year">Jahr</option>
                                            <option value="quarter">Quartal</option>
                                            <option value="month">Monat</option>
                                        </select>
                                    </div>
                                    <div id="year-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Jahr:</label>
                                        <select id="year-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white"></select>
                                    </div>
                                    <div id="quarter-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Quartal:</label>
                                        <select id="quarter-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="Q1">Q1 (Jan-Mar)</option>
                                            <option value="Q2">Q2 (Apr-Jun)</option>
                                            <option value="Q3">Q3 (Jul-Sep)</option>
                                            <option value="Q4">Q4 (Okt-Dez)</option>
                                        </select>
                                    </div>
                                    <div id="month-selector-B" class="hidden">
                                        <label class="block text-sm font-medium mb-1">Monat:</label>
                                        <select id="month-select-B" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                            <option value="1">Januar</option><option value="2">Februar</option><option value="3">M√§rz</option><option value="4">April</option><option value="5">Mai</option><option value="6">Juni</option><option value="7">Juli</option><option value="8">August</option><option value="9">September</option><option value="10">Oktober</option><option value="11">November</option><option value="12">Dezember</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="run-compare-btn" class="w-full text-white font-bold py-4 px-6 rounded-lg shadow-lg transition transform hover:scale-105" style="background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);">
                            üìä Vergleichen
                        </button>

                        <!-- Ergebnis-Sektion -->
                        <div id="compare-results-section" class="hidden mt-8">
                            <h3 class="text-xl font-bold mb-4">Vergleichs-Ergebnis</h3>
                            <div class="overflow-x-auto bg-white rounded-lg shadow">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-800 text-white">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-semibold uppercase">Metrik</th>
                                            <th class="px-6 py-3 text-right text-xs font-semibold uppercase">Zeitraum A</th>
                                            <th class="px-6 py-3 text-right text-xs font-semibold uppercase">Zeitraum B</th>
                                            <th class="px-6 py-3 text-right text-xs font-semibold uppercase">Ver√§nderung</th>
                                        </tr>
                                    </thead>
                                    <tbody id="compare-results-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Zeilen werden per JS eingef√ºgt -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Insights Tab -->
                    <div id="tab-insights" class="tab-content">
                        <h3 class="text-xl font-bold mb-4">Actionable Insights & Empfehlungen</h3>
                        <div id="insights-container" class="space-y-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Example Modals -->
    <div id="example-modal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold" id="example-title">Beispiel</h3>
                <button onclick="closeModal('example-modal')" class="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
            </div>
            <div id="example-content"></div>
        </div>
    </div>

    <!-- GitHub Sync Modal -->
    <div id="github-modal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold">‚òÅÔ∏è GitHub Sync</h3>
                <button onclick="closeModal('github-modal')" class="text-gray-600 hover:text-gray-800 text-2xl">√ó</button>
            </div>
            
            <p class="text-sm text-gray-600 mb-2">Speichere oder lade deine Analysedaten als `analysis-data.json` in deinem GitHub-Repo.</p>
            <p class="text-sm text-gray-600 mb-4">Dein Token wird nur im Browser gespeichert und nie an Dritte gesendet.</p>

            <div class="mb-4">
                <label for="github-status" class="block text-sm font-medium mb-1">Status:</label>
                <input type="text" id="github-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
            </div>
            
            <div class="mb-4">
                <label for="github-owner" class="block text-sm font-medium mb-1">Repo-Besitzer (z.B. "sam-ux-sack"):</label>
                <input type="text" id="github-owner" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="sam-ux-sack">
            </div>
            <div class="mb-4">
                <label for="github-repo" class="block text-sm font-medium mb-1">Repo-Name (z.B. "sams-gym-data"):</label>
                <input type="text" id="github-repo" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="sams-gym-data">
            </div>
            <div class="mb-4">
                <label for="github-token" class="block text-sm font-medium mb-1">GitHub Personal Access Token (classic):</label>
                <input type="password" id="github-token" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="ghp_...">
                <a href="https://github.com/settings/tokens/new?scopes=repo&description=SAMS-GYM-Analytics" target="_blank" class="text-xs text-blue-600 hover:underline">Neuen Token erstellen (mit "repo" Rechten)</a>
            </div>

            <div id="github-loading" class="hidden text-center my-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: #DC2626;"></div>
                <p class="mt-2 text-gray-600" id="github-loading-text">Aktion wird ausgef√ºhrt...</p>
            </div>
            
            <div id="github-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg my-4">
            </div>

            <div class="flex gap-4">
                <button id="github-load-btn" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg shadow transition font-semibold">
                    Laden
                </button>
                <button id="github-save-btn" class="flex-1 text-white px-6 py-3 rounded-lg shadow transition font-semibold" style="background: #DC2626;">
                    Speichern
                </button>
            </div>
        </div>
    </div>


    <script>
        // ==================== CONFIGURATION ====================
        const AGE_GROUPS = ['<20', '20-40', '40-60', '60+'];
        const AGE_GROUP_COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#8b5cf6'];

        const MAIN_DOORS = {
            'Susten Hauptt√ºre': 'Susten GYM',
            'Strongman rechts': 'Susten CrossGYM',
            'Visp S√ºd - Eingang': 'Visp-S√ºd',
            'Visp Center - Eingang': 'Visp-Center'
        };

        // ==================== DATA STORAGE ====================
        let contactsData = null;
        let eventsData = null;
        let allCheckins = [];
        let filteredCheckins = [];
        let analysisResults = null;
        let monthlyTrends = [];
        let charts = {};
        
        let githubConfig = {
            owner: 'sam-ux-sack',
            repo: 'sams-gym-data',
            token: null,
            filePath: 'analysis-data.json'
        };
        let githubDataSha = null;
        let lastLoadedTimestamp = null;

        // ==================== HELPER FUNCTIONS ====================
        function extractGender(name) {
            if (name.startsWith('Herr')) return 'M√§nnlich';
            if (name.startsWith('Frau')) return 'Weiblich';
            return 'Unknown'; // Bleibt bestehen, falls Zoho-Daten unsauber sind
        }

        function getAgeGroup(age) {
            if (age === null) return null;
            if (age < 20) return '<20';
            if (age < 40) return '20-40';
            if (age < 60) return '40-60';
            return '60+';
        }

        function calculateAge(birthdate) {
            if (!birthdate) return null;
            let birth;
            if (birthdate.includes('.')) { // TT.MM.JJJJ
                const parts = birthdate.split('.');
                if (parts.length === 3) {
                    birth = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            } else if (birthdate.includes('-')) { // JJJJ-MM-TT
                birth = new Date(birthdate);
            }
            
            if (!birth || isNaN(birth)) {
                birth = new Date(birthdate);
            }

            if (!birth || isNaN(birth)) return null;
            
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function formatDate(date) {
            if (!date) return '-';
            return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatDateTime(date) {
            if (!date) return '-';
            return date.toLocaleString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) + ' Uhr';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ==================== EXAMPLE DATA ====================
        function showExample(type) {
            const modal = document.getElementById('example-modal');
            const title = document.getElementById('example-title');
            const content = document.getElementById('example-content');

            if (type === 'contacts') {
                title.textContent = 'Beispiel: Zoho Kontakte CSV';
                content.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Erforderliche Spalten:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Kundennummer</strong> oder <strong>CUSTOMER_ID</strong> - z.B. "CUS-12345"</li>
                            <li><strong>Name</strong> - z.B. "Herr Max M√ºller" oder "Frau Anna Schmidt"</li>
                            <li><strong>Geburtsdatum</strong> - Format: TT.MM.JJJJ oder JJJJ-MM-TT</li>
                        </ul>
                    </div>
                `;
            } else {
                title.textContent = 'Beispiel: SALTO Ereignisse CSV';
                content.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">
                        <h4 class="font-semibold mb-2">Format:</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Spalte 1:</strong> Zeitstempel (TT.MM.JJJJ HH:MM:SS)</li>
                            <li><strong>Spalte 2:</strong> Event-Type (wird ignoriert)</li>
                            <li><strong>Spalte 3:</strong> T√ºrname - Muss exakt einer dieser Werte sein:
                                <ul class="list-circle list-inside ml-6 mt-1">
                                    <li>"Susten Hauptt√ºre"</li>
                                    <li>"Strongman rechts"</li>
                                    <li>"Visp S√ºd - Eingang"</li>
                                    <li>"Visp Center - Eingang"</li>
                                </ul>
                            </li>
                            <li><strong>Spalte 4:</strong> Leer</li>
                            <li><strong>Spalte 5:</strong> CUS-Nummer (z.B. "CUS-12345")</li>
                        </ul>
                    </div>
                `;
            }

            modal.classList.add('active');
        }

        // ==================== INITIAL LOAD ====================
        function setupInitialLoad() {
            document.getElementById('load-existing-btn').addEventListener('click', () => {
                document.getElementById('github-modal').classList.add('active');
            });
            document.getElementById('start-new-btn').addEventListener('click', startNewAnalysis);
            
            document.getElementById('cancel-upload-btn').addEventListener('click', () => {
                if (allCheckins.length > 0) {
                    document.getElementById('upload-section').classList.add('hidden');
                    document.getElementById('results-section').classList.remove('hidden');
                } else {
                    document.getElementById('upload-section').classList.add('hidden');
                    document.getElementById('initial-load-section').classList.remove('hidden');
                }
            });
            document.getElementById('add-data-btn').addEventListener('click', () => {
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('upload-section').classList.remove('hidden');
            });
        }

        function startNewAnalysis() {
            allCheckins = [];
            monthlyTrends = [];
            filteredCheckins = [];
            analysisResults = null;
            githubDataSha = null;
            lastLoadedTimestamp = null;
            
            updateDataStatus('Lokal (nicht gespeichert)');
            document.getElementById('period-display').textContent = '-';
            document.getElementById('last-event-display').textContent = '-';
            document.getElementById('time-filter-section').classList.add('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('add-data-btn').classList.add('hidden');
            document.getElementById('export-btn').classList.add('hidden');
            
            contactsData = null;
            eventsData = null;
            document.getElementById('contacts-status').textContent = 'Keine Datei';
            document.getElementById('events-status').textContent = 'Keine Datei';
            document.getElementById('contacts-status').classList.remove('text-green-600');
            document.getElementById('events-status').classList.remove('text-green-600');
            document.getElementById('analyze-btn').classList.add('hidden');

            document.getElementById('initial-load-section').classList.add('hidden');
            document.getElementById('upload-section').classList.remove('hidden');
        }


        // ==================== FILE UPLOAD HANDLERS ====================
        function setupFileHandlers() {
            const contactsZone = document.getElementById('contacts-drop-zone');
            const contactsInput = document.getElementById('contacts-input');
            
            contactsZone.addEventListener('click', () => contactsInput.click());
            contactsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'contacts'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                contactsZone.addEventListener(eventName, preventDefaults);
            });
            contactsZone.addEventListener('dragover', () => contactsZone.classList.add('drag-over'));
            contactsZone.addEventListener('dragleave', () => contactsZone.classList.remove('drag-over'));
            contactsZone.addEventListener('drop', (e) => {
                contactsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'contacts');
            });

            const eventsZone = document.getElementById('events-drop-zone');
            const eventsInput = document.getElementById('events-input');
            
            eventsZone.addEventListener('click', () => eventsInput.click());
            eventsInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0], 'events'));
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                eventsZone.addEventListener(eventName, preventDefaults);
            });
            eventsZone.addEventListener('dragover', () => eventsZone.classList.add('drag-over'));
            eventsZone.addEventListener('dragleave', () => eventsZone.classList.remove('drag-over'));
            eventsZone.addEventListener('drop', (e) => {
                eventsZone.classList.remove('drag-over');
                handleFileSelect(e.dataTransfer.files[0], 'events');
            });

            document.getElementById('analyze-btn').addEventListener('click', analyzeData);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleFileSelect(file, type) {
            if (!file || !file.name.endsWith('.csv')) {
                alert('Bitte eine CSV-Datei ausw√§hlen!');
                return;
            }

            const statusEl = document.getElementById(`${type}-status`);
            statusEl.textContent = `‚úì ${file.name}`;
            statusEl.classList.add('text-green-600');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (type === 'contacts') {
                        contactsData = results.data;
                        console.log('Contacts loaded:', contactsData.length);
                    } else {
                        eventsData = results.data;
                        console.log('Events loaded:', eventsData.length);
                    }
                    
                    if (contactsData && eventsData) {
                        document.getElementById('analyze-btn').classList.remove('hidden');
                    }
                }
            });
        }

        // ==================== DATA ANALYSIS ====================
        function analyzeData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('analyze-btn').classList.add('hidden');
            document.getElementById('loading-text').textContent = 'Analysiere Kontakte...';

            let mergeDate = null;
            if (lastLoadedTimestamp) {
                mergeDate = new Date(lastLoadedTimestamp);
                console.log('Merging new data since:', mergeDate);
            }

            setTimeout(() => {
                const contactsLookup = {};
                contactsData.forEach(contact => {
                    const cusNumber = contact['Kundennummer'] || contact['CUSTOMER_ID'];
                    if (cusNumber) {
                        contactsLookup[cusNumber] = {
                            name: contact['Name'] || '',
                            birthdate: contact['Geburtsdatum'] || '',
                            gender: extractGender(contact['Name'] || ''),
                            age: calculateAge(contact['Geburtsdatum'] || '')
                        };
                    }
                });

                document.getElementById('loading-text').textContent = 'Verarbeite SALTO-Ereignisse...';

                let newCheckins = [];
                eventsData.forEach(event => {
                    const cols = Object.values(event);
                    if (cols.length < 5) return;

                    const timestamp = cols[0];
                    const doorName = cols[2];
                    const cusNumber = cols[4];

                    if (!MAIN_DOORS[doorName]) return;
                    if (!cusNumber || !cusNumber.startsWith('CUS-')) return;
                    
                    const contact = contactsLookup[cusNumber];
                    if (!contact) return; // v5.5: Filtert Personal/unbekannte CUS-Nummern

                    let date = null;
                    if (timestamp.includes('.')) { // TT.MM.JJJJ HH:MM:SS
                        const parts = timestamp.split(' ');
                        const dateParts = parts[0].split('.');
                        const timeParts = parts[1].split(':');
                        if (dateParts.length === 3 && timeParts.length === 3) {
                            date = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
                        }
                    }
                    
                    if (!date || isNaN(date)) {
                        date = new Date(timestamp);
                    }
                    
                    if (isNaN(date)) return;

                    if (mergeDate && date <= mergeDate) {
                        return;
                    }

                    const studio = MAIN_DOORS[doorName];
                    const age = contact.age || null;

                    newCheckins.push({
                        timestamp: date.toISOString(),
                        studio,
                        cusNumber,
                        gender: contact.gender || 'Unknown', // Keep 'Unknown' for bad Zoho data
                        age: age,
                        ageGroup: getAgeGroup(age),
                        dateKey: date.toISOString().split('T')[0],
                        hour: date.getHours(),
                        day: date.getDay()
                    });
                });

                allCheckins.push(...newCheckins);
                
                allCheckins = allCheckins.map(c => ({
                    ...c,
                    timestamp: new Date(c.timestamp) 
                }));

                allCheckins.sort((a, b) => a.timestamp - b.timestamp);
                
                if (allCheckins.length > 0) {
                    lastLoadedTimestamp = allCheckins[allCheckins.length - 1].timestamp.toISOString();
                }

                document.getElementById('loading-text').textContent = 'Erstelle monatliche Trends...';

                setTimeout(() => {
                    generateMonthlyTrends();

                    filteredCheckins = [...allCheckins];
                    processAnalysis();

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('results-section').classList.remove('hidden');
                    document.getElementById('time-filter-section').classList.remove('hidden');
                    document.getElementById('export-btn').classList.remove('hidden');
                    document.getElementById('add-data-btn').classList.remove('hidden');
                    document.getElementById('upload-section').classList.add('hidden');
                    
                    updateDataStatus('Lokal (nicht auf GitHub gespeichert)');

                    setupTimeFilters();
                    setupTrendsFilters();
                    renderTrendCharts('all');
                    analyzeTrendAlerts();
                }, 50);

            }, 50);
        }

        // ==================== MONTHLY TRENDS GENERATION ====================
        function generateMonthlyTrends() {
            const monthlyData = {};

            if (allCheckins.length === 0) {
                monthlyTrends = [];
                return;
            }
            const firstDate = allCheckins[0].timestamp;
            const lastDate = allCheckins[allCheckins.length - 1].timestamp;

            let currentDate = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
            
            while (currentDate <= lastDate) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const key = `${year}-${String(month + 1).padStart(2, '0')}`;

                const studios = {};
                Object.values(MAIN_DOORS).forEach(studioName => {
                    const ageGroups = {};
                    AGE_GROUPS.forEach(g => {
                        ageGroups[g] = { male: 0, female: 0, other: 0 };
                    });
                    
                    studios[studioName] = {
                        total: 0,
                        male: 0,
                        female: 0,
                        other: 0, // Still track internally for calculation robustness
                        ageGroups: ageGroups
                    };
                });
                
                monthlyData[key] = {
                    period: key,
                    year: year,
                    month: month + 1,
                    studios: studios
                };

                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            allCheckins.forEach(c => {
                const year = c.timestamp.getFullYear();
                const month = c.timestamp.getMonth();
                const key = `${year}-${String(month + 1).padStart(2, '0')}`;

                const monthStats = monthlyData[key];
                if (!monthStats) return; 
                
                const studioStats = monthStats.studios[c.studio];
                if (!studioStats) return;

                studioStats.total++;
                
                if (c.gender === 'M√§nnlich') {
                    studioStats.male++;
                    if (c.ageGroup) {
                        studioStats.ageGroups[c.ageGroup].male++;
                    }
                } else if (c.gender === 'Weiblich') {
                    studioStats.female++;
                    if (c.ageGroup) {
                        studioStats.ageGroups[c.ageGroup].female++;
                    }
                } else {
                    studioStats.other++;
                    if (c.ageGroup) {
                        studioStats.ageGroups[c.ageGroup].other++;
                    }
                }
            });

            const lastMonthKey = Object.keys(monthlyData).pop();
            if (lastMonthKey) {
                const lastMonthData = monthlyData[lastMonthKey];
                const today = new Date();
                const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                const currentDay = today.getDate();
                
                if (lastMonthData.year === today.getFullYear() && lastMonthData.month === today.getMonth() + 1 && currentDay < daysInMonth) {
                    const factor = daysInMonth / currentDay;
                    lastMonthData.isProjected = true; 
                    
                    Object.values(lastMonthData.studios).forEach(studio => {
                        studio.total = Math.round(studio.total * factor);
                        studio.male = Math.round(studio.male * factor);
                        studio.female = Math.round(studio.female * factor);
                        studio.other = Math.round(studio.other * factor);
                        
                        AGE_GROUPS.forEach(g => {
                            studio.ageGroups[g].male = Math.round(studio.ageGroups[g].male * factor);
                            studio.ageGroups[g].female = Math.round(studio.ageGroups[g].female * factor);
                            studio.ageGroups[g].other = Math.round(studio.ageGroups[g].other * factor);
                        });
                    });
                }
            }

            monthlyTrends = Object.values(monthlyData);
            console.log('Monthly trends generated (Optimized):', monthlyTrends.length, 'months');
        }


        function processAnalysis() {
            const studioStats = {};
            const dailyStats = {};
            const hourlyStats = {};
            const weekdayStats = {};

            filteredCheckins.forEach(c => {
                studioStats[c.studio] = (studioStats[c.studio] || 0) + 1;
                dailyStats[c.dateKey] = (dailyStats[c.dateKey] || 0) + 1;
                
                const hourKey = `${c.day}-${c.hour}`;
                hourlyStats[hourKey] = (hourlyStats[hourKey] || 0) + 1;
                
                weekdayStats[c.day] = (weekdayStats[c.day] || 0) + 1;
            });

            const startDate = filteredCheckins[0]?.timestamp;
            const endDate = filteredCheckins[filteredCheckins.length - 1]?.timestamp;

            analysisResults = {
                checkins: filteredCheckins,
                studioStats,
                dailyStats,
                hourlyStats,
                weekdayStats,
                startDate,
                endDate
            };

            renderResults();
        }

        // ==================== TIME FILTERS ====================
        function setupTimeFilters() {
            const periodType = document.getElementById('period-type');
            const yearSelector = document.getElementById('year-selector');
            const quarterSelector = document.getElementById('quarter-selector');
            const monthSelector = document.getElementById('month-selector');
            const applyBtn = document.getElementById('apply-filter-btn');

            const years = [...new Set(allCheckins.map(c => c.timestamp.getFullYear()))].sort();
            const yearSelect = document.getElementById('year-select');
            yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            periodType.addEventListener('change', () => {
                const type = periodType.value;
                yearSelector.classList.toggle('hidden', type === 'all');
                quarterSelector.classList.toggle('hidden', type !== 'quarter');
                monthSelector.classList.toggle('hidden', type !== 'month');
            });

            applyBtn.addEventListener('click', applyTimeFilter);

            setupCompareFilters(years);
        }

        function applyTimeFilter() {
            const periodType = document.getElementById('period-type').value;
            const year = parseInt(document.getElementById('year-select').value);
            const quarter = document.getElementById('quarter-select').value;
            const month = parseInt(document.getElementById('month-select').value);

            const settings = { periodType, year, quarter, month };
            filteredCheckins = getFilteredCheckins(settings);

            processAnalysis();
        }

        // v5.6: Studio Filter hinzugef√ºgt
        function getFilteredCheckins(settings, studioFilter = 'all') {
            const { periodType, year, quarter, month } = settings;
            let baseCheckins = [...allCheckins];

            // Filter by Studio first if specified
            if (studioFilter !== 'all') {
                baseCheckins = baseCheckins.filter(c => c.studio === studioFilter);
            }

            // Then filter by time period
            if (periodType === 'all') {
                return baseCheckins;
            }
            if (periodType === 'year') {
                return baseCheckins.filter(c => c.timestamp.getFullYear() === year);
            }
            if (periodType === 'quarter') {
                const qMap = { 'Q1': [0, 1, 2], 'Q2': [3, 4, 5], 'Q3': [6, 7, 8], 'Q4': [9, 10, 11] };
                const months = qMap[quarter];
                return baseCheckins.filter(c => 
                    c.timestamp.getFullYear() === year && months.includes(c.timestamp.getMonth())
                );
            }
            if (periodType === 'month') {
                const monthIdx = month - 1;
                return baseCheckins.filter(c => 
                    c.timestamp.getFullYear() === year && c.timestamp.getMonth() === monthIdx
                );
            }
            return []; // Should not happen
        }
        
        // v5.6: Studio Filter hinzugef√ºgt
        function setupCompareFilters(years) {
            if (years.length === 0) return;
            
            const yearSelectA = document.getElementById('year-select-A');
            const yearSelectB = document.getElementById('year-select-B');
            const yearOptions = years.map(y => `<option value="${y}">${y}</option>`).join('');
            yearSelectA.innerHTML = yearOptions;
            yearSelectB.innerHTML = yearOptions;

            // Populate compare studio filter
            const compareStudioFilter = document.getElementById('compare-studio-filter');
            const studioOptions = Object.values(MAIN_DOORS)
                                      .map(studio => `<option value="${studio}">${studio}</option>`)
                                      .join('');
            compareStudioFilter.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>' + studioOptions;


            if (years.length > 0) {
                document.getElementById('period-type-A').value = 'year';
                document.getElementById('year-selector-A').classList.remove('hidden');
                yearSelectA.value = years[years.length - 2] || years[0];
                
                document.getElementById('period-type-B').value = 'year';
                document.getElementById('year-selector-B').classList.remove('hidden');
                yearSelectB.value = years[years.length - 1] || years[0];
            }

            document.querySelectorAll('.compare-period-type').forEach(select => {
                select.addEventListener('change', (e) => {
                    const period = e.target.dataset.period; // 'A' or 'B'
                    const type = e.target.value;
                    document.getElementById(`year-selector-${period}`).classList.toggle('hidden', type === 'all');
                    document.getElementById(`quarter-selector-${period}`).classList.toggle('hidden', type !== 'quarter');
                    document.getElementById(`month-selector-${period}`).classList.toggle('hidden', type !== 'month');
                });
            });

            document.getElementById('run-compare-btn').addEventListener('click', runComparison);
        }

        // v5.6: Studio Filter hinzugef√ºgt
        function runComparison() {
            const studioFilter = document.getElementById('compare-studio-filter').value;
            
            const settingsA = {
                periodType: document.getElementById('period-type-A').value,
                year: parseInt(document.getElementById('year-select-A').value),
                quarter: document.getElementById('quarter-select-A').value,
                month: parseInt(document.getElementById('month-select-A').value)
            };
            const settingsB = {
                periodType: document.getElementById('period-type-B').value,
                year: parseInt(document.getElementById('year-select-B').value),
                quarter: document.getElementById('quarter-select-B').value,
                month: parseInt(document.getElementById('month-select-B').value)
            };

            const checkinsA = getFilteredCheckins(settingsA, studioFilter);
            const checkinsB = getFilteredCheckins(settingsB, studioFilter);

            const statsA = calculateSimpleStats(checkinsA);
            const statsB = calculateSimpleStats(checkinsB);

            renderCompareResults(statsA, statsB);
            document.getElementById('compare-results-section').classList.remove('hidden');
        }

        // v5.6: Unbekannt entfernt / FIX
        function calculateSimpleStats(checkins) {
            if (checkins.length === 0) {
                return {
                    total: 0, avgDaily: 0, male: 0, female: 0,
                    ageGroups: { '<20': 0, '20-40': 0, '40-60': 0, '60+': 0 }
                };
            }
            
            const dailyStats = {};
            let male = 0;
            let female = 0;
            const ageGroups = { '<20': 0, '20-40': 0, '40-60': 0, '60+': 0 };

            checkins.forEach(c => {
                dailyStats[c.dateKey] = (dailyStats[c.dateKey] || 0) + 1;
                
                if (c.gender === 'M√§nnlich') male++;
                else if (c.gender === 'Weiblich') female++;
                // 'Unknown' wird ignoriert

                if (c.ageGroup) {
                    ageGroups[c.ageGroup]++;
                }
            });

            const daysCount = Object.keys(dailyStats).length;
            const avgDaily = daysCount > 0 ? (checkins.length / daysCount) : 0;

            return {
                total: checkins.length,
                avgDaily: avgDaily,
                male: male,
                female: female,
                ageGroups: ageGroups
            };
        }

        // v5.6: Unbekannt entfernt / FIX
        function renderCompareResults(statsA, statsB) {
            const tbody = document.getElementById('compare-results-table');
            tbody.innerHTML = '';

            const formatPercent = (a, b) => {
                if (a === 0) {
                    return b > 0 ? '<span class="text-green-600 font-bold">NEU</span>' : '-';
                }
                if (b === 0) {
                    return a > 0 ? '<span class="text-red-600 font-bold">-100.0%</span>' : '-';
                }
                const percent = ((b - a) / a) * 100;
                const color = percent >= 0 ? 'text-green-600' : 'text-red-600';
                const sign = percent >= 0 ? '+' : '';
                return `<span class="${color} font-bold">${sign}${percent.toFixed(1)}%</span>`;
            };
            
            const createRow = (label, valueA, valueB, isAvg = false) => {
                const valA_str = isAvg ? valueA.toFixed(1) : valueA.toLocaleString('de-DE');
                const valB_str = isAvg ? valueB.toFixed(1) : valueB.toLocaleString('de-DE');
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${label}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-700">${valA_str}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-gray-700">${valB_str}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${formatPercent(valueA, valueB)}</td>
                    </tr>
                `;
            };
            
            tbody.innerHTML += createRow('Gesamt Check-ins', statsA.total, statsB.total);
            tbody.innerHTML += createRow('√ò Check-ins / Tag', statsA.avgDaily, statsB.avgDaily, true);
            
            tbody.innerHTML += '<tr class="bg-gray-50"><td colspan="4" class="py-2"></td></tr>';
            
            tbody.innerHTML += createRow('M√§nner', statsA.male, statsB.male);
            tbody.innerHTML += createRow('Frauen', statsA.female, statsB.female);
            
            tbody.innerHTML += '<tr class="bg-gray-50"><td colspan="4" class="py-2"></td></tr>';

            AGE_GROUPS.forEach(group => {
                tbody.innerHTML += createRow(`Altersgruppe ${group}`, statsA.ageGroups[group], statsB.ageGroups[group]);
            });
        }


        // ==================== TRENDS FILTERS ====================
        function setupTrendsFilters() {
            const filterSelect = document.getElementById('trends-studio-filter');
            const studios = Object.values(MAIN_DOORS);
            
            filterSelect.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>';
            studios.forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });

            filterSelect.addEventListener('change', (e) => {
                renderTrendCharts(e.target.value);
                analyzeTrendAlerts();
            });

            if (monthlyTrends.length > 0) {
                document.getElementById('trends-period-count').textContent = monthlyTrends.length;
                const firstMonth = monthlyTrends[0];
                const lastMonth = monthlyTrends[monthlyTrends.length - 1];
                document.getElementById('trends-date-range').textContent = `${firstMonth.period} - ${lastMonth.period}`;
            }
        }

        // ==================== TREND CHARTS ====================
        function renderTrendCharts(studioFilter) {
            const labels = monthlyTrends.map(m => m.isProjected ? `${m.period} (Hochr.)` : m.period);
            
            renderTrendTotalChart(labels, studioFilter);
            renderTrendGenderChart(labels, studioFilter);
            renderTrendMaleAgeChart(labels, studioFilter);
            renderTrendFemaleAgeChart(labels, studioFilter);
        }

        function getAggregatedMonthlyData(studioFilter, dataExtractor) {
            return monthlyTrends.map(m => {
                if (studioFilter === 'all') {
                    return Object.values(m.studios).reduce((sum, s) => sum + dataExtractor(s), 0);
                } else {
                    return m.studios[studioFilter] ? dataExtractor(m.studios[studioFilter]) : 0;
                }
            });
        }

        function renderTrendTotalChart(labels, studioFilter) {
            const ctx = document.getElementById('chart-trends-total');
            if (charts.trendsTotal) charts.trendsTotal.destroy();

            const data = getAggregatedMonthlyData(studioFilter, (s) => s.total);

            charts.trendsTotal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Check-ins',
                        data,
                        borderColor: '#DC2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTrendGenderChart(labels, studioFilter) {
            const ctx = document.getElementById('chart-trends-gender');
            if (charts.trendsGender) charts.trendsGender.destroy();

            const maleData = getAggregatedMonthlyData(studioFilter, (s) => s.male);
            const femaleData = getAggregatedMonthlyData(studioFilter, (s) => s.female);

            charts.trendsGender = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'M√§nner',
                            data: maleData,
                            borderColor: '#1F2937',
                            fill: false,
                            tension: 0.4
                        },
                        {
                            label: 'Frauen',
                            data: femaleData,
                            borderColor: '#DC2626',
                            fill: false,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTrendMaleAgeChart(labels, studioFilter) {
            const ctx = document.getElementById('chart-trends-male-age');
            if (charts.trendsMaleAge) charts.trendsMaleAge.destroy();

            const datasets = AGE_GROUPS.map((group, idx) => ({
                label: group,
                data: getAggregatedMonthlyData(studioFilter, (s) => s.ageGroups[group].male),
                borderColor: AGE_GROUP_COLORS[idx],
                fill: false,
                tension: 0.4
            }));

            charts.trendsMaleAge = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderTrendFemaleAgeChart(labels, studioFilter) {
            const ctx = document.getElementById('chart-trends-female-age');
            if (charts.trendsFemaleAge) charts.trendsFemaleAge.destroy();

            const datasets = AGE_GROUPS.map((group, idx) => ({
                label: group,
                data: getAggregatedMonthlyData(studioFilter, (s) => s.ageGroups[group].female),
                borderColor: AGE_GROUP_COLORS[idx],
                fill: false,
                tension: 0.4
            }));

            charts.trendsFemaleAge = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ==================== TREND ANALYSIS ====================
        function analyzeTrendAlerts() {
            const studioFilter = document.getElementById('trends-studio-filter').value;
            const containerPositive = document.getElementById('trend-alerts-positive');
            const containerNegative = document.getElementById('trend-alerts-negative');
            containerPositive.innerHTML = '';
            containerNegative.innerHTML = '';

            if (monthlyTrends.length < 3) {
                const msg = '<p class="text-gray-500 text-center py-4">Mindestens 3 Monate Daten n√∂tig.</p>';
                containerPositive.innerHTML = msg;
                containerNegative.innerHTML = msg;
                return;
            }
            
            const recentTrends = monthlyTrends.slice(-3);
            const t1 = recentTrends[0];
            const t2 = recentTrends[1];
            const t3 = recentTrends[2];

            const alertsPositive = [];
            const alertsNegative = [];

            const studios = studioFilter === 'all' ? Object.values(MAIN_DOORS) : [studioFilter];
            const filterName = studioFilter === 'all' ? 'Alle Studios' : studioFilter;

            const extract = (monthData, studio, extractor) => {
                if (studio === 'Alle Studios') {
                    return Object.values(monthData.studios).reduce((sum, s) => sum + extractor(s), 0);
                }
                return monthData.studios[studio] ? extractor(monthData.studios[studio]) : 0;
            };

            const v1_total = extract(t1, filterName, s => s.total);
            const v3_total = extract(t3, filterName, s => s.total);
            const totalTrendEl = document.getElementById('trends-total-percent');
            
            if (v1_total > 0) {
                const percent = ((v3_total - v1_total) / v1_total) * 100;
                const color = percent >= 0 ? 'text-green-600' : 'text-red-600';
                const sign = percent >= 0 ? '+' : '';
                totalTrendEl.innerHTML = `Gesamttrend (letzte 3 Mon.): <span class="${color} font-bold">${sign}${percent.toFixed(1)}%</span>`;
            } else {
                totalTrendEl.textContent = 'Gesamttrend (letzte 3 Mon.): -';
            }
            
            if (studioFilter !== 'all') {
                studios.forEach(studio => {
                    const v1 = extract(t1, studio, s => s.total);
                    const v2 = extract(t2, studio, s => s.total);
                    const v3 = extract(t3, studio, s => s.total);

                    if (v1 > v2 && v2 > v3 && v1 > 30) {
                        const decline = ((v1 - v3) / v1 * 100).toFixed(0);
                        alertsNegative.push({
                            icon: 'üìâ',
                            title: `${studio}: Steter R√ºckgang`,
                            description: `-${decline}% √ºber 3 Monate (${v1} auf ${v3} √ñffnungen)`
                        });
                    }
                    if (v1 < v2 && v2 < v3 && v1 > 10) {
                        const growth = ((v3 - v1) / v1 * 100).toFixed(0);
                        alertsPositive.push({
                            icon: 'üìà',
                            title: `${studio}: Starkes Wachstum`,
                            description: `+${growth}% √ºber 3 Monate (${v1} auf ${v3} √ñffnungen)`
                        });
                    }
                });
            }

            AGE_GROUPS.forEach(group => {
                const v1_male = extract(t1, filterName, s => s.ageGroups[group].male);
                const v3_male = extract(t3, filterName, s => s.ageGroups[group].male);
                
                if (v1_male > 10 && v3_male < v1_male * 0.7) {
                    alertsNegative.push({
                        icon: 'üë®',
                        title: `R√ºckgang M√§nner ${group}`,
                        description: `R√ºckgang von ${v1_male} auf ${v3_male} √ñffnungen`
                    });
                }
                if (v1_male > 5 && v3_male > v1_male * 1.5) {
                    alertsPositive.push({
                        icon: 'üë®',
                        title: `Wachstum M√§nner ${group}`,
                        description: `Anstieg von ${v1_male} auf ${v3_male} √ñffnungen`
                    });
                }

                const v1_female = extract(t1, filterName, s => s.ageGroups[group].female);
                const v3_female = extract(t3, filterName, s => s.ageGroups[group].female);
                
                if (v1_female > 10 && v3_female < v1_female * 0.7) {
                    alertsNegative.push({
                        icon: 'üë©',
                        title: `R√ºckgang Frauen ${group}`,
                        description: `R√ºckgang von ${v1_female} auf ${v3_female} √ñffnungen`
                    });
                }
                if (v1_female > 5 && v3_female > v1_female * 1.5) {
                    alertsPositive.push({
                        icon: 'üë©',
                        title: `Wachstum Frauen ${group}`,
                        description: `Anstieg von ${v1_female} auf ${v3_female} √ñffnungen`
                    });
                }
            });

            const renderAlert = (alert) => `
                <div class="p-3 rounded-lg bg-white shadow-sm border">
                    <div class="flex items-start">
                        <div class="text-2xl mr-3">${alert.icon}</div>
                        <div class="flex-1">
                            <h5 class="font-bold text-sm">${alert.title}</h5>
                            <p class="text-xs text-gray-700">${alert.description}</p>
                        </div>
                    </div>
                </div>
            `;

            if (alertsPositive.length === 0) {
                containerPositive.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Kein signifikantes Wachstum erkannt.</p>';
            } else {
                containerPositive.innerHTML = alertsPositive.map(renderAlert).join('');
            }
            
            if (alertsNegative.length === 0) {
                containerNegative.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Keine signifikanten R√ºckg√§nge erkannt.</p>';
            } else {
                containerNegative.innerHTML = alertsNegative.map(renderAlert).join('');
            }
        }
        
        // ==================== MEMBER ANALYSIS ====================
        function setupMemberFilter() {
            const filterSelect = document.getElementById('member-studio-filter');
            if (!filterSelect) return; 
            
            const { studioStats } = analysisResults;
            if (!studioStats) return;

            const currentVal = filterSelect.value; 
            
            filterSelect.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });
            
            filterSelect.value = currentVal; 
            
            if (!filterSelect.dataset.listener) {
                filterSelect.addEventListener('change', renderMemberAnalysis);
                filterSelect.dataset.listener = 'true';
            }
        }
        
        function renderMemberAnalysis() {
            const studioFilter = document.getElementById('member-studio-filter').value;
            const topList = document.getElementById('top-members-list');
            topList.innerHTML = '';

            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const memberCounts = {};
            checkins.forEach(c => {
                memberCounts[c.cusNumber] = (memberCounts[c.cusNumber] || 0) + 1;
            });

            const sortedMembers = Object.entries(memberCounts).sort((a, b) => b[1] - a[1]);

            if (sortedMembers.length === 0) {
                topList.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">Keine Daten f√ºr diese Auswahl.</p>';
                return;
            }

            sortedMembers.slice(0, 20).forEach(([cusNumber, count]) => {
                const item = document.createElement('div');
                item.className = 'member-list-item text-sm';
                item.innerHTML = `
                    <span class="font-medium text-gray-800">${cusNumber}</span>
                    <span class="font-bold text-red-600">${count} Check-ins</span>
                `;
                topList.appendChild(item);
            });
        }

        // ==================== RENDER RESULTS ====================
        function renderResults() {
            const { checkins, studioStats, dailyStats, startDate, endDate } = analysisResults;

            document.getElementById('period-display').textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            // Check if endDate is valid before formatting
            if(endDate instanceof Date && !isNaN(endDate)) {
                document.getElementById('last-event-display').textContent = `${formatDateTime(endDate)}`;
            } else {
                 document.getElementById('last-event-display').textContent = '-'; // Handle invalid date
            }


            document.getElementById('stat-total-checkins').textContent = checkins.length.toLocaleString('de-DE');
            
            const daysCount = Object.keys(dailyStats).length;
            const avgDaily = (daysCount > 0) ? (checkins.length / daysCount).toFixed(1) : "0.0";
            document.getElementById('stat-avg-daily').textContent = avgDaily.replace('.', ',');

            const topStudio = Object.entries(studioStats).sort((a, b) => b[1] - a[1])[0];
            if (topStudio) {
                document.getElementById('stat-top-studio').textContent = topStudio[0];
                const percent = ((topStudio[1] / checkins.length) * 100).toFixed(0);
                document.getElementById('stat-top-studio-percent').textContent = `${percent}% der Check-ins`;
            }

            renderStudioChart();
            renderDailyChart();
            renderDemographicsCharts();
            renderStudioComparisonTable();
            renderUtilizationCharts();
            renderHeatmapTable();
            setupMemberFilter(); 
            renderMemberAnalysis(); 
            renderInsights();
        }

        // ==================== BASIC CHARTS ====================
        
        const datalabelsInside = {
            anchor: 'end',
            align: 'end',
            offset: -4,
            color: 'white',
            font: { weight: 'bold' }
        };
        const datalabelsOutside = {
            anchor: 'end',
            align: 'top',
            color: '#1F2937',
            font: { weight: 'bold' }
        };
        const getDatalabelConfig = (ctx) => {
            const value = ctx.dataset.data[ctx.dataIndex];
            const max = ctx.chart.scales.y.max;
            // Check if max is valid and greater than 0 to prevent division by zero or NaN
            if (max && max > 0 && typeof value === 'number') {
                 return (value / max > 0.9) ? datalabelsInside : datalabelsOutside;
            }
             return datalabelsOutside; // Default if max is invalid or value is not a number
        };


        function renderStudioChart() {
            const { studioStats } = analysisResults;
            const ctx = document.getElementById('chart-studios');
            
            if (charts.studios) charts.studios.destroy();
            
            const sorted = Object.entries(studioStats).sort((a, b) => b[1] - a[1]);
            
            charts.studios = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'Check-ins',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig // FIX: Pass function directly
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grace: '10%' 
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDailyChart() {
            const { dailyStats } = analysisResults;
            const ctx = document.getElementById('chart-daily');
            
            if (charts.daily) charts.daily.destroy();
            
            const sorted = Object.entries(dailyStats).sort((a, b) => a[0].localeCompare(b[0]));
            
            charts.daily = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d[0]);
                        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Check-ins pro Tag',
                        data: sorted.map(d => d[1]),
                        borderColor: '#DC2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderDemographicsCharts() {
            const { studioStats } = analysisResults;
            const filterSelect = document.getElementById('demo-studio-filter');
            filterSelect.innerHTML = '<option value="all">Alle Studios</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });

            updateDemographicsCharts('all');

            filterSelect.addEventListener('change', (e) => {
                updateDemographicsCharts(e.target.value);
            });
        }

        // v5.6: Unbekannt entfernt
        function updateDemographicsCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const genderCounts = { 'M√§nnlich': 0, 'Weiblich': 0 }; // Unknown removed
            checkins.forEach(c => {
                if (c.gender === 'M√§nnlich' || c.gender === 'Weiblich') {
                   genderCounts[c.gender]++; 
                }
            });
            
            const genderCtx = document.getElementById('chart-gender');
            if (charts.gender) charts.gender.destroy();
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['M√§nner', 'Frauen'], // Unknown removed
                    datasets: [{
                        data: [genderCounts['M√§nnlich'], genderCounts['Weiblich']],
                        backgroundColor: ['#1F2937', '#DC2626'] // Unknown color removed
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                if (sum === 0) return '0%';
                                const percent = ((value / sum) * 100).toFixed(0);
                                return percent > 5 ? `${percent}%` : ''; 
                            },
                            color: '#fff',
                            font: { weight: 'bold', size: 16 }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            const ageCounts = {};
            AGE_GROUPS.forEach(g => ageCounts[g] = 0);
            
            checkins.forEach(c => {
                if (c.ageGroup) {
                    ageCounts[c.ageGroup]++;
                }
            });

            const ageCtx = document.getElementById('chart-age');
            if (charts.age) charts.age.destroy();
            
            charts.age = new Chart(ageCtx, { // FIX: Use ageCtx here
                type: 'bar',
                data: {
                    labels: Object.keys(ageCounts),
                    datasets: [{
                        label: 'Check-ins',
                        data: Object.values(ageCounts),
                        backgroundColor: '#6B7280'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig // FIX: Pass function directly
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grace: '10%'
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            const ageGenderData = {};
            AGE_GROUPS.forEach(g => {
                ageGenderData[g] = { male: 0, female: 0 };
            });

            checkins.forEach(c => {
                if (!c.ageGroup) return;
                if (c.gender === 'M√§nnlich') ageGenderData[c.ageGroup].male++;
                else if (c.gender === 'Weiblich') ageGenderData[c.ageGroup].female++;
            });

            const ageGenderCtx = document.getElementById('chart-age-gender');
            if (charts.ageGender) charts.ageGender.destroy();

            charts.ageGender = new Chart(ageGenderCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ageGenderData),
                    datasets: [
                        {
                            label: 'M√§nner',
                            data: Object.values(ageGenderData).map(d => d.male),
                            backgroundColor: '#1F2937'
                        },
                        {
                            label: 'Frauen',
                            data: Object.values(ageGenderData).map(d => d.female),
                            backgroundColor: '#DC2626'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { // FIX: Use standard config, function might be overkill here
                            anchor: 'end',
                            align: 'top',
                            color: '#1F2937',
                            font: { weight: 'bold', size: 10 }
                        }
                    },
                    scales: {
                        x: { stacked: false },
                        y: { stacked: false, beginAtZero: true, grace: '10%' }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // v5.6: Unbekannt entfernt / FIX for ReferenceError
        function renderStudioComparisonTable() {
            const { checkins, studioStats } = analysisResults;
            const tbody = document.getElementById('studio-comparison-table');
            tbody.innerHTML = '';

            const studios = Object.keys(studioStats);
            
            studios.forEach(studio => {
                const studioCheckins = checkins.filter(c => c.studio === studio);
                const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                // FIX: 'total' ist jetzt nur die Summe von M√§nnern und Frauen
                const total = males + females; 
                
                const ages = studioCheckins.map(c => c.age).filter(a => a !== null);
                const avgAge = ages.length > 0 ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length) : '-';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 font-medium">${studio}</td>
                    <td class="px-4 py-3">${studioStats[studio].toLocaleString('de-DE')}</td>
                    <td class="px-4 py-3">${total > 0 ? ((males / total) * 100).toFixed(0) : 0}%</td>
                    <td class="px-4 py-3">${total > 0 ? ((females / total) * 100).toFixed(0) : 0}%</td>
                    <td class="px-4 py-3">${avgAge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderUtilizationCharts() {
            const { studioStats } = analysisResults;
            const filterSelect = document.getElementById('util-studio-filter');
            filterSelect.innerHTML = '<option value="all">Alle Studios (Gesamt)</option>';
            Object.keys(studioStats).forEach(studio => {
                const option = document.createElement('option');
                option.value = studio;
                option.textContent = studio;
                filterSelect.appendChild(option);
            });

            updateUtilizationCharts('all');

            filterSelect.addEventListener('change', (e) => {
                updateUtilizationCharts(e.target.value);
                renderHeatmapTable(e.target.value);
            });
        }

        function updateUtilizationCharts(studioFilter) {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const weekdayTotals = {};
            const weekdayCounts = {};
            
            checkins.forEach(c => {
                const day = c.day;
                weekdayTotals[day] = (weekdayTotals[day] || 0) + 1;
            });

            const uniqueDates = {};
            checkins.forEach(c => {
                const day = c.day;
                if (!uniqueDates[day]) uniqueDates[day] = new Set();
                uniqueDates[day].add(c.dateKey);
            });

            Object.keys(uniqueDates).forEach(day => {
                weekdayCounts[day] = uniqueDates[day].size;
            });

            const dayNames = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const avgData = [0, 1, 2, 3, 4, 5, 6].map(d => {
                const total = weekdayTotals[d] || 0;
                const count = weekdayCounts[d] || 1;
                return Math.round(total / count);
            });

            const ctx = document.getElementById('chart-weekday-util');
            if (charts.weekdayUtil) charts.weekdayUtil.destroy();

            charts.weekdayUtil = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: '√ò Check-ins',
                        data: avgData,
                        backgroundColor: '#DC2626'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: getDatalabelConfig // FIX: Pass function directly
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grace: '10%'
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderHeatmapTable(studioFilter = 'all') {
            const checkins = studioFilter === 'all' 
                ? analysisResults.checkins 
                : analysisResults.checkins.filter(c => c.studio === studioFilter);

            const hourlyStats = {};
            checkins.forEach(c => {
                const key = `${c.day}-${c.hour}`;
                hourlyStats[key] = (hourlyStats[key] || 0) + 1;
            });

            const table = document.getElementById('heatmap-table');
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

            const maxCount = Math.max(...Object.values(hourlyStats), 1);

            let html = '<thead><tr class="heatmap-header"><th class="heatmap-cell">Uhrzeit</th>';
            dayNames.forEach(day => {
                html += `<th class="heatmap-cell">${day}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let hour = 6; hour <= 23; hour++) {
                html += `<tr><td class="heatmap-cell font-bold">${hour}:00</td>`;
                for (let day = 0; day < 7; day++) {
                    const key = `${day}-${hour}`;
                    const count = hourlyStats[key] || 0;
                    const intensity = count > 0 ? (count / maxCount) : 0;
                    const bgColor = count === 0 ? '#f9fafb' : `rgba(220, 38, 38, ${0.1 + intensity * 0.9})`;
                    const textColor = intensity > 0.6 ? '#fff' : '#1F2937';
                    html += `<td class="heatmap-cell" style="background-color: ${bgColor}; color: ${textColor};">${count > 0 ? count : '-'}</td>`;
                }
                html += '</tr>';
            }

            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderInsights() {
            const { checkins, studioStats } = analysisResults;
            const container = document.getElementById('insights-container');
            container.innerHTML = '';

            const insights = [];

            const totalMales = checkins.filter(c => c.gender === 'M√§nnlich').length;
            const totalFemales = checkins.filter(c => c.gender === 'Weiblich').length;
            
            if (totalMales + totalFemales > 0) {
                const avgFemalePercent = (totalFemales / (totalMales + totalFemales)) * 100;

                Object.keys(studioStats).forEach(studio => {
                    const studioCheckins = checkins.filter(c => c.studio === studio);
                    const males = studioCheckins.filter(c => c.gender === 'M√§nnlich').length;
                    const females = studioCheckins.filter(c => c.gender === 'Weiblich').length;
                    const total = males + females;
                    
                    if (total > 0) {
                        const femalePercent = (females / total) * 100;
                        if (Math.abs(femalePercent - avgFemalePercent) > 8) {
                            const diff = femalePercent - avgFemalePercent;
                            insights.push({
                                type: diff < 0 ? 'warning' : 'info',
                                icon: 'üë•',
                                title: `${studio}: ${diff < 0 ? 'Wenig' : 'Viele'} Frauen`,
                                description: `${femalePercent.toFixed(0)}% Frauen (Schnitt: ${avgFemalePercent.toFixed(0)}%)`,
                                action: diff < 0 ? 'Gezielte Marketing-Kampagne f√ºr Frauen empfohlen' : 'Gute Geschlechterbalance beibehalten'
                            });
                        }
                    }
                });
            }

            const { hourlyStats } = analysisResults;
            const hourTotals = {};
            Object.entries(hourlyStats).forEach(([key, count]) => {
                const hour = key.split('-')[1];
                hourTotals[hour] = (hourTotals[hour] || 0) + count;
            });
            const peakHour = Object.entries(hourTotals).sort((a, b) => b[1] - a[1])[0];
            if (peakHour) {
                insights.push({
                    type: 'success',
                    icon: '‚è∞',
                    title: `Peak Hour: ${peakHour[0]}:00 Uhr`,
                    description: `St√§rkste Stunde im gesamten Zeitraum`,
                    action: 'Personal-Planung entsprechend anpassen'
                });
            }

            const ageGroupCounts = {};
            AGE_GROUPS.forEach(g => ageGroupCounts[g] = 0);
            checkins.forEach(c => {
                if(c.ageGroup) ageGroupCounts[c.ageGroup]++;
            });
            
            const topAgeGroup = Object.entries(ageGroupCounts).sort((a, b) => b[1] - a[1])[0];
            if (topAgeGroup && checkins.length > 0) {
                 insights.push({
                    type: 'info',
                    icon: 'üéÇ',
                    title: `St√§rkste Altersgruppe: ${topAgeGroup[0]}`,
                    description: `Diese Gruppe macht ${((topAgeGroup[1]/checkins.length)*100).toFixed(0)}% der Check-ins aus`,
                    action: 'Angebote f√ºr diese Zielgruppe pr√ºfen/st√§rken'
                });
            }

            const typeStyles = {
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-blue-50 border-blue-200',
                success: 'bg-green-50 border-green-200'
            };

            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-2 ${typeStyles[insight.type]}`;
                div.innerHTML = `
                    <div class="flex items-start">
                        <div class="text-3xl mr-4">${insight.icon}</div>
                        <div class="flex-1">
                            <h4 class="font-bold text-lg mb-1">${insight.title}</h4>
                            <p class="text-sm text-gray-700 mb-2">${insight.description}</p>
                            <p class="text-xs text-gray-600">üìç <strong>Empfehlung:</strong> ${insight.action}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Keine besonderen Auff√§lligkeiten gefunden. Alle Metriken im normalen Bereich! ‚úÖ</p>';
            }
        }

        // ==================== TAB SWITCHING ====================
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.dataset.tab;
                    
                    tabButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${targetTab}`).classList.add('active');
                });
            });
        }

        // ==================== EXPORT & SYNC ====================
        function setupExport() {
            document.getElementById('export-btn').addEventListener('click', () => {
                const data = {
                    lastLoadedTimestamp: lastLoadedTimestamp,
                    allCheckins: allCheckins
                };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sams-gym-analysis-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            });

            document.getElementById('sync-github-btn').addEventListener('click', () => {
                document.getElementById('github-modal').classList.add('active');
            });
            
            setupGitHubModal();
        }

        // ==================== GITHUB SYNC ====================
        function setupGitHubModal() {
            const savedConfig = localStorage.getItem('githubConfig');
            if (savedConfig) {
                githubConfig = JSON.parse(savedConfig);
                document.getElementById('github-owner').value = githubConfig.owner;
                document.getElementById('github-repo').value = githubConfig.repo;
            }
            githubConfig.token = null;
            document.getElementById('github-token').value = '';

            updateDataStatus('Nicht geladen');

            document.getElementById('github-load-btn').addEventListener('click', loadFromGitHub);
            document.getElementById('github-save-btn').addEventListener('click', saveToGitHub);
        }
        
        // v5.7: .trim() hinzugef√ºgt, um Leerzeichen-Fehler zu vermeiden
        function updateGitHubConfig() {
            githubConfig.owner = document.getElementById('github-owner').value.trim();
            githubConfig.repo = document.getElementById('github-repo').value.trim();
            githubConfig.token = document.getElementById('github-token').value.trim();
            
            localStorage.setItem('githubConfig', JSON.stringify({
                owner: githubConfig.owner,
                repo: githubConfig.repo
            }));
        }

        function setGitHubLoading(isLoading, text = 'Aktion wird ausgef√ºhrt...') {
            document.getElementById('github-loading').classList.toggle('hidden', !isLoading);
            document.getElementById('github-loading-text').textContent = text;
            document.getElementById('github-load-btn').disabled = isLoading;
            document.getElementById('github-save-btn').disabled = isLoading;
            document.getElementById('github-error').classList.add('hidden');
        }

        function showGitHubError(message) {
            setGitHubLoading(false);
            const errorEl = document.getElementById('github-error');
            errorEl.textContent = `Fehler: ${message}`;
            errorEl.classList.remove('hidden');
        }

        function updateDataStatus(status) {
            const statusEl = document.getElementById('github-status');
            statusEl.value = status;
            statusEl.classList.remove('text-green-600', 'text-yellow-600', 'font-bold');
            
            if (status.startsWith('Geladen')) {
                statusEl.classList.add('text-green-600', 'font-bold');
            } else if (status.startsWith('Lokal')) {
                statusEl.classList.add('text-yellow-600', 'font-bold');
            }
        }

        async function makeGitHubRequest(url, method, body = null) {
            updateGitHubConfig();
            const { token } = githubConfig;
            if (!token) {
                showGitHubError('Kein GitHub Token angegeben.');
                return null;
            }

            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `${response.status} ${response.statusText}`);
                }
                
                if (response.status === 200 || response.status === 201) {
                    return { success: true, data: await response.json() };
                }
                if (response.status === 204) {
                    return { success: true, data: {} };
                }
                return { success: true, data: await response.json() };

            } catch (err) {
                console.error('GitHub API Error:', err);
                showGitHubError(err.message);
                return null;
            }
        }

        async function loadFromGitHub() {
            setGitHubLoading(true, 'Lade Daten von GitHub...');
            const { owner, repo, filePath } = githubConfig;
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}?t=${new Date().getTime()}`; // Cache bust

            const result = await makeGitHubRequest(url, 'GET');
            if (result && result.data.type === 'file' && result.data.encoding === 'base64') {
                githubDataSha = result.data.sha;
                
                const content = atob(result.data.content);
                const data = JSON.parse(content);

                allCheckins = (data.allCheckins || []).map(c => ({
                    ...c,
                    timestamp: new Date(c.timestamp)
                }));
                lastLoadedTimestamp = data.lastLoadedTimestamp;

                allCheckins.sort((a, b) => a.timestamp - b.timestamp);
                
                setGitHubLoading(false);
                updateDataStatus(`Geladen von GitHub (${allCheckins.length} Eintr√§ge)`);
                closeModal('github-modal');
                
                document.getElementById('initial-load-section').classList.add('hidden');
                document.getElementById('upload-section').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('time-filter-section').classList.remove('hidden');
                document.getElementById('export-btn').classList.remove('hidden');
                document.getElementById('add-data-btn').classList.remove('hidden');

                generateMonthlyTrends();
                filteredCheckins = [...allCheckins];
                processAnalysis();
                setupTimeFilters();
                setupTrendsFilters();
                renderTrendCharts('all');
                analyzeTrendAlerts();

            } else {
                showGitHubError('Datei nicht gefunden oder ung√ºltiges Format. (Pfad: ' + filePath + ')');
                githubDataSha = null;
            }
        }

        async function saveToGitHub() {
            if (allCheckins.length === 0) {
                showGitHubError('Keine Daten zum Speichern vorhanden.');
                return;
            }
            
            setGitHubLoading(true, 'Speichere Daten auf GitHub...');
            const { owner, repo, filePath } = githubConfig;
            
            const dataToSave = {
                lastLoadedTimestamp: lastLoadedTimestamp,
                allCheckins: allCheckins
            };
            
            // UTF-8 f√§higes Base64 encoding
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(dataToSave))));
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

            const body = {
                message: `SAMS GYM Analytics Update - ${new Date().toISOString()}`,
                content: content,
                sha: githubDataSha
            };

            const result = await makeGitHubRequest(url, 'PUT', body);
            
            if (result && result.success) {
                githubDataSha = result.data.content.sha;
                setGitHubLoading(false);
                updateDataStatus(`Gespeichert! (${allCheckins.length} Eintr√§ge)`);
                closeModal('github-modal');
            } else {
                // Fehler wird schon im makeGitHubRequest angezeigt
            }
        }


        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            setupInitialLoad();
            setupFileHandlers();
            setupTabs();
            setupExport();
        });
    </script>
</body>
</html>

